[{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072","pull_request_review_id":3537125384,"id":2586763072,"node_id":"PRRC_kwDOPKYCYs6aLt9A","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe database connection is not closed safely. If an error occurs after the connection is opened but before `conn.close()` is called, the connection will leak. This can exhaust database connection resources over time. This issue is present in all database-accessing functions in this file (`init_history_db`, `get_spam_count`, etc.) and should be fixed in all of them.\n\nTo ensure the connection is always closed, you should use a `try...finally` block.\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:03Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086","pull_request_review_id":3537125384,"id":2586763086,"node_id":"PRRC_kwDOPKYCYs6aLt9O","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not closed in a `finally` block. If an exception occurs in `whoistel.get_full_info()`, the `conn.close()` line will not be reached, causing a connection leak. This can lead to resource exhaustion over time.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092","pull_request_review_id":3537125384,"id":2586763092,"node_id":"PRRC_kwDOPKYCYs6aLt9U","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is intended for development and is not suitable for a production environment. The built-in Flask development server is not designed for performance, stability, or security under production load. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI behind a reverse proxy like Nginx.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":66,"start_side":"RIGHT","line":null,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100","pull_request_review_id":3537125384,"id":2586763100,"node_id":"PRRC_kwDOPKYCYs6aLt9c","diff_hunk":"@@ -0,0 +1,34 @@\n+<!DOCTYPE html>\n+<html lang=\"fr\">\n+<head>\n+    <meta charset=\"UTF-8\">\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n+    <title>WhoisTel Web</title>\n+    <style>\n+        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }\n+        header { background: #333; color: #fff; padding: 10px; margin-bottom: 20px; }\n+        header nav a { color: #fff; margin-right: 15px; text-decoration: none; }\n+        .container { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n+        input[type=\"text\"], input[type=\"date\"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }\n+        input[type=\"submit\"], button { padding: 10px 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; }\n+        input[type=\"submit\"]:hover { background: #0056b3; }\n+        .result-box { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; }\n+        .spam-alert { color: red; font-weight: bold; }\n+        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n+        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }\n+        th { background: #eee; }\n+    </style>","path":"templates/layout.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nEmbedding CSS within a `<style>` tag in your HTML is generally discouraged for larger applications. Moving the CSS to an external file (e.g., `static/styles.css`) offers several benefits:\n\n- **Maintainability:** Separates styling from structure, making both easier to manage.\n- **Caching:** Allows browsers to cache the stylesheet, improving load times on subsequent page visits.\n- **Reusability:** The same stylesheet can be easily used across multiple pages.\n\nYou can link to an external stylesheet by placing it in the `static` folder and adding the following to your `<head>` section:\n```html\n<link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":7,"start_side":"RIGHT","line":null,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109","pull_request_review_id":3537125384,"id":2586763109,"node_id":"PRRC_kwDOPKYCYs6aLt9l","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box\" style=\"border-left: 5px solid red;\">","path":"templates/result.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing inline `style` attributes mixes presentation with your HTML structure, which can make the code harder to maintain. It's better to use CSS classes and define the styles in your stylesheet.\n\nFor example, you could define a class `.result-box-error` in your CSS:\n```css\n.result-box-error {\n    border-left: 5px solid red;\n}\n```\nAnd then apply it in your template:\n`<div class=\"result-box result-box-error\">`\n\nThis same principle applies to the other inline styles on lines 12 and 41.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":7,"side":"RIGHT","author_association":"NONE","original_position":7,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115","pull_request_review_id":3537125384,"id":2586763115,"node_id":"PRRC_kwDOPKYCYs6aLt9r","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis validation block is currently inactive because it's commented out and ends with `pass`. Relying on downstream functions to handle invalid input is not ideal. It's better to perform validation at the entry point of the request to fail fast and provide clear feedback. I recommend enabling and completing this validation to ensure only valid phone numbers are processed.\n\n```suggestion\n    if not number.isdigit() or len(number) != 10:\n        # Consider rendering an error page instead of a silent redirect.\n        return redirect(url_for('index'))\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123","pull_request_review_id":3537125384,"id":2586763123,"node_id":"PRRC_kwDOPKYCYs6aLt9z","diff_hunk":"@@ -99,6 +99,57 @@ def search_number(conn, tel):\n \n     return best_match\n \n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n+\n+    if not info:\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n+\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n+\n+    # Operator Info\n+    op_info = get_operator_info(conn, info['code_operateur'])\n+    if op_info:\n+        result['operator'] = op_info\n+    else:\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n+\n+    # Location Info\n+    if info['code_insee'] and info['code_insee'] != 0:\n+        commune_info = get_commune_info(conn, info['code_insee'])\n+        result['location'] = commune_info\n+\n+    # If Geo and no CodeInsee, give Region hint\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n+        region_map = {\n+            '01': 'Île-de-France',\n+            '02': 'Nord-Ouest',\n+            '03': 'Nord-Est',\n+            '04': 'Sud-Est',\n+            '05': 'Sud-Ouest'\n+        }\n+        region_code = tel[:2]\n+        if region_code in region_map:\n+            result['location'] = {'region': region_map[region_code]}","path":"whoistel.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `region_map` dictionary is duplicated here and also within the `print_result` function (lines 189-195). This code duplication can lead to maintenance issues, as a change in one place might be forgotten in the other. To follow the Don't Repeat Yourself (DRY) principle, this dictionary should be defined once as a module-level constant and referenced in both functions.","created_at":"2025-12-03T22:05:05Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":139,"start_side":"RIGHT","line":null,"original_line":149,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605","pull_request_review_id":3537453181,"id":2587050605,"node_id":"PRRC_kwDOPKYCYs6aM0Jt","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not guaranteed to be closed if `whoistel.get_full_info()` raises an exception. This can lead to resource leaks in the web application, which is more critical than in a short-lived script. Use a `try...finally` block to ensure `conn.close()` is always called.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610","pull_request_review_id":3537453181,"id":2587050610,"node_id":"PRRC_kwDOPKYCYs6aM0Jy","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current pattern of opening and closing database connections in each function is not robust. If an error occurs after the connection is opened but before `conn.close()` is called, the connection may not be closed, potentially leading to resource leaks. It's better to use a `try...finally` block to ensure `conn.close()` is always executed. This pattern should be applied to all database functions in this file (`init_history_db`, `add_report`, `get_spam_count`, `get_recent_reports`, `get_number_reports`).\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617","pull_request_review_id":3537453181,"id":2587050617,"node_id":"PRRC_kwDOPKYCYs6aM0J5","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis `if` block with a `pass` statement is dead code and serves no purpose. It should be removed to improve code clarity. If validation is intended here, it should be fully implemented.","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210","pull_request_review_id":3539470675,"id":2588642210,"node_id":"PRRC_kwDOPKYCYs6aS4ui","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block for database connection handling can be simplified by using the connection object as a context manager. This makes the code cleaner and ensures the connection is properly closed, and that transactions are committed or rolled back automatically. This same pattern can be applied to the other database functions in this file.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS reports (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                phone_number TEXT NOT NULL,\n                report_date TEXT,\n                is_spam INTEGER DEFAULT 0,\n                comment TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n```","created_at":"2025-12-04T11:19:03Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":33,"side":"RIGHT","author_association":"NONE","original_position":33,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224","pull_request_review_id":3539470675,"id":2588642224,"node_id":"PRRC_kwDOPKYCYs6aS4uw","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection handling can be simplified using a `with` statement. The connection object acts as a context manager, automatically handling commits and closing the connection.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":45,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235","pull_request_review_id":3539470675,"id":2588642235,"node_id":"PRRC_kwDOPKYCYs6aS4u7","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function can be simplified by using the database connection as a context manager. This avoids the manual `try...finally` block for closing the connection and makes the code more readable.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT COUNT(*) FROM reports\n            WHERE phone_number = ? AND is_spam = 1\n        ''', (phone_number,))\n        count = c.fetchone()[0]\n        return count\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":48,"start_side":"RIGHT","line":null,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":58,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243","pull_request_review_id":3539470675,"id":2588642243,"node_id":"PRRC_kwDOPKYCYs6aS4vD","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing a `with` statement for the database connection will make this function more concise and robust by automatically handling the connection closing.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            ORDER BY created_at DESC\n            LIMIT ?\n        ''', (limit,))\n        rows = c.fetchall()\n        # Convert rows to dicts\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":61,"start_side":"RIGHT","line":null,"original_line":73,"side":"RIGHT","author_association":"NONE","original_position":73,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250","pull_request_review_id":3539470675,"id":2588642250,"node_id":"PRRC_kwDOPKYCYs6aS4vK","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()\n+\n+def get_number_reports(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block can be replaced with a `with` statement for cleaner database connection management. This improves code readability and ensures the connection is always closed.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            WHERE phone_number = ?\n            ORDER BY created_at DESC\n        ''', (phone_number,))\n        rows = c.fetchall()\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":76,"start_side":"RIGHT","line":null,"original_line":87,"side":"RIGHT","author_association":"NONE","original_position":87,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263","pull_request_review_id":3539470675,"id":2588642263,"node_id":"PRRC_kwDOPKYCYs6aS4vX","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    conn = whoistel.setup_db_connection()\n+    try:\n+        result = whoistel.get_full_info(conn, number)\n+    finally:\n+        conn.close()","path":"webapp.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection from `whoistel.setup_db_connection()` can be managed more cleanly using a `with` statement. This ensures the connection is always closed, even if errors occur within the block, making the application more robust.\n\n```python\n    with whoistel.setup_db_connection() as conn:\n        result = whoistel.get_full_info(conn, number)\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":30,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412","pull_request_review_id":3539918426,"id":2588990412,"node_id":"PRRC_kwDOPKYCYs6aUNvM","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]","path":"webapp.py","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current phone number cleaning logic is not robust enough and can fail for common international formats like `+33 (0) ...`. The order of operations and handling of the optional `(0)` should be improved for more reliable parsing. Additionally, this logic is duplicated in `whoistel.py` and should ideally be consolidated into a shared utility function to improve maintainability.\n\n```suggestion\n    tel = raw_tel.replace('(', '').replace(')', '').replace(' ', '').replace('.', '').replace('-', '')\n    if tel.startswith('+330'):\n        tel = '0' + tel[4:]\n    elif tel.startswith('+33'):\n        tel = '0' + tel[3:]\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":23,"start_side":"RIGHT","line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427","pull_request_review_id":3539918426,"id":2588990427,"node_id":"PRRC_kwDOPKYCYs6aUNvb","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is not suitable for a production environment as it's a development server. It has security and performance limitations. For deployment, you should use a production-ready WSGI server like Gunicorn or uWSGI. It would be beneficial to add a note about this in the project's deployment documentation.","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":61,"side":"RIGHT","author_association":"NONE","original_position":61,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444","pull_request_review_id":3539918426,"id":2588990444,"node_id":"PRRC_kwDOPKYCYs6aUNvs","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : {{ result.operator.site }}</li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : {{ result.operator.mail }}</li>{% endif %}","path":"templates/result.html","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor better usability, the operator's website and email should be rendered as clickable links. This allows users to easily navigate to the operator's site or send an email.\n\n```\n                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":22,"start_side":"RIGHT","line":null,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190","pull_request_review_id":3539969783,"id":2589031190,"node_id":"PRRC_kwDOPKYCYs6aUXsW","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)","path":"webapp.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `number` variable taken from the URL is used directly without being cleaned. This can lead to inconsistent behavior. For example, a user accessing `/view/01.23.45.67.89` directly will have a different experience than if they searched for `01.23.45.67.89` from the home page (which cleans the number and redirects to `/view/0123456789`).\n\nTo ensure consistent behavior and use canonical URLs for phone numbers, I recommend cleaning the number and redirecting if the format is not standard. This improves user experience and predictability.\n\n```suggestion\ndef view_number(number):\n    cleaned_number = whoistel.clean_phone_number(number)\n    if cleaned_number != number:\n        return redirect(url_for('view_number', number=cleaned_number))\n\n    with closing(whoistel.setup_db_connection()) as conn:\n        result = whoistel.get_full_info(conn, cleaned_number)\n\n    # Get stats\n    spam_count = history_manager.get_spam_count(cleaned_number)\n\n    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":28,"start_side":"RIGHT","line":null,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":35,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215","pull_request_review_id":3539969783,"id":2589031215,"node_id":"PRRC_kwDOPKYCYs6aUXsv","diff_hunk":"@@ -0,0 +1,73 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime","path":"history_manager.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `datetime` module is imported but is not used in this file. It's good practice to remove unused imports to keep the code clean and avoid confusion.","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225","pull_request_review_id":3539969783,"id":2589031225,"node_id":"PRRC_kwDOPKYCYs6aUXs5","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing `app.run()` with Flask's built-in server is great for development, but it is not suitable for production use as it's not designed to be particularly efficient, stable, or secure. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI.\n\nIt would be beneficial to add a note about this to the project's `README.md` for future deployment.\n\nExample with Gunicorn:\n```sh\ngunicorn --bind 0.0.0.0:5000 webapp:app\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":59,"side":"RIGHT","author_association":"NONE","original_position":59,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060","pull_request_review_id":3540053018,"id":2589096060,"node_id":"PRRC_kwDOPKYCYs6aUnh8","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe log message \"Creating history database {DB_FILE}...\" is slightly misleading. The `sqlite3.connect(DB_FILE)` call itself creates the file if it doesn't exist. The `if not os.path.exists(DB_FILE)` check is redundant for file creation, and the log message implies this `if` block is responsible for creating the file, which isn't entirely accurate. It would be clearer to log *after* the table creation, or rephrase the message to indicate that the database *schema* is being initialized.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":15,"start_side":"RIGHT","line":null,"original_line":16,"side":"RIGHT","author_association":"NONE","original_position":16,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072","pull_request_review_id":3540053018,"id":2589096072,"node_id":"PRRC_kwDOPKYCYs6aUniI","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `report_date` column is defined as `TEXT`. While SQLite is flexible, using a `DATE` or `DATETIME` affinity for date columns is generally recommended. This allows for better data integrity, easier date-based queries, and clearer intent. You would then convert Python `datetime` objects to and from ISO 8601 strings when interacting with the database.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":24,"side":"RIGHT","author_association":"NONE","original_position":24,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955","pull_request_review_id":3540093876,"id":2589127955,"node_id":"PRRC_kwDOPKYCYs6aUvUT","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')","path":"webapp.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe phone number received from the form is not cleaned before being stored in the database. A user could submit a 'dirty' number (e.g., with dots or spaces) via a tampered POST request. This would store the uncleaned number in the history database, leading to data inconsistencies. When `get_spam_count` is later called with a cleaned number, it won't find the report, resulting in an incorrect spam count. To ensure data integrity, you should always clean the phone number upon receiving it from user input.\n\n```suggestion\n    number = whoistel.clean_phone_number(request.form.get('number'))\n```","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002","pull_request_review_id":3540093876,"id":2589128002,"node_id":"PRRC_kwDOPKYCYs6aUvVC","diff_hunk":"@@ -0,0 +1,34 @@\n+import pytest\n+import os\n+import subprocess\n+\n+def get_project_root():\n+    \"\"\"Returns the root directory of the project.\"\"\"\n+    return os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))\n+\n+@pytest.fixture(scope=\"session\", autouse=True)\n+def setup_database():\n+    \"\"\"\n+    Ensures the database is generated before tests run.\n+    \"\"\"\n+    root_dir = get_project_root()\n+    update_script_path = os.path.join(root_dir, \"updatearcep.sh\")\n+    db_path = os.path.join(root_dir, \"whoistel.sqlite3\")\n+\n+    if not os.path.exists(db_path):\n+        print(\"\\nDatabase not found. Running updatearcep.sh to generate it...\")\n+        # Check if we can run it (permissions)\n+        subprocess.run([\"chmod\", \"+x\", update_script_path], check=True, cwd=root_dir)\n+        try:\n+            subprocess.run(\n+                [\"./updatearcep.sh\"], # Executing directly since we chmodded it\n+                capture_output=True, text=True, check=True, cwd=root_dir\n+            )\n+        except subprocess.CalledProcessError as e:\n+            # Print stderr for debugging\n+            print(f\"Update Script Output: {e.stdout}\")\n+            print(f\"Update Script Error: {e.stderr}\")\n+            pytest.fail(f\"Database generation failed: {e.stderr}\")\n+\n+    if not os.path.exists(db_path):\n+         pytest.fail(\"Database whoistel.sqlite3 could not be generated.\")","path":"tests/conftest.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis check for `db_path` existence is redundant. The `if` block starting at line 18 already handles the case where the database doesn't exist. If the database generation script succeeds, the file will exist. If it fails, `pytest.fail()` is called on line 31, making this code unreachable. You can safely remove these two lines to improve clarity.","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018","pull_request_review_id":3540093876,"id":2589128018,"node_id":"PRRC_kwDOPKYCYs6aUvVS","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `README.md` file correctly instructs users to run `python3 webapp.py` for development. For a better development experience, the Flask development server should be run with `debug=True`. This enables the interactive debugger on error pages and the automatic reloader when code changes are saved. The current `debug=False` is safer but less convenient for development.\n\n```suggestion\n    app.run(debug=True, host='0.0.0.0', port=5000)\n```","created_at":"2025-12-04T13:39:26Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":63,"side":"RIGHT","author_association":"NONE","original_position":63,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486","pull_request_review_id":3540174717,"id":2589191486,"node_id":"PRRC_kwDOPKYCYs6aU-0-","diff_hunk":"@@ -0,0 +1,71 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+\n+def get_spam_count(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+\n+def get_recent_reports(limit=50):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+\n+def get_number_reports(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]","path":"history_manager.py","commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function `get_number_reports` is defined but does not appear to be used anywhere in the application. To improve maintainability and reduce clutter, it's best to remove unused code.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":62,"start_side":"RIGHT","line":null,"original_line":71,"side":"RIGHT","author_association":"NONE","original_position":71,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491","pull_request_review_id":3540174717,"id":2589191491,"node_id":"PRRC_kwDOPKYCYs6aU-1D","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis endpoint is vulnerable to Cross-Site Request Forgery (CSRF). A malicious website could create a form that posts to this URL, causing a user to unknowingly submit a spam report. While the impact here is relatively low, it's a security best practice to protect all state-changing endpoints. You can implement CSRF protection using a library like `Flask-WTF`, which integrates well with Flask.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":85,"original_start_line":41,"start_side":"RIGHT","line":86,"original_line":42,"side":"RIGHT","author_association":"NONE","original_position":42,"position":86,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499","pull_request_review_id":3540174717,"id":2589191499,"node_id":"PRRC_kwDOPKYCYs6aU-1L","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current logic only checks if the `date` field is empty. It doesn't validate the format of a provided date. A user could submit a malformed string (e.g., 'invalid-date'), which would be saved to the database, potentially causing data integrity issues. It's better to validate the date format and fall back to today's date if it's invalid.\n\n```suggestion\n    try:\n        # This will raise an error for None, empty, or malformed strings\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        date = datetime.now().strftime('%Y-%m-%d')\n```","created_at":"2025-12-04T13:56:59Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":50,"start_side":"RIGHT","line":null,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827","pull_request_review_id":3540228605,"id":2589235827,"node_id":"PRRC_kwDOPKYCYs6aVJpz","diff_hunk":"@@ -0,0 +1,66 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}","path":"templates/result.html","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThere is a potential Cross-Site Scripting (XSS) vulnerability here. The `result.operator.site` and `result.operator.mail` values are taken from the database (which is populated from an external CSV) and placed directly into `href` attributes. If a malicious value like `javascript:alert('XSS')` is present in the database, it will be executed in the user's browser. While the data source is likely trusted, it's a security best practice to validate all external data. You should validate that the `site` is a valid HTTP/HTTPS URL and that `mail` is a valid email address in your Python backend (e.g., within the new `get_full_info` function in `whoistel.py`) before passing it to the template.","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235827","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235827"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":22,"original_start_line":22,"start_side":"RIGHT","line":23,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":23,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835","pull_request_review_id":3540228605,"id":2589235835,"node_id":"PRRC_kwDOPKYCYs6aVJp7","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing a hardcoded, predictable default for `SECRET_KEY` is a security risk. If the `SECRET_KEY` environment variable is not set, the application falls back to 'dev-key-change-me'. An attacker could use this default key to forge session cookies and CSRF tokens. It's much safer to remove the default fallback. The suggested change will cause the application to fail on startup if the `SECRET_KEY` is not set, which is a secure 'fail-fast' approach for production environments. For local development, you can set this variable in your shell or a `.flaskenv` file.\n\n```suggestion\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235835","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235835"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846","pull_request_review_id":3540228605,"id":2589235846,"node_id":"PRRC_kwDOPKYCYs6aVJqG","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+    try:\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except ValueError:\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe date validation logic can be simplified. You currently check if the date is empty and then separately use a `try-except` block. You can combine these checks into a single `try-except` block that handles both `None` values (which would raise a `TypeError`) and invalid date formats (which would raise a `ValueError`).\n\n```suggestion\n    try:\n        # This will fail for None, empty string, or bad format\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        date = datetime.now().strftime('%Y-%m-%d')\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235846","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235846"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":54,"start_side":"RIGHT","line":null,"original_line":59,"side":"RIGHT","author_association":"NONE","original_position":59,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857","pull_request_review_id":3540228605,"id":2589235857,"node_id":"PRRC_kwDOPKYCYs6aVJqR","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+    try:\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except ValueError:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor local development, it's standard practice to run the Flask development server with debug mode enabled (`debug=True`). This provides helpful features like an interactive debugger and automatic reloading on code changes. The README instructs users to run `python3 webapp.py` for local development, but with `debug=False`, the development experience is suboptimal. It's better to enable debug mode when the script is run directly. Using `host='127.0.0.1'` is also safer for a local development server.\n\n```suggestion\n    app.run(debug=True, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235857","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235857"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":72,"side":"RIGHT","author_association":"NONE","original_position":72,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859","pull_request_review_id":3540291608,"id":2589287859,"node_id":"PRRC_kwDOPKYCYs6aVWWz","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe application will crash with a `RuntimeError` if the `SECRET_KEY` environment variable is not set. While this fail-fast behavior is good, providing a more explicit and user-friendly error message would improve the developer experience when setting up the application.\n\n```suggestion\nSECRET_KEY = os.environ.get('SECRET_KEY')\nif not SECRET_KEY:\n    raise ValueError(\"SECRET_KEY is not set in the environment. It is required for CSRF protection.\")\napp.config['SECRET_KEY'] = SECRET_KEY\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287859","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287859"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":10,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":10,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872","pull_request_review_id":3540291608,"id":2589287872,"node_id":"PRRC_kwDOPKYCYs6aVWXA","diff_hunk":"@@ -32,12 +54,21 @@ def get_operator_info(conn, code_operateur):\n     cursor.execute(\"SELECT NomOperateur, TypeOperateur, MailOperateur, SiteOperateur FROM Operateurs WHERE CodeOperateur=?\", (code_operateur,))\n     row = cursor.fetchone()\n     if row:\n+        mail = row[2]\n+        site = row[3]\n+\n+        # Simple validation to prevent XSS\n+        if mail and '@' not in mail:\n+            mail = None","path":"whoistel.py","commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current email validation is too permissive and only checks for the presence of an `@` symbol. A malicious string containing HTML/script tags (e.g., `\"><script>alert(1)</script>@example.com`) would pass this check. While Jinja2's auto-escaping provides protection in the template, it's a security best practice to perform stricter validation at the data-handling layer. A simple way to improve this without new dependencies is to disallow characters commonly used in injection attacks, such as `<` and `>`.\n\n```suggestion\n        if mail and ('@' not in mail or '<' in mail or '>' in mail):\n            mail = None\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287872","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287872"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":61,"start_side":"RIGHT","line":null,"original_line":62,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881","pull_request_review_id":3540291608,"id":2589287881,"node_id":"PRRC_kwDOPKYCYs6aVWXJ","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"d8f3662b4549abca294655c2cf20167bbf8e12eb","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe UI labels the date field as optional, but the current logic saves today's date if the field is empty or the format is invalid. This can be misleading as it records a date even when none was provided. It's better to store `NULL` in the database if no valid date is provided, to truly make the field optional.\n\n```suggestion\n    try:\n        # This will fail for None, empty string, or bad format\n        if date:\n            datetime.strptime(date, '%Y-%m-%d')\n        else:\n            date = None\n    except (ValueError, TypeError):\n        date = None\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287881","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287881"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":53,"start_side":"RIGHT","line":null,"original_line":57,"side":"RIGHT","author_association":"NONE","original_position":57,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884","pull_request_review_id":3540291608,"id":2589287884,"node_id":"PRRC_kwDOPKYCYs6aVWXM","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nRunning the development server with `debug=False` is inconvenient for local development as it disables features like the interactive debugger and auto-reloader. Since the README already warns against using this server in production, it's safe and conventional to enable debug mode for the `if __name__ == '__main__':` block to improve the developer experience.\n\n```suggestion\n    app.run(debug=True, host='0.0.0.0', port=5000)\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287884","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287884"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":70,"side":"RIGHT","author_association":"NONE","original_position":70,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680","pull_request_review_id":3540602812,"id":2589539680,"node_id":"PRRC_kwDOPKYCYs6aWT1g","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"fb88918d7f0445c87dbc4e8abda5d0cb9578282a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe application should fail fast at startup if the `SECRET_KEY` is not configured. Relying on Flask-WTF to raise an exception later is not ideal for production environments. An explicit check provides a clearer error message and prevents the app from starting in an insecure or non-functional state.\n\n```suggestion\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\nif not app.config['SECRET_KEY']:\n    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n```","created_at":"2025-12-04T15:29:41Z","updated_at":"2025-12-04T15:29:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539680","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539680"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":10,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":10,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700","pull_request_review_id":3540602812,"id":2589539700,"node_id":"PRRC_kwDOPKYCYs6aWT10","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"d8f3662b4549abca294655c2cf20167bbf8e12eb","original_commit_id":"fb88918d7f0445c87dbc4e8abda5d0cb9578282a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current logic for handling the optional `date` field is incorrect. If the user leaves the date field empty, it should be stored as `NULL` in the database, but this code incorrectly defaults to the current date. This misrepresents the user's input for an optional field.\n\nThe logic should be to set the date to `None` if the input is empty or has an invalid format, so it gets stored as `NULL`.\n\nAdditionally, the test `test_report_empty_date` in `tests/test_webapp.py` should be updated to assert that an empty date input results in a `NULL`/empty date in the history view, which would have caught this bug.\n\n```suggestion\n    if not date:\n        date = None\n    else:\n        try:\n            datetime.strptime(date, '%Y-%m-%d')\n        except ValueError:\n            # Invalid format from user, store as NULL\n            date = None\n```","created_at":"2025-12-04T15:29:41Z","updated_at":"2025-12-04T15:29:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539700","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539700"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":53,"start_side":"RIGHT","line":null,"original_line":57,"side":"RIGHT","author_association":"NONE","original_position":57,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573","pull_request_review_id":3542546750,"id":2590932573,"node_id":"PRRC_kwDOPKYCYs6abn5d","diff_hunk":"@@ -0,0 +1,75 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)","path":"webapp.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe call to `whoistel.setup_db_connection()` is a critical risk in a web application. This function calls `sys.exit(1)` upon database connection errors, which will terminate the web server's worker process, potentially bringing down the entire application for all users. A web application should never exit; it should handle errors gracefully and return an appropriate HTTP error response (e.g., 500 Internal Server Error).\n\nI strongly recommend refactoring `whoistel.setup_db_connection()` to raise a custom exception instead of calling `sys.exit()`. The web app can then catch this exception (e.g., using an `@app.errorhandler`) to log the issue and return a user-friendly error page, ensuring the server remains operational.\n\n**Example Refactoring:**\n\nIn `whoistel.py`:\n```python\nclass DatabaseError(Exception):\n    pass\n\ndef setup_db_connection():\n    if not os.path.exists(DB_FILE):\n        msg = f\"Erreur: La base de données '{DB_FILE}' est absente.\"\n        raise DatabaseError(msg)\n    # ... similar change for other error conditions\n\n# In the CLI's main() function:\ntry:\n    conn = setup_db_connection()\n    # ...\nexcept DatabaseError:\n    sys.exit(1) # Preserves CLI behavior\n```\n\nIn `webapp.py`, you could then add an error handler:\n```python\n@app.errorhandler(whoistel.DatabaseError)\ndef handle_db_error(e):\n    app.logger.error(f\"Database error: {e}\")\n    return render_template('error.html', message=\"Database error occurred\"), 500\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932573","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932573"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":40,"side":"RIGHT","author_association":"NONE","original_position":40,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577","pull_request_review_id":3542546750,"id":2590932577,"node_id":"PRRC_kwDOPKYCYs6abn5h","diff_hunk":"@@ -0,0 +1,75 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    if not date:\n+        date = None\n+    else:\n+        try:\n+            datetime.strptime(date, '%Y-%m-%d')\n+        except ValueError:\n+            # Invalid format from user, store as NULL\n+            date = None","path":"webapp.py","commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe logic for validating the date string is correct but can be made more concise and Pythonic. The `if not date:` check is redundant, as `datetime.strptime` will raise a `ValueError` for an empty string, which is already handled in your `except` block. You can simplify this entire block into a single `try...except` statement.\n\n```python\n    try:\n        # This validates the date format. It will fail for invalid formats,\n        # empty strings, or if the date is not provided (None).\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        # If validation fails, store as NULL in the database.\n        date = None\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932577","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932577"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":55,"start_side":"RIGHT","line":null,"original_line":62,"side":"RIGHT","author_association":"NONE","original_position":62,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581","pull_request_review_id":3542546750,"id":2590932581,"node_id":"PRRC_kwDOPKYCYs6abn5l","diff_hunk":"@@ -12,6 +12,28 @@\n \n DB_FILE = 'whoistel.sqlite3'\n \n+REGION_MAP = {\n+    '01': 'Île-de-France',\n+    '02': 'Nord-Ouest',\n+    '03': 'Nord-Est',\n+    '04': 'Sud-Est',\n+    '05': 'Sud-Ouest'\n+}\n+\n+def clean_phone_number(raw_tel):\n+    if not raw_tel:\n+        return \"\"\n+    # Remove separators and parenthesis\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '').replace('(', '').replace(')', '')","path":"whoistel.py","commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing multiple chained `replace()` calls can be less efficient and harder to read than a single, declarative approach. You can achieve the same result more cleanly using a regular expression.\n\nDon't forget to add `import re` at the top of the file.\n\n```suggestion\n    tel = re.sub(r'[ .()-]', '', raw_tel)\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932581","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932581"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":16,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593","pull_request_review_id":3542546750,"id":2590932593,"node_id":"PRRC_kwDOPKYCYs6abn5x","diff_hunk":"@@ -147,8 +222,8 @@ def print_result(conn, tel, info):\n             '05': 'Sud-Ouest'\n         }\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            print(f\"\\nLocalisation : Région {REGION_MAP[region_code]} (Détail commune non disponible)\")","path":"whoistel.py","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nWith this change to use the global `REGION_MAP` constant, the local `region_map` variable defined on lines 217-223 is now unused. It should be removed to improve code clarity and avoid confusion.","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932593","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932593"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":225,"start_side":"RIGHT","line":null,"original_line":226,"side":"RIGHT","author_association":"NONE","original_position":111,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198","pull_request_review_id":3542654614,"id":2591023198,"node_id":"PRRC_kwDOPKYCYs6ab-Be","diff_hunk":"@@ -0,0 +1,60 @@\n+import sqlite3\n+import os","path":"history_manager.py","commit_id":"f737056296de126669f76660e5a0c633c07516e6","original_commit_id":"f737056296de126669f76660e5a0c633c07516e6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `os` module is imported but never used in this file. It's good practice to remove unused imports to keep the code clean and reduce the module's memory footprint.","created_at":"2025-12-05T00:27:53Z","updated_at":"2025-12-05T00:27:53Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023198","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023198"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":2,"side":"RIGHT","author_association":"NONE","original_position":2,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202","pull_request_review_id":3542654614,"id":2591023202,"node_id":"PRRC_kwDOPKYCYs6ab-Bi","diff_hunk":"@@ -20,3 +21,8 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.log\n+*.png\n+verification/","path":".gitignore","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"f737056296de126669f76660e5a0c633c07516e6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe files `test_output.txt` and `test_output_2.txt` have been added to this pull request. These appear to be test run artifacts that should not be committed to the repository. Please add a pattern for them to `.gitignore` to prevent this in the future, and remove the files from this PR.\n\n```\nverification/\ntest_output*.txt\n```","created_at":"2025-12-05T00:27:53Z","updated_at":"2025-12-05T00:27:53Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023202","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023202"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":32,"original_line":28,"side":"RIGHT","author_association":"NONE","original_position":16,"position":20,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870","pull_request_review_id":3542673196,"id":2591038870,"node_id":"PRRC_kwDOPKYCYs6acB2W","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe phone number being reported is taken from a hidden form field. This means a user could manipulate the POST request to submit a spam report for any phone number, not just the one displayed on the page. This could lead to pollution of the history database with false reports.\n\nTo make this more secure, you could consider tying the report to the number in the URL, for example by changing the route to `/view/<number>/report`. While the user can still change the URL, it makes the intent clearer. A more robust solution would involve using the server-side session to verify that the reported number matches the one the user was viewing.","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038870","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038870"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":88,"original_line":55,"side":"RIGHT","author_association":"NONE","original_position":55,"position":88,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872","pull_request_review_id":3542673196,"id":2591038872,"node_id":"PRRC_kwDOPKYCYs6acB2Y","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor security, it's better to bind the development server to `127.0.0.1` (localhost) by default instead of `0.0.0.0`. This restricts access to your local machine. If you need to access it from other devices on your network during development, you can still do so by explicitly changing it, but `localhost` is a safer default.\n\n```suggestion\n    app.run(debug=False, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038872","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038872"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":79,"side":"RIGHT","author_association":"NONE","original_position":79,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874","pull_request_review_id":3542673196,"id":2591038874,"node_id":"PRRC_kwDOPKYCYs6acB2a","diff_hunk":"@@ -32,12 +59,21 @@ def get_operator_info(conn, code_operateur):\n     cursor.execute(\"SELECT NomOperateur, TypeOperateur, MailOperateur, SiteOperateur FROM Operateurs WHERE CodeOperateur=?\", (code_operateur,))\n     row = cursor.fetchone()\n     if row:\n+        mail = row[2]\n+        site = row[3]\n+\n+        # Simple validation to prevent XSS\n+        if mail and ('@' not in mail or '<' in mail or '>' in mail):\n+            mail = None\n+        if site and not (site.startswith('http://') or site.startswith('https://')):\n+            site = None","path":"whoistel.py","commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe validation for email and site URLs is a good security measure against XSS. However, the current implementation using simple string checks is a bit basic and could potentially be bypassed or reject valid inputs. For more robust validation, consider using specialized libraries:\n\n*   **Email:** The `email-validator` library provides comprehensive email syntax and deliverability checks.\n*   **URL:** Python's `urllib.parse` can be used to properly parse and validate URL structures.\n\nWhile Jinja2's auto-escaping offers strong protection, adopting a defense-in-depth strategy by strengthening validation at the data-source level is recommended.","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038874","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038874"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":65,"start_side":"RIGHT","line":null,"original_line":69,"side":"RIGHT","author_association":"NONE","original_position":68,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029","pull_request_review_id":3542683656,"id":2591048029,"node_id":"PRRC_kwDOPKYCYs6acEFd","diff_hunk":"@@ -0,0 +1,59 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'","path":"history_manager.py","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database file path is hardcoded. This makes it difficult to configure for different environments (e.g., development, testing, production) without monkey-patching the variable, as done in the tests. It's better to make it configurable via an environment variable, similar to how `SECRET_KEY` is handled in `webapp.py`.\n\n```suggestion\nimport sqlite3\nimport logging\nfrom contextlib import closing\nimport os\n\nDB_FILE = os.environ.get('HISTORY_DB_PATH', 'history.sqlite3')\n```","created_at":"2025-12-05T00:45:49Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048029","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048029"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":5,"side":"RIGHT","author_association":"NONE","original_position":5,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037","pull_request_review_id":3542683656,"id":2591048037,"node_id":"PRRC_kwDOPKYCYs6acEFl","diff_hunk":"@@ -0,0 +1,66 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n+            </ul>\n+        {% endif %}\n+\n+        {% if result.location %}\n+            <h4>Localisation</h4>\n+            <ul>\n+                {% if result.location.commune %}\n+                    <li><strong>Commune :</strong> {{ result.location.commune }} ({{ result.location.code_postal }})</li>\n+                    <li><strong>Département :</strong> {{ result.location.departement }}</li>\n+                {% elif result.location.region %}\n+                    <li><strong>Région :</strong> {{ result.location.region }}</li>\n+                {% endif %}\n+            </ul>\n+        {% endif %}\n+    </div>\n+{% endif %}\n+\n+<div class=\"result-box community\">\n+    <h3>Statistiques Communautaires</h3>\n+    <p>Ce numéro a été signalé comme spam <strong>{{ spam_count }}</strong> fois.</p>\n+</div>\n+\n+<h3>Ajouter un signalement / note</h3>\n+<form action=\"{{ url_for('report') }}\" method=\"post\">\n+    <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token() }}\">\n+    <input type=\"hidden\" name=\"number\" value=\"{{ number }}\">\n+\n+    <label for=\"date\">Date de l'appel (optionnel) :</label>\n+    <input type=\"date\" name=\"date\" id=\"date\">\n+\n+    <label>\n+        <input type=\"checkbox\" name=\"is_spam\"> Signaler comme Spam / Démarchage\n+    </label>\n+    <br><br>\n+\n+    <label for=\"comment\">Commentaire (optionnel) :</label><br>\n+    <textarea name=\"comment\" id=\"comment\" rows=\"3\"></textarea>","path":"templates/result.html","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nTo provide immediate feedback to the user and prevent submission of overly long comments, you should add a `maxlength` attribute to this `textarea`. This complements the backend validation.\n\n```\n    <textarea name=\"comment\" id=\"comment\" rows=\"3\" maxlength=\"1024\"></textarea>\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048037","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048037"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":60,"original_line":60,"side":"RIGHT","author_association":"NONE","original_position":60,"position":60,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038","pull_request_review_id":3542683656,"id":2591048038,"node_id":"PRRC_kwDOPKYCYs6acEFm","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')","path":"webapp.py","commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `comment` field is taken directly from the form without any length validation. A malicious user could submit a very large comment, potentially leading to performance issues or storage abuse. It's good practice to enforce a reasonable length limit on user-submitted text fields. This change will truncate the comment on the backend. A corresponding frontend change is also recommended.\n\n```suggestion\n    comment = (request.form.get('comment') or '')[:1024]\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048038","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048038"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":58,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041","pull_request_review_id":3542683656,"id":2591048041,"node_id":"PRRC_kwDOPKYCYs6acEFp","diff_hunk":"@@ -5,24 +5,53 @@\n import sys\n import os\n import logging\n+import re\n+from urllib.parse import urlparse\n+from email_validator import validate_email, EmailNotValidError\n+\n+class DatabaseError(Exception):\n+    pass\n \n # Configure logging\n logging.basicConfig(level=logging.INFO, format='%(message)s') # Simplified format for CLI\n logger = logging.getLogger(__name__)\n \n DB_FILE = 'whoistel.sqlite3'\n \n+REGION_MAP = {\n+    '01': 'Île-de-France',\n+    '02': 'Nord-Ouest',\n+    '03': 'Nord-Est',\n+    '04': 'Sud-Est',\n+    '05': 'Sud-Ouest'\n+}\n+\n+def clean_phone_number(raw_tel):\n+    if not raw_tel:\n+        return \"\"\n+    # Remove separators and parenthesis\n+    tel = re.sub(r'[ .\\-()]', '', raw_tel)","path":"whoistel.py","commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current regex `[ .\\-()]` only removes spaces, dots, hyphens, and parentheses. It would be more robust to also handle other whitespace characters like tabs or non-breaking spaces, which can sometimes be pasted into form fields. Using `\\s` in the character class will achieve this.\n\n```suggestion\n    tel = re.sub(r'[\\s.\\-()]', '', raw_tel)\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048041","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048041"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":33,"side":"RIGHT","author_association":"NONE","original_position":29,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571","pull_request_review_id":3542701855,"id":2591064571,"node_id":"PRRC_kwDOPKYCYs6acIH7","diff_hunk":"@@ -0,0 +1,104 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('history_manager.add_report') as mock_add_report:","path":"tests/test_webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis test is failing, as indicated in `test_result.txt`, due to an incorrect `patch` target. When mocking, you should target the name where the object is *looked up*, not where it is defined. The `report` function in `webapp.py` calls `history_manager.add_report`, so you need to patch `add_report` within the `webapp` module's namespace.\n\n```suggestion\n    with patch('webapp.history_manager.add_report') as mock_add_report:\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064571","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064571"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":95,"side":"RIGHT","author_association":"NONE","original_position":95,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577","pull_request_review_id":3542701855,"id":2591064577,"node_id":"PRRC_kwDOPKYCYs6acIIB","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)","path":"webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIn this route, a new database connection to `whoistel.sqlite3` is opened, and the call to `history_manager.get_spam_count()` opens another connection to `history.sqlite3`. This pattern of opening new connections for each operation is inefficient and will not scale well. A better practice in Flask is to manage database connections on a per-request basis using the application context (`g`). This allows connection reuse within a single request, which significantly improves performance by reducing connection setup/teardown overhead.\n\nHere is an example of how you could implement this:\n\n```python\n# In webapp.py\nfrom flask import g\n\ndef get_whois_db():\n    if 'whois_db' not in g:\n        g.whois_db = whoistel.setup_db_connection()\n    return g.whois_db\n\n@app.teardown_appcontext\ndef close_db(e=None):\n    db = g.pop('whois_db', None)\n    if db is not None:\n        db.close()\n    # ... and so on for the history_db\n\n# Then in your view function:\nconn = get_whois_db()\nresult = whoistel.get_full_info(conn, cleaned_number)\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064577","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064577"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579","pull_request_review_id":3542701855,"id":2591064579,"node_id":"PRRC_kwDOPKYCYs6acIID","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:1024]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current settings for the development server are not ideal for local development and could pose a minor security risk.\n\n- `debug=False` disables the interactive debugger and auto-reloader, which are very helpful during development.\n- `host='0.0.0.0'` exposes the development server to your local network, which is not always desirable or safe. It's better to default to `'127.0.0.1'` (localhost) for development.\n\nSince the `README.md` already provides excellent guidance for production deployment, this change would improve the local development experience without affecting production.\n\n```suggestion\n    app.run(debug=True, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064579","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064579"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":79,"side":"RIGHT","author_association":"NONE","original_position":79,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582","pull_request_review_id":3542701855,"id":2591064582,"node_id":"PRRC_kwDOPKYCYs6acIIG","diff_hunk":"@@ -0,0 +1,59 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()","path":"history_manager.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nEach function in this module (`add_report`, `get_spam_count`, etc.) opens and closes its own database connection. This is inefficient for a web application due to the overhead of creating connections for every call. For better performance, these functions should accept a database connection object as an argument, allowing the calling application (Flask) to manage the connection lifecycle (e.g., one connection per request). I've left a related comment in `webapp.py` with a suggested implementation pattern.","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064582","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064582"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":37,"side":"RIGHT","author_association":"NONE","original_position":37,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692","pull_request_review_id":3544030716,"id":2592137692,"node_id":"PRRC_kwDOPKYCYs6agOHc","diff_hunk":"@@ -0,0 +1,80 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe application handles an empty phone number submission by silently redirecting to the index page. While the HTML form includes a `required` attribute, client-side validation can be bypassed. For a more robust user experience, it's better to provide explicit server-side feedback. You could use Flask's flash messaging system to display an error message to the user explaining why their submission was not processed.","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137692","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137692"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":55,"original_start_line":24,"start_side":"RIGHT","line":58,"original_line":26,"side":"RIGHT","author_association":"NONE","original_position":26,"position":58,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699","pull_request_review_id":3544030716,"id":2592137699,"node_id":"PRRC_kwDOPKYCYs6agOHj","diff_hunk":"@@ -0,0 +1,80 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)","path":"webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis endpoint opens two separate database connections on each request: one to `whoistel.sqlite3` via `whoistel.setup_db_connection()` and another to `history.sqlite3` inside `history_manager.get_spam_count()`. This is inefficient and can lead to performance issues under load. A better practice is to manage database connections at the application level, for example, by using Flask's application context (`g` object) to open connections once per request and reuse them across function calls. This would improve performance and centralize connection management.","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137699","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137699"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701","pull_request_review_id":3544030716,"id":2592137701,"node_id":"PRRC_kwDOPKYCYs6agOHl","diff_hunk":"@@ -0,0 +1,123 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('history_manager.add_report') as mock_add_report:","path":"tests/test_webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe patch target for `add_report` is incorrect, which causes this test to fail as seen in the test logs. When patching, you should target where the object is *looked up*, not where it is defined. Since `webapp.py` imports `history_manager` and calls `history_manager.add_report`, the correct patch target is `webapp.history_manager.add_report`.\n\n```suggestion\n    with patch('webapp.history_manager.add_report') as mock_add_report:\n```","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137701","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137701"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":95,"side":"RIGHT","author_association":"NONE","original_position":95,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628","pull_request_review_id":3544119069,"id":2592202628,"node_id":"PRRC_kwDOPKYCYs6agd-E","diff_hunk":"@@ -9,6 +9,8 @@ venv/\n \n # Database\n whoistel.sqlite3\n+history.sqlite3\n+test_output*.txt","path":".gitignore","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe pull request adds several generated files and local development artifacts to the repository (e.g., `analysis.txt`, `test_result.txt`, `pr_comments*.txt`). These files should not be committed to version control to keep the repository clean. Please remove them and update `.gitignore` to prevent them from being accidentally committed in the future.\n\nThe script `analyze_comments.py` also seems like a temporary utility and should likely be removed as well.\n\n```\nwhoistel.sqlite3\nhistory.sqlite3\ntest_output*.txt\ntest_result.txt\nanalysis*.txt\npr_comments*.txt\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202628","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202628"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":11,"original_start_line":11,"start_side":"RIGHT","line":13,"original_line":13,"side":"RIGHT","author_association":"NONE","original_position":5,"position":5,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631","pull_request_review_id":3544119069,"id":2592202631,"node_id":"PRRC_kwDOPKYCYs6agd-H","diff_hunk":"@@ -0,0 +1,67 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            add_report(phone_number, report_date, is_spam, comment, conn)\n+\n+def get_spam_count(phone_number, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            return get_spam_count(phone_number, conn)\n+\n+def get_recent_reports(limit=50, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            return get_recent_reports(limit, conn)","path":"history_manager.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe functions `add_report`, `get_spam_count`, and `get_recent_reports` all contain repetitive boilerplate code for handling database connections. This pattern of checking for a `conn` argument and otherwise creating a new connection can be simplified and made more maintainable by using a decorator. This would reduce code duplication and centralize the connection management logic.\n\nHere is an example of how you could implement this:\n\n```python\nfrom functools import wraps\nfrom contextlib import closing\n\ndef with_db_connection(func):\n    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        conn = kwargs.get('conn')\n        if conn:\n            return func(*args, **kwargs)\n        else:\n            with closing(get_db_connection()) as new_conn:\n                kwargs['conn'] = new_conn\n                return func(*args, **kwargs)\n    return wrapper\n\n@with_db_connection\ndef add_report(phone_number, report_date, is_spam, comment, conn=None):\n    c = conn.cursor()\n    c.execute('''\n        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n        VALUES (?, ?, ?, ?)\n    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n    conn.commit()\n\n# You can then apply @with_db_connection to the other functions.\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202631","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202631"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":30,"start_side":"RIGHT","line":null,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633","pull_request_review_id":3544119069,"id":2592202633,"node_id":"PRRC_kwDOPKYCYs6agd-J","diff_hunk":"@@ -0,0 +1,94 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+@app.teardown_appcontext\n+def close_history_db(error):\n+    db = g.pop('history_db', None)\n+    if db is not None:\n+        db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)","path":"webapp.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIn the `view_number` route, a new database connection to `whoistel.sqlite3` is opened and closed for every request. For better performance and consistency with how the history database connection is handled, you should manage the main database connection using Flask's application context (`g` object). This will reuse the connection for the duration of the request, avoiding the overhead of establishing a new connection each time.\n\nYou can achieve this by adding functions to get and close the main DB connection and updating the teardown function, similar to what's done for the history DB:\n\n```python\ndef get_main_db():\n    if 'main_db' not in g:\n        g.main_db = whoistel.setup_db_connection()\n    return g.main_db\n\n# Replace close_history_db with a function that closes all DBs\n@app.teardown_appcontext\ndef close_dbs(error):\n    history_db = g.pop('history_db', None)\n    if history_db is not None:\n        history_db.close()\n    \n    main_db = g.pop('main_db', None)\n    if main_db is not None:\n        main_db.close()\n```\n\nThen, in your `view_number` function, you can replace the `with closing(...)` block with:\n\n```python\nconn = get_main_db()\nresult = whoistel.get_full_info(conn, cleaned_number)\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202633","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202633"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":51,"start_side":"RIGHT","line":null,"original_line":52,"side":"RIGHT","author_association":"NONE","original_position":52,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512","pull_request_review_id":3544181318,"id":2592251512,"node_id":"PRRC_kwDOPKYCYs6agp54","diff_hunk":"@@ -0,0 +1,121 @@\n+============================= test session starts ==============================\n+platform linux -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- /usr/bin/python3\n+cachedir: .pytest_cache\n+rootdir: /home/sheepdestroyer/LAB/whoistel\n+plugins: anyio-4.11.0\n+collecting ... collected 15 items\n+\n+tests/test_webapp.py::test_index PASSED                                  [  6%]\n+tests/test_webapp.py::test_check_number_redirect PASSED                  [ 13%]\n+tests/test_webapp.py::test_view_number_unknown PASSED                    [ 20%]\n+tests/test_webapp.py::test_report_flow PASSED                            [ 26%]\n+tests/test_webapp.py::test_check_known_missing_number PASSED             [ 33%]\n+tests/test_webapp.py::test_view_number_redirect_dirty PASSED             [ 40%]\n+tests/test_webapp.py::test_report_empty_date PASSED                      [ 46%]\n+tests/test_webapp.py::test_database_connection_error PASSED              [ 53%]\n+tests/test_webapp.py::test_report_comment_truncation FAILED              [ 60%]\n+tests/test_whoistel.py::test_geographic_number_lookup PASSED             [ 66%]\n+tests/test_whoistel.py::test_non_geographic_test_number_lookup PASSED    [ 73%]\n+tests/test_whoistel.py::test_valid_geo_number_lookup PASSED              [ 80%]\n+tests/test_whoistel.py::test_invalid_number_format_non_digit PASSED      [ 86%]\n+tests/test_whoistel.py::test_clean_phone_number PASSED                   [ 93%]\n+tests/test_whoistel.py::test_operator_info_validation PASSED             [100%]\n+\n+=================================== FAILURES ===================================\n+________________________ test_report_comment_truncation ________________________\n+\n+client = <FlaskClient <Flask 'webapp'>>\n+\n+    def test_report_comment_truncation(client):\n+        \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+        long_comment = \"a\" * 2000\n+>       with patch('whoistel.history_manager.add_report') as mock_add_report:\n+             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+tests/test_webapp.py:95: \n+_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n+/usr/lib64/python3.14/unittest/mock.py:1487: in __enter__\n+    self.target = self.getter()\n+                  ^^^^^^^^^^^^^\n+_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n+\n+name = 'whoistel.history_manager'\n+\n+    def resolve_name(name):\n+        \"\"\"\n+        Resolve a name to an object.\n+    \n+        It is expected that `name` will be a string in one of the following\n+        formats, where W is shorthand for a valid Python identifier and dot stands\n+        for a literal period in these pseudo-regexes:\n+    \n+        W(.W)*\n+        W(.W)*:(W(.W)*)?\n+    \n+        The first form is intended for backward compatibility only. It assumes that\n+        some part of the dotted name is a package, and the rest is an object\n+        somewhere within that package, possibly nested inside other objects.\n+        Because the place where the package stops and the object hierarchy starts\n+        can't be inferred by inspection, repeated attempts to import must be done\n+        with this form.\n+    \n+        In the second form, the caller makes the division point clear through the\n+        provision of a single colon: the dotted name to the left of the colon is a\n+        package to be imported, and the dotted name to the right is the object\n+        hierarchy within that package. Only one import is needed in this form. If\n+        it ends with the colon, then a module object is returned.\n+    \n+        The function will return an object (which might be a module), or raise one\n+        of the following exceptions:\n+    \n+        ValueError - if `name` isn't in a recognised format\n+        ImportError - if an import failed when it shouldn't have\n+        AttributeError - if a failure occurred when traversing the object hierarchy\n+                         within the imported package to get to the desired object.\n+        \"\"\"\n+        global _NAME_PATTERN\n+        if _NAME_PATTERN is None:\n+            # Lazy import to speedup Python startup time\n+            import re\n+            dotted_words = r'(?!\\d)(\\w+)(\\.(?!\\d)(\\w+))*'\n+            _NAME_PATTERN = re.compile(f'^(?P<pkg>{dotted_words})'\n+                                       f'(?P<cln>:(?P<obj>{dotted_words})?)?$',\n+                                       re.UNICODE)\n+    \n+        m = _NAME_PATTERN.match(name)\n+        if not m:\n+            raise ValueError(f'invalid format: {name!r}')\n+        gd = m.groupdict()\n+        if gd.get('cln'):\n+            # there is a colon - a one-step import is all that's needed\n+            mod = importlib.import_module(gd['pkg'])\n+            parts = gd.get('obj')\n+            parts = parts.split('.') if parts else []\n+        else:\n+            # no colon - have to iterate to find the package boundary\n+            parts = name.split('.')\n+            modname = parts.pop(0)\n+            # first part *must* be a module/package.\n+            mod = importlib.import_module(modname)\n+            while parts:\n+                p = parts[0]\n+                s = f'{modname}.{p}'\n+                try:\n+                    mod = importlib.import_module(s)\n+                    parts.pop(0)\n+                    modname = s\n+                except ImportError:\n+                    break\n+        # if we reach this point, mod is the module, already imported, and\n+        # parts is the list of parts in the object hierarchy to be traversed, or\n+        # an empty list if just the module is wanted.\n+        result = mod\n+        for p in parts:\n+>           result = getattr(result, p)\n+                     ^^^^^^^^^^^^^^^^^^\n+E           AttributeError: module 'whoistel' has no attribute 'history_manager'\n+\n+/usr/lib64/python3.14/pkgutil.py:473: AttributeError\n+=========================== short test summary info ============================\n+FAILED tests/test_webapp.py::test_report_comment_truncation - AttributeError:...\n+========================= 1 failed, 14 passed in 0.37s =========================","path":"test_result.txt","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file, along with other temporary analysis and comment files (`debug_analysis.txt`, `pr_comments.txt`, `pr_comments_retry.txt`, `pr_comments_retry_2.txt`), should be removed from the pull request. Committing development artifacts and test logs to the repository is not good practice as it adds noise and can be confusing for other developers. In this case, this file shows a test failure that appears to have been fixed in the submitted code, which is particularly misleading. Please remove all such temporary files from this PR and consider updating `.gitignore` to prevent them from being accidentally committed in the future.","created_at":"2025-12-05T10:51:21Z","updated_at":"2025-12-05T10:51:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251512","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251512"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":121,"side":"RIGHT","author_association":"NONE","original_position":121,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515","pull_request_review_id":3544181318,"id":2592251515,"node_id":"PRRC_kwDOPKYCYs6agp57","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                kwargs['conn'] = new_conn\n+                return func(*args, **kwargs)\n+    return wrapper\n+\n+DB_FILE = 'history.sqlite3'","path":"history_manager.py","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe history database file path is hardcoded. This makes the application less flexible for different deployment environments or for running certain kinds of tests. It's better to make this configurable via an environment variable, with the current path as a default. This allows overriding the database path without changing the code. Remember to add `import os` at the top of the file.\n\n```suggestion\nDB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n```","created_at":"2025-12-05T10:51:21Z","updated_at":"2025-12-05T10:51:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251515","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251515"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":19,"side":"RIGHT","author_association":"NONE","original_position":19,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847","pull_request_review_id":3544524605,"id":2592503847,"node_id":"PRRC_kwDOPKYCYs6ahngn","diff_hunk":"@@ -0,0 +1,27 @@\n+import json\n+import sys\n+\n+try:\n+    with open('latest_comments.json', 'r') as f:\n+        comments = json.load(f)\n+\n+    # Filter for comments newer than the Cycle 7 batch (approx 10:35Z)\n+    # Using 10:40:00Z to ensure we only see completely new feedback\n+    cutoff = '2025-12-05T10:40:00Z'\n+    new_comments = [c for c in comments if c.get('created_at', '') > cutoff]\n+    \n+    print(f\"Total comments: {len(comments)}\")\n+    print(f\"New comments (Cycle 8?): {len(new_comments)}\")\n+\n+    # Sort by created_at\n+    new_comments.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n+    \n+    for c in new_comments[:10]:\n+        print(\"-\" * 40)\n+        print(f\"Date: {c.get('created_at')}\")\n+        print(f\"File: {c.get('path')}\")\n+        print(f\"Line: {c.get('line') or c.get('original_line')}\")\n+        print(f\"Body: {c.get('body')}\")\n+\n+except Exception as e:\n+    print(f\"Error: {e}\")","path":"analyze_comments.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file, along with `.antigravity/context.md`, `cycle_8_check.txt`, and `pr_comments_retry_2.txt`, appears to be a temporary development artifact or log file. Committing such files to the repository adds noise, can be confusing for other developers, and is not good practice. Please remove these files from the pull request. Consider updating `.gitignore` to prevent them from being accidentally committed in the future if they are generated.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503847","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503847"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":1,"original_start_line":1,"start_side":"RIGHT","line":29,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":27,"position":29,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850","pull_request_review_id":3544524605,"id":2592503850,"node_id":"PRRC_kwDOPKYCYs6ahngq","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+    <table>\n+        <thead>\n+            <tr>\n+                <th>Numéro</th>\n+                <th>Date Appel</th>\n+                <th>Spam?</th>\n+                <th>Commentaire</th>\n+                <th>Signalé le</th>\n+                <th>Action</th>\n+            </tr>\n+        </thead>\n+        <tbody>\n+            {% for report in reports %}\n+            <tr>\n+                <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+                <td>{{ report.report_date }}</td>\n+                <td class=\"{{ 'spam-alert' if report.is_spam else '' }}\">{{ 'OUI' if report.is_spam else 'NON' }}</td>\n+                <td>{{ report.comment }}</td>\n+                <td>{{ report.created_at }}</td>","path":"templates/history.html","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `created_at` timestamp is displayed directly from the database. This can result in a format that is not very user-friendly (e.g., `2023-10-27 14:30:00`). For better readability and a more polished UI, consider formatting this timestamp. This could be done in the `history` view function in `webapp.py` before passing the data to the template, or by using a Jinja filter. A format like `DD/MM/YYYY HH:MM` might be more appropriate for a French-language UI.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503850","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503850"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851","pull_request_review_id":3544524605,"id":2592503851,"node_id":"PRRC_kwDOPKYCYs6ahngr","diff_hunk":"@@ -139,16 +233,10 @@ def print_result(conn, tel, info):\n \n     # If Geo and no CodeInsee, give Region hint\n     if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            print(f\"\\nLocalisation : Région {REGION_MAP[region_code]} (Détail commune non disponible)\")","path":"whoistel.py","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis logic for determining the region is also present in the new `get_full_info` function. The `print_result` function duplicates a lot of the logic that was refactored into `get_full_info` (e.g., fetching operator details, location info). To improve maintainability and ensure the CLI output is consistent with the web UI, the `main` function should be updated to call `get_full_info`. This would allow `print_result` to be simplified into a function that just formats the rich dictionary returned by `get_full_info`, rather than re-fetching and processing data itself.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503851","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503851"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":238,"start_side":"RIGHT","line":null,"original_line":239,"side":"RIGHT","author_association":"NONE","original_position":162,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373","pull_request_review_id":3544610557,"id":2592566373,"node_id":"PRRC_kwDOPKYCYs6ah2xl","diff_hunk":"@@ -0,0 +1,29 @@\n+import json\n+import sys\n+\n+try:\n+    with open('latest_comments_c9.json', 'r') as f:\n+        comments = json.load(f)\n+\n+    # Filter for comments newer than Cycle 8 (which was around 11:50-12:00 UTC?)\n+    # Local time is 13:20 CET -> 12:20 UTC.\n+    # Previous check was 10:40 UTC. Cycle 8 comments were 10:51 UTC.\n+    # So we want anything > 11:00 UTC.\n+    cutoff = '2025-12-05T11:00:00Z'\n+    new_comments = [c for c in comments if c.get('created_at', '') > cutoff]\n+    \n+    print(f\"Total comments: {len(comments)}\")\n+    print(f\"New comments (Cycle 8?): {len(new_comments)}\")\n+\n+    # Sort by created_at\n+    new_comments.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n+    \n+    for c in new_comments[:10]:\n+        print(\"-\" * 40)\n+        print(f\"Date: {c.get('created_at')}\")\n+        print(f\"File: {c.get('path')}\")\n+        print(f\"Line: {c.get('line') or c.get('original_line')}\")\n+        print(f\"Body: {c.get('body')}\")\n+\n+except Exception as e:\n+    print(f\"Error: {e}\")","path":"analyze_comments.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file appears to be a temporary script for development and debugging. It contains hardcoded, user-specific values (e.g., `'latest_comments_c9.json'`, `'2025-12-05T11:00:00Z'`) and is not part of the application's core functionality. Committing such development artifacts adds noise to the repository and can be confusing for other contributors. Please remove this file from the pull request. Such scripts should be added to `.gitignore` if they are part of a regular workflow.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566373","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566373"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":1,"original_start_line":1,"start_side":"RIGHT","line":29,"original_line":29,"side":"RIGHT","author_association":"NONE","original_position":29,"position":29,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376","pull_request_review_id":3544610557,"id":2592566376,"node_id":"PRRC_kwDOPKYCYs6ah2xo","diff_hunk":"@@ -0,0 +1,23 @@\n+Total comments: 68\n+New comments (Cycle 8?): 3\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: analyze_comments.py\n+Line: 27\n+Body: ![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n+\n+This file, along with `.antigravity/context.md`, `cycle_8_check.txt`, and `pr_comments_retry_2.txt`, appears to be a temporary development artifact or log file. Committing such files to the repository adds noise, can be confusing for other developers, and is not good practice. Please remove these files from the pull request. Consider updating `.gitignore` to prevent them from being accidentally committed in the future if they are generated.\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: templates/history.html\n+Line: 25\n+Body: ![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n+\n+The `created_at` timestamp is displayed directly from the database. This can result in a format that is not very user-friendly (e.g., `2023-10-27 14:30:00`). For better readability and a more polished UI, consider formatting this timestamp. This could be done in the `history` view function in `webapp.py` before passing the data to the template, or by using a Jinja filter. A format like `DD/MM/YYYY HH:MM` might be more appropriate for a French-language UI.\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: whoistel.py\n+Line: 239\n+Body: ![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n+\n+This logic for determining the region is also present in the new `get_full_info` function. The `print_result` function duplicates a lot of the logic that was refactored into `get_full_info` (e.g., fetching operator details, location info). To improve maintainability and ensure the CLI output is consistent with the web UI, the `main` function should be updated to call `get_full_info`. This would allow `print_result` to be simplified into a function that just formats the rich dictionary returned by `get_full_info`, rather than re-fetching and processing data itself.","path":"cycle_9_check.txt","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis text file appears to be a temporary output log from your development process. Such files should not be committed to version control as they add clutter and have no value for the production code or future development. Please remove this file from the pull request.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566376","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566376"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":1,"original_start_line":1,"start_side":"RIGHT","line":23,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":23,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378","pull_request_review_id":3544610557,"id":2592566378,"node_id":"PRRC_kwDOPKYCYs6ah2xq","diff_hunk":"@@ -0,0 +1,48 @@\n+# GitHub CLI Review Cycle & Troubleshooting\n+\n+## Learned Lessons: Fetching Comments\n+During the implementation of the `whoistel` web UI, we encountered issues reliably fetching code review comments using the `gh` CLI. Here is what we learned:\n+\n+1.  **Endpoint Distinction**:\n+    *   `gh pr view {N} --json comments`: Fetches **Issue Comments** (top-level discussion). It does **NOT** fetch inline code review comments (specific to lines of code).\n+    *   `gh api repos/{owner}/{repo}/pulls/{N}/comments`: Fetches **Review Comments** (inline feedback). This is the correct endpoint for code review feedback.\n+\n+2.  **Pagination is Critical**:\n+    *   The GitHub API paginates results (default ~30 items).\n+    *   **Failure Mode**: Without pagination, we only retrieved the first page of comments (often the oldest ones). New feedback was missed because it fell on subsequent pages.\n+    *   **Solution**: Always use the `--paginate` flag with `gh api` to retrieve all comments.\n+\n+## The Correct Review Cycle Workflow\n+To successfully iterate with Gemini Code Assist (or any reviewer) using the CLI:\n+\n+### 1. Request Review\n+Trigger the bot to review your latest changes.\n+```bash\n+gh pr comment {PR_NUMBER} --body \"/gemini review\"\n+```\n+\n+### 2. Wait\n+Allow time for the review to process (typically 3-5 minutes).\n+\n+### 3. Fetch Comments (Correctly)\n+Use the API endpoint with pagination to ensure you get *everything*.\n+```bash\n+gh api repos/{OWNER}/{REPO}/pulls/{PR_NUMBER}/comments --paginate > comments.json\n+```\n+\n+### 4. Analyze & Filter\n+Parse the JSON to find comments created **after** your last push/fix cycle.\n+*   Filter by `created_at` timestamp.\n+*   Ignore \"outdated\" or resolved comments if your logic handles them.\n+\n+### 5. Implement & Verify\n+*   Address the specific feedback.\n+*   Run tests (`pytest`) to verify fixes.\n+\n+### 6. Push & Repeat\n+```bash\n+git add .\n+git commit -m \"Address Cycle X comments\"\n+git push\n+```\n+Return to Step 1.","path":".antigravity/context.md","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis Markdown file seems to document lessons learned during development. While this information can be valuable, committing it to the source tree, especially under a hidden directory, is unconventional and adds clutter. This type of documentation is often better suited for a project wiki, a separate `docs` folder, or as a comment in the pull request description if it's context-specific. Please remove this file from the commit.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566378","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566378"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":1,"original_start_line":1,"start_side":"RIGHT","line":48,"original_line":48,"side":"RIGHT","author_association":"NONE","original_position":48,"position":48,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384","pull_request_review_id":3544610557,"id":2592566384,"node_id":"PRRC_kwDOPKYCYs6ah2xw","diff_hunk":"@@ -0,0 +1,114 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if value is None:\n+        return \"\"\n+    if isinstance(value, str):\n+        try:\n+            value = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n+        except ValueError:\n+             return value\n+    return value.strftime(format)","path":"webapp.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `format_datetime` filter is not robust enough. It only attempts to parse full datetime strings (`YYYY-MM-DD HH:MM:SS`) and will fail to format date-only strings (like `YYYY-MM-DD` from `report_date`), returning them unformatted. This leads to an inconsistent user interface in the history page. Please update the filter to handle both date and datetime strings gracefully.\n\n```suggestion\n@app.template_filter('format_datetime')\ndef format_datetime(value, format='%d/%m/%Y %H:%M'):\n    if value is None:\n        return \"\"\n    if isinstance(value, str):\n        try:\n            value = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n        except ValueError:\n            try:\n                # Fallback for date-only strings\n                value = datetime.strptime(value, '%Y-%m-%d')\n                return value.strftime('%d/%m/%Y')\n            except ValueError:\n                 return value # Return as-is if not a recognized format\n    return value.strftime(format)\n```","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566384","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566384"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":18,"original_start_line":18,"start_side":"RIGHT","line":27,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":27,"position":27,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394","pull_request_review_id":3544610557,"id":2592566394,"node_id":"PRRC_kwDOPKYCYs6ah2x6","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+    <table>\n+        <thead>\n+            <tr>\n+                <th>Numéro</th>\n+                <th>Date Appel</th>\n+                <th>Spam?</th>\n+                <th>Commentaire</th>\n+                <th>Signalé le</th>\n+                <th>Action</th>\n+            </tr>\n+        </thead>\n+        <tbody>\n+            {% for report in reports %}\n+            <tr>\n+                <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+                <td>{{ report.report_date }}</td>","path":"templates/history.html","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor a consistent and user-friendly UI, the `report_date` should be formatted (e.g., to `DD/MM/YYYY`). Currently, it's displayed directly from the database. After updating the `format_datetime` filter in `webapp.py` as suggested in my other comment, please apply it here.\n\n```\n                <td>{{ report.report_date|format_datetime }}</td>\n```","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566394","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566394"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":22,"original_line":22,"side":"RIGHT","author_association":"NONE","original_position":22,"position":22,"subject_type":"line"}]