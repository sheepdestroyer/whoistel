[{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072","pull_request_review_id":3537125384,"id":2586763072,"node_id":"PRRC_kwDOPKYCYs6aLt9A","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe database connection is not closed safely. If an error occurs after the connection is opened but before `conn.close()` is called, the connection will leak. This can exhaust database connection resources over time. This issue is present in all database-accessing functions in this file (`init_history_db`, `get_spam_count`, etc.) and should be fixed in all of them.\n\nTo ensure the connection is always closed, you should use a `try...finally` block.\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:03Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086","pull_request_review_id":3537125384,"id":2586763086,"node_id":"PRRC_kwDOPKYCYs6aLt9O","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not closed in a `finally` block. If an exception occurs in `whoistel.get_full_info()`, the `conn.close()` line will not be reached, causing a connection leak. This can lead to resource exhaustion over time.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092","pull_request_review_id":3537125384,"id":2586763092,"node_id":"PRRC_kwDOPKYCYs6aLt9U","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is intended for development and is not suitable for a production environment. The built-in Flask development server is not designed for performance, stability, or security under production load. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI behind a reverse proxy like Nginx.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":66,"start_side":"RIGHT","line":null,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100","pull_request_review_id":3537125384,"id":2586763100,"node_id":"PRRC_kwDOPKYCYs6aLt9c","diff_hunk":"@@ -0,0 +1,34 @@\n+<!DOCTYPE html>\n+<html lang=\"fr\">\n+<head>\n+    <meta charset=\"UTF-8\">\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n+    <title>WhoisTel Web</title>\n+    <style>\n+        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }\n+        header { background: #333; color: #fff; padding: 10px; margin-bottom: 20px; }\n+        header nav a { color: #fff; margin-right: 15px; text-decoration: none; }\n+        .container { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n+        input[type=\"text\"], input[type=\"date\"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }\n+        input[type=\"submit\"], button { padding: 10px 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; }\n+        input[type=\"submit\"]:hover { background: #0056b3; }\n+        .result-box { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; }\n+        .spam-alert { color: red; font-weight: bold; }\n+        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n+        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }\n+        th { background: #eee; }\n+    </style>","path":"templates/layout.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nEmbedding CSS within a `<style>` tag in your HTML is generally discouraged for larger applications. Moving the CSS to an external file (e.g., `static/styles.css`) offers several benefits:\n\n- **Maintainability:** Separates styling from structure, making both easier to manage.\n- **Caching:** Allows browsers to cache the stylesheet, improving load times on subsequent page visits.\n- **Reusability:** The same stylesheet can be easily used across multiple pages.\n\nYou can link to an external stylesheet by placing it in the `static` folder and adding the following to your `<head>` section:\n```html\n<link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":7,"start_side":"RIGHT","line":null,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109","pull_request_review_id":3537125384,"id":2586763109,"node_id":"PRRC_kwDOPKYCYs6aLt9l","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box\" style=\"border-left: 5px solid red;\">","path":"templates/result.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing inline `style` attributes mixes presentation with your HTML structure, which can make the code harder to maintain. It's better to use CSS classes and define the styles in your stylesheet.\n\nFor example, you could define a class `.result-box-error` in your CSS:\n```css\n.result-box-error {\n    border-left: 5px solid red;\n}\n```\nAnd then apply it in your template:\n`<div class=\"result-box result-box-error\">`\n\nThis same principle applies to the other inline styles on lines 12 and 41.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":7,"side":"RIGHT","author_association":"NONE","original_position":7,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115","pull_request_review_id":3537125384,"id":2586763115,"node_id":"PRRC_kwDOPKYCYs6aLt9r","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis validation block is currently inactive because it's commented out and ends with `pass`. Relying on downstream functions to handle invalid input is not ideal. It's better to perform validation at the entry point of the request to fail fast and provide clear feedback. I recommend enabling and completing this validation to ensure only valid phone numbers are processed.\n\n```suggestion\n    if not number.isdigit() or len(number) != 10:\n        # Consider rendering an error page instead of a silent redirect.\n        return redirect(url_for('index'))\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123","pull_request_review_id":3537125384,"id":2586763123,"node_id":"PRRC_kwDOPKYCYs6aLt9z","diff_hunk":"@@ -99,6 +99,57 @@ def search_number(conn, tel):\n \n     return best_match\n \n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n+\n+    if not info:\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n+\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n+\n+    # Operator Info\n+    op_info = get_operator_info(conn, info['code_operateur'])\n+    if op_info:\n+        result['operator'] = op_info\n+    else:\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n+\n+    # Location Info\n+    if info['code_insee'] and info['code_insee'] != 0:\n+        commune_info = get_commune_info(conn, info['code_insee'])\n+        result['location'] = commune_info\n+\n+    # If Geo and no CodeInsee, give Region hint\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n+        region_map = {\n+            '01': 'Île-de-France',\n+            '02': 'Nord-Ouest',\n+            '03': 'Nord-Est',\n+            '04': 'Sud-Est',\n+            '05': 'Sud-Ouest'\n+        }\n+        region_code = tel[:2]\n+        if region_code in region_map:\n+            result['location'] = {'region': region_map[region_code]}","path":"whoistel.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `region_map` dictionary is duplicated here and also within the `print_result` function (lines 189-195). This code duplication can lead to maintenance issues, as a change in one place might be forgotten in the other. To follow the Don't Repeat Yourself (DRY) principle, this dictionary should be defined once as a module-level constant and referenced in both functions.","created_at":"2025-12-03T22:05:05Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":139,"start_side":"RIGHT","line":null,"original_line":149,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605","pull_request_review_id":3537453181,"id":2587050605,"node_id":"PRRC_kwDOPKYCYs6aM0Jt","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not guaranteed to be closed if `whoistel.get_full_info()` raises an exception. This can lead to resource leaks in the web application, which is more critical than in a short-lived script. Use a `try...finally` block to ensure `conn.close()` is always called.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610","pull_request_review_id":3537453181,"id":2587050610,"node_id":"PRRC_kwDOPKYCYs6aM0Jy","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current pattern of opening and closing database connections in each function is not robust. If an error occurs after the connection is opened but before `conn.close()` is called, the connection may not be closed, potentially leading to resource leaks. It's better to use a `try...finally` block to ensure `conn.close()` is always executed. This pattern should be applied to all database functions in this file (`init_history_db`, `add_report`, `get_spam_count`, `get_recent_reports`, `get_number_reports`).\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617","pull_request_review_id":3537453181,"id":2587050617,"node_id":"PRRC_kwDOPKYCYs6aM0J5","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis `if` block with a `pass` statement is dead code and serves no purpose. It should be removed to improve code clarity. If validation is intended here, it should be fully implemented.","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210","pull_request_review_id":3539470675,"id":2588642210,"node_id":"PRRC_kwDOPKYCYs6aS4ui","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block for database connection handling can be simplified by using the connection object as a context manager. This makes the code cleaner and ensures the connection is properly closed, and that transactions are committed or rolled back automatically. This same pattern can be applied to the other database functions in this file.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS reports (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                phone_number TEXT NOT NULL,\n                report_date TEXT,\n                is_spam INTEGER DEFAULT 0,\n                comment TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n```","created_at":"2025-12-04T11:19:03Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":33,"side":"RIGHT","author_association":"NONE","original_position":33,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224","pull_request_review_id":3539470675,"id":2588642224,"node_id":"PRRC_kwDOPKYCYs6aS4uw","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection handling can be simplified using a `with` statement. The connection object acts as a context manager, automatically handling commits and closing the connection.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":45,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235","pull_request_review_id":3539470675,"id":2588642235,"node_id":"PRRC_kwDOPKYCYs6aS4u7","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function can be simplified by using the database connection as a context manager. This avoids the manual `try...finally` block for closing the connection and makes the code more readable.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT COUNT(*) FROM reports\n            WHERE phone_number = ? AND is_spam = 1\n        ''', (phone_number,))\n        count = c.fetchone()[0]\n        return count\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":48,"start_side":"RIGHT","line":null,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":58,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243","pull_request_review_id":3539470675,"id":2588642243,"node_id":"PRRC_kwDOPKYCYs6aS4vD","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing a `with` statement for the database connection will make this function more concise and robust by automatically handling the connection closing.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            ORDER BY created_at DESC\n            LIMIT ?\n        ''', (limit,))\n        rows = c.fetchall()\n        # Convert rows to dicts\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":61,"start_side":"RIGHT","line":null,"original_line":73,"side":"RIGHT","author_association":"NONE","original_position":73,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250","pull_request_review_id":3539470675,"id":2588642250,"node_id":"PRRC_kwDOPKYCYs6aS4vK","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()\n+\n+def get_number_reports(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block can be replaced with a `with` statement for cleaner database connection management. This improves code readability and ensures the connection is always closed.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            WHERE phone_number = ?\n            ORDER BY created_at DESC\n        ''', (phone_number,))\n        rows = c.fetchall()\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":76,"start_side":"RIGHT","line":null,"original_line":87,"side":"RIGHT","author_association":"NONE","original_position":87,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263","pull_request_review_id":3539470675,"id":2588642263,"node_id":"PRRC_kwDOPKYCYs6aS4vX","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    conn = whoistel.setup_db_connection()\n+    try:\n+        result = whoistel.get_full_info(conn, number)\n+    finally:\n+        conn.close()","path":"webapp.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection from `whoistel.setup_db_connection()` can be managed more cleanly using a `with` statement. This ensures the connection is always closed, even if errors occur within the block, making the application more robust.\n\n```python\n    with whoistel.setup_db_connection() as conn:\n        result = whoistel.get_full_info(conn, number)\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":30,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412","pull_request_review_id":3539918426,"id":2588990412,"node_id":"PRRC_kwDOPKYCYs6aUNvM","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]","path":"webapp.py","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current phone number cleaning logic is not robust enough and can fail for common international formats like `+33 (0) ...`. The order of operations and handling of the optional `(0)` should be improved for more reliable parsing. Additionally, this logic is duplicated in `whoistel.py` and should ideally be consolidated into a shared utility function to improve maintainability.\n\n```suggestion\n    tel = raw_tel.replace('(', '').replace(')', '').replace(' ', '').replace('.', '').replace('-', '')\n    if tel.startswith('+330'):\n        tel = '0' + tel[4:]\n    elif tel.startswith('+33'):\n        tel = '0' + tel[3:]\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":23,"start_side":"RIGHT","line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427","pull_request_review_id":3539918426,"id":2588990427,"node_id":"PRRC_kwDOPKYCYs6aUNvb","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is not suitable for a production environment as it's a development server. It has security and performance limitations. For deployment, you should use a production-ready WSGI server like Gunicorn or uWSGI. It would be beneficial to add a note about this in the project's deployment documentation.","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":61,"side":"RIGHT","author_association":"NONE","original_position":61,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444","pull_request_review_id":3539918426,"id":2588990444,"node_id":"PRRC_kwDOPKYCYs6aUNvs","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : {{ result.operator.site }}</li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : {{ result.operator.mail }}</li>{% endif %}","path":"templates/result.html","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor better usability, the operator's website and email should be rendered as clickable links. This allows users to easily navigate to the operator's site or send an email.\n\n```\n                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":22,"start_side":"RIGHT","line":null,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190","pull_request_review_id":3539969783,"id":2589031190,"node_id":"PRRC_kwDOPKYCYs6aUXsW","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)","path":"webapp.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `number` variable taken from the URL is used directly without being cleaned. This can lead to inconsistent behavior. For example, a user accessing `/view/01.23.45.67.89` directly will have a different experience than if they searched for `01.23.45.67.89` from the home page (which cleans the number and redirects to `/view/0123456789`).\n\nTo ensure consistent behavior and use canonical URLs for phone numbers, I recommend cleaning the number and redirecting if the format is not standard. This improves user experience and predictability.\n\n```suggestion\ndef view_number(number):\n    cleaned_number = whoistel.clean_phone_number(number)\n    if cleaned_number != number:\n        return redirect(url_for('view_number', number=cleaned_number))\n\n    with closing(whoistel.setup_db_connection()) as conn:\n        result = whoistel.get_full_info(conn, cleaned_number)\n\n    # Get stats\n    spam_count = history_manager.get_spam_count(cleaned_number)\n\n    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":28,"start_side":"RIGHT","line":null,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":35,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215","pull_request_review_id":3539969783,"id":2589031215,"node_id":"PRRC_kwDOPKYCYs6aUXsv","diff_hunk":"@@ -0,0 +1,73 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime","path":"history_manager.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `datetime` module is imported but is not used in this file. It's good practice to remove unused imports to keep the code clean and avoid confusion.","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225","pull_request_review_id":3539969783,"id":2589031225,"node_id":"PRRC_kwDOPKYCYs6aUXs5","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing `app.run()` with Flask's built-in server is great for development, but it is not suitable for production use as it's not designed to be particularly efficient, stable, or secure. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI.\n\nIt would be beneficial to add a note about this to the project's `README.md` for future deployment.\n\nExample with Gunicorn:\n```sh\ngunicorn --bind 0.0.0.0:5000 webapp:app\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":59,"side":"RIGHT","author_association":"NONE","original_position":59,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060","pull_request_review_id":3540053018,"id":2589096060,"node_id":"PRRC_kwDOPKYCYs6aUnh8","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe log message \"Creating history database {DB_FILE}...\" is slightly misleading. The `sqlite3.connect(DB_FILE)` call itself creates the file if it doesn't exist. The `if not os.path.exists(DB_FILE)` check is redundant for file creation, and the log message implies this `if` block is responsible for creating the file, which isn't entirely accurate. It would be clearer to log *after* the table creation, or rephrase the message to indicate that the database *schema* is being initialized.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":15,"start_side":"RIGHT","line":null,"original_line":16,"side":"RIGHT","author_association":"NONE","original_position":16,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072","pull_request_review_id":3540053018,"id":2589096072,"node_id":"PRRC_kwDOPKYCYs6aUniI","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `report_date` column is defined as `TEXT`. While SQLite is flexible, using a `DATE` or `DATETIME` affinity for date columns is generally recommended. This allows for better data integrity, easier date-based queries, and clearer intent. You would then convert Python `datetime` objects to and from ISO 8601 strings when interacting with the database.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":24,"side":"RIGHT","author_association":"NONE","original_position":24,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955","pull_request_review_id":3540093876,"id":2589127955,"node_id":"PRRC_kwDOPKYCYs6aUvUT","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')","path":"webapp.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe phone number received from the form is not cleaned before being stored in the database. A user could submit a 'dirty' number (e.g., with dots or spaces) via a tampered POST request. This would store the uncleaned number in the history database, leading to data inconsistencies. When `get_spam_count` is later called with a cleaned number, it won't find the report, resulting in an incorrect spam count. To ensure data integrity, you should always clean the phone number upon receiving it from user input.\n\n```suggestion\n    number = whoistel.clean_phone_number(request.form.get('number'))\n```","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002","pull_request_review_id":3540093876,"id":2589128002,"node_id":"PRRC_kwDOPKYCYs6aUvVC","diff_hunk":"@@ -0,0 +1,34 @@\n+import pytest\n+import os\n+import subprocess\n+\n+def get_project_root():\n+    \"\"\"Returns the root directory of the project.\"\"\"\n+    return os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))\n+\n+@pytest.fixture(scope=\"session\", autouse=True)\n+def setup_database():\n+    \"\"\"\n+    Ensures the database is generated before tests run.\n+    \"\"\"\n+    root_dir = get_project_root()\n+    update_script_path = os.path.join(root_dir, \"updatearcep.sh\")\n+    db_path = os.path.join(root_dir, \"whoistel.sqlite3\")\n+\n+    if not os.path.exists(db_path):\n+        print(\"\\nDatabase not found. Running updatearcep.sh to generate it...\")\n+        # Check if we can run it (permissions)\n+        subprocess.run([\"chmod\", \"+x\", update_script_path], check=True, cwd=root_dir)\n+        try:\n+            subprocess.run(\n+                [\"./updatearcep.sh\"], # Executing directly since we chmodded it\n+                capture_output=True, text=True, check=True, cwd=root_dir\n+            )\n+        except subprocess.CalledProcessError as e:\n+            # Print stderr for debugging\n+            print(f\"Update Script Output: {e.stdout}\")\n+            print(f\"Update Script Error: {e.stderr}\")\n+            pytest.fail(f\"Database generation failed: {e.stderr}\")\n+\n+    if not os.path.exists(db_path):\n+         pytest.fail(\"Database whoistel.sqlite3 could not be generated.\")","path":"tests/conftest.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis check for `db_path` existence is redundant. The `if` block starting at line 18 already handles the case where the database doesn't exist. If the database generation script succeeds, the file will exist. If it fails, `pytest.fail()` is called on line 31, making this code unreachable. You can safely remove these two lines to improve clarity.","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018","pull_request_review_id":3540093876,"id":2589128018,"node_id":"PRRC_kwDOPKYCYs6aUvVS","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `README.md` file correctly instructs users to run `python3 webapp.py` for development. For a better development experience, the Flask development server should be run with `debug=True`. This enables the interactive debugger on error pages and the automatic reloader when code changes are saved. The current `debug=False` is safer but less convenient for development.\n\n```suggestion\n    app.run(debug=True, host='0.0.0.0', port=5000)\n```","created_at":"2025-12-04T13:39:26Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":63,"side":"RIGHT","author_association":"NONE","original_position":63,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486","pull_request_review_id":3540174717,"id":2589191486,"node_id":"PRRC_kwDOPKYCYs6aU-0-","diff_hunk":"@@ -0,0 +1,71 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+\n+def get_spam_count(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+\n+def get_recent_reports(limit=50):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+\n+def get_number_reports(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]","path":"history_manager.py","commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function `get_number_reports` is defined but does not appear to be used anywhere in the application. To improve maintainability and reduce clutter, it's best to remove unused code.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":62,"start_side":"RIGHT","line":null,"original_line":71,"side":"RIGHT","author_association":"NONE","original_position":71,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491","pull_request_review_id":3540174717,"id":2589191491,"node_id":"PRRC_kwDOPKYCYs6aU-1D","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis endpoint is vulnerable to Cross-Site Request Forgery (CSRF). A malicious website could create a form that posts to this URL, causing a user to unknowingly submit a spam report. While the impact here is relatively low, it's a security best practice to protect all state-changing endpoints. You can implement CSRF protection using a library like `Flask-WTF`, which integrates well with Flask.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":107,"original_start_line":41,"start_side":"RIGHT","line":108,"original_line":42,"side":"RIGHT","author_association":"NONE","original_position":42,"position":108,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499","pull_request_review_id":3540174717,"id":2589191499,"node_id":"PRRC_kwDOPKYCYs6aU-1L","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current logic only checks if the `date` field is empty. It doesn't validate the format of a provided date. A user could submit a malformed string (e.g., 'invalid-date'), which would be saved to the database, potentially causing data integrity issues. It's better to validate the date format and fall back to today's date if it's invalid.\n\n```suggestion\n    try:\n        # This will raise an error for None, empty, or malformed strings\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        date = datetime.now().strftime('%Y-%m-%d')\n```","created_at":"2025-12-04T13:56:59Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":50,"start_side":"RIGHT","line":null,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827","pull_request_review_id":3540228605,"id":2589235827,"node_id":"PRRC_kwDOPKYCYs6aVJpz","diff_hunk":"@@ -0,0 +1,66 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}","path":"templates/result.html","commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThere is a potential Cross-Site Scripting (XSS) vulnerability here. The `result.operator.site` and `result.operator.mail` values are taken from the database (which is populated from an external CSV) and placed directly into `href` attributes. If a malicious value like `javascript:alert('XSS')` is present in the database, it will be executed in the user's browser. While the data source is likely trusted, it's a security best practice to validate all external data. You should validate that the `site` is a valid HTTP/HTTPS URL and that `mail` is a valid email address in your Python backend (e.g., within the new `get_full_info` function in `whoistel.py`) before passing it to the template.","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235827","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235827"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235827/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":22,"start_side":"RIGHT","line":null,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835","pull_request_review_id":3540228605,"id":2589235835,"node_id":"PRRC_kwDOPKYCYs6aVJp7","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing a hardcoded, predictable default for `SECRET_KEY` is a security risk. If the `SECRET_KEY` environment variable is not set, the application falls back to 'dev-key-change-me'. An attacker could use this default key to forge session cookies and CSRF tokens. It's much safer to remove the default fallback. The suggested change will cause the application to fail on startup if the `SECRET_KEY` is not set, which is a secure 'fail-fast' approach for production environments. For local development, you can set this variable in your shell or a `.flaskenv` file.\n\n```suggestion\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235835","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235835"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235835/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846","pull_request_review_id":3540228605,"id":2589235846,"node_id":"PRRC_kwDOPKYCYs6aVJqG","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+    try:\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except ValueError:\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe date validation logic can be simplified. You currently check if the date is empty and then separately use a `try-except` block. You can combine these checks into a single `try-except` block that handles both `None` values (which would raise a `TypeError`) and invalid date formats (which would raise a `ValueError`).\n\n```suggestion\n    try:\n        # This will fail for None, empty string, or bad format\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        date = datetime.now().strftime('%Y-%m-%d')\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235846","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235846"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235846/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":54,"start_side":"RIGHT","line":null,"original_line":59,"side":"RIGHT","author_association":"NONE","original_position":59,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857","pull_request_review_id":3540228605,"id":2589235857,"node_id":"PRRC_kwDOPKYCYs6aVJqR","diff_hunk":"@@ -0,0 +1,72 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-key-change-me')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+    try:\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except ValueError:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor local development, it's standard practice to run the Flask development server with debug mode enabled (`debug=True`). This provides helpful features like an interactive debugger and automatic reloading on code changes. The README instructs users to run `python3 webapp.py` for local development, but with `debug=False`, the development experience is suboptimal. It's better to enable debug mode when the script is run directly. Using `host='127.0.0.1'` is also safer for a local development server.\n\n```suggestion\n    app.run(debug=True, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-04T14:09:08Z","updated_at":"2025-12-04T14:09:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235857","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589235857"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589235857/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":72,"side":"RIGHT","author_association":"NONE","original_position":72,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859","pull_request_review_id":3540291608,"id":2589287859,"node_id":"PRRC_kwDOPKYCYs6aVWWz","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe application will crash with a `RuntimeError` if the `SECRET_KEY` environment variable is not set. While this fail-fast behavior is good, providing a more explicit and user-friendly error message would improve the developer experience when setting up the application.\n\n```suggestion\nSECRET_KEY = os.environ.get('SECRET_KEY')\nif not SECRET_KEY:\n    raise ValueError(\"SECRET_KEY is not set in the environment. It is required for CSRF protection.\")\napp.config['SECRET_KEY'] = SECRET_KEY\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287859","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287859"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287859/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":10,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":10,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872","pull_request_review_id":3540291608,"id":2589287872,"node_id":"PRRC_kwDOPKYCYs6aVWXA","diff_hunk":"@@ -32,12 +54,21 @@ def get_operator_info(conn, code_operateur):\n     cursor.execute(\"SELECT NomOperateur, TypeOperateur, MailOperateur, SiteOperateur FROM Operateurs WHERE CodeOperateur=?\", (code_operateur,))\n     row = cursor.fetchone()\n     if row:\n+        mail = row[2]\n+        site = row[3]\n+\n+        # Simple validation to prevent XSS\n+        if mail and '@' not in mail:\n+            mail = None","path":"whoistel.py","commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current email validation is too permissive and only checks for the presence of an `@` symbol. A malicious string containing HTML/script tags (e.g., `\"><script>alert(1)</script>@example.com`) would pass this check. While Jinja2's auto-escaping provides protection in the template, it's a security best practice to perform stricter validation at the data-handling layer. A simple way to improve this without new dependencies is to disallow characters commonly used in injection attacks, such as `<` and `>`.\n\n```suggestion\n        if mail and ('@' not in mail or '<' in mail or '>' in mail):\n            mail = None\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287872","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287872"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":61,"start_side":"RIGHT","line":null,"original_line":62,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881","pull_request_review_id":3540291608,"id":2589287881,"node_id":"PRRC_kwDOPKYCYs6aVWXJ","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"d8f3662b4549abca294655c2cf20167bbf8e12eb","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe UI labels the date field as optional, but the current logic saves today's date if the field is empty or the format is invalid. This can be misleading as it records a date even when none was provided. It's better to store `NULL` in the database if no valid date is provided, to truly make the field optional.\n\n```suggestion\n    try:\n        # This will fail for None, empty string, or bad format\n        if date:\n            datetime.strptime(date, '%Y-%m-%d')\n        else:\n            date = None\n    except (ValueError, TypeError):\n        date = None\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287881","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287881"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287881/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":53,"start_side":"RIGHT","line":null,"original_line":57,"side":"RIGHT","author_association":"NONE","original_position":57,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884","pull_request_review_id":3540291608,"id":2589287884,"node_id":"PRRC_kwDOPKYCYs6aVWXM","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"e18a7ec9220e9c90b420804ecf3ab3823fd24093","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nRunning the development server with `debug=False` is inconvenient for local development as it disables features like the interactive debugger and auto-reloader. Since the README already warns against using this server in production, it's safe and conventional to enable debug mode for the `if __name__ == '__main__':` block to improve the developer experience.\n\n```suggestion\n    app.run(debug=True, host='0.0.0.0', port=5000)\n```","created_at":"2025-12-04T14:22:47Z","updated_at":"2025-12-04T14:22:47Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287884","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589287884"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589287884/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":70,"side":"RIGHT","author_association":"NONE","original_position":70,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680","pull_request_review_id":3540602812,"id":2589539680,"node_id":"PRRC_kwDOPKYCYs6aWT1g","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"fb88918d7f0445c87dbc4e8abda5d0cb9578282a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe application should fail fast at startup if the `SECRET_KEY` is not configured. Relying on Flask-WTF to raise an exception later is not ideal for production environments. An explicit check provides a clearer error message and prevents the app from starting in an insecure or non-functional state.\n\n```suggestion\napp.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\nif not app.config['SECRET_KEY']:\n    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n```","created_at":"2025-12-04T15:29:41Z","updated_at":"2025-12-04T15:29:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539680","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539680"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539680/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":10,"original_line":10,"side":"RIGHT","author_association":"NONE","original_position":10,"position":10,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700","pull_request_review_id":3540602812,"id":2589539700,"node_id":"PRRC_kwDOPKYCYs6aWT10","diff_hunk":"@@ -0,0 +1,70 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This will fail for None, empty string, or bad format\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"d8f3662b4549abca294655c2cf20167bbf8e12eb","original_commit_id":"fb88918d7f0445c87dbc4e8abda5d0cb9578282a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current logic for handling the optional `date` field is incorrect. If the user leaves the date field empty, it should be stored as `NULL` in the database, but this code incorrectly defaults to the current date. This misrepresents the user's input for an optional field.\n\nThe logic should be to set the date to `None` if the input is empty or has an invalid format, so it gets stored as `NULL`.\n\nAdditionally, the test `test_report_empty_date` in `tests/test_webapp.py` should be updated to assert that an empty date input results in a `NULL`/empty date in the history view, which would have caught this bug.\n\n```suggestion\n    if not date:\n        date = None\n    else:\n        try:\n            datetime.strptime(date, '%Y-%m-%d')\n        except ValueError:\n            # Invalid format from user, store as NULL\n            date = None\n```","created_at":"2025-12-04T15:29:41Z","updated_at":"2025-12-04T15:29:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539700","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589539700"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589539700/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":53,"start_side":"RIGHT","line":null,"original_line":57,"side":"RIGHT","author_association":"NONE","original_position":57,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573","pull_request_review_id":3542546750,"id":2590932573,"node_id":"PRRC_kwDOPKYCYs6abn5d","diff_hunk":"@@ -0,0 +1,75 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)","path":"webapp.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe call to `whoistel.setup_db_connection()` is a critical risk in a web application. This function calls `sys.exit(1)` upon database connection errors, which will terminate the web server's worker process, potentially bringing down the entire application for all users. A web application should never exit; it should handle errors gracefully and return an appropriate HTTP error response (e.g., 500 Internal Server Error).\n\nI strongly recommend refactoring `whoistel.setup_db_connection()` to raise a custom exception instead of calling `sys.exit()`. The web app can then catch this exception (e.g., using an `@app.errorhandler`) to log the issue and return a user-friendly error page, ensuring the server remains operational.\n\n**Example Refactoring:**\n\nIn `whoistel.py`:\n```python\nclass DatabaseError(Exception):\n    pass\n\ndef setup_db_connection():\n    if not os.path.exists(DB_FILE):\n        msg = f\"Erreur: La base de données '{DB_FILE}' est absente.\"\n        raise DatabaseError(msg)\n    # ... similar change for other error conditions\n\n# In the CLI's main() function:\ntry:\n    conn = setup_db_connection()\n    # ...\nexcept DatabaseError:\n    sys.exit(1) # Preserves CLI behavior\n```\n\nIn `webapp.py`, you could then add an error handler:\n```python\n@app.errorhandler(whoistel.DatabaseError)\ndef handle_db_error(e):\n    app.logger.error(f\"Database error: {e}\")\n    return render_template('error.html', message=\"Database error occurred\"), 500\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932573","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932573"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":40,"side":"RIGHT","author_association":"NONE","original_position":40,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577","pull_request_review_id":3542546750,"id":2590932577,"node_id":"PRRC_kwDOPKYCYs6abn5h","diff_hunk":"@@ -0,0 +1,75 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    if not date:\n+        date = None\n+    else:\n+        try:\n+            datetime.strptime(date, '%Y-%m-%d')\n+        except ValueError:\n+            # Invalid format from user, store as NULL\n+            date = None","path":"webapp.py","commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe logic for validating the date string is correct but can be made more concise and Pythonic. The `if not date:` check is redundant, as `datetime.strptime` will raise a `ValueError` for an empty string, which is already handled in your `except` block. You can simplify this entire block into a single `try...except` statement.\n\n```python\n    try:\n        # This validates the date format. It will fail for invalid formats,\n        # empty strings, or if the date is not provided (None).\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        # If validation fails, store as NULL in the database.\n        date = None\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932577","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932577"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":55,"start_side":"RIGHT","line":null,"original_line":62,"side":"RIGHT","author_association":"NONE","original_position":62,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581","pull_request_review_id":3542546750,"id":2590932581,"node_id":"PRRC_kwDOPKYCYs6abn5l","diff_hunk":"@@ -12,6 +12,28 @@\n \n DB_FILE = 'whoistel.sqlite3'\n \n+REGION_MAP = {\n+    '01': 'Île-de-France',\n+    '02': 'Nord-Ouest',\n+    '03': 'Nord-Est',\n+    '04': 'Sud-Est',\n+    '05': 'Sud-Ouest'\n+}\n+\n+def clean_phone_number(raw_tel):\n+    if not raw_tel:\n+        return \"\"\n+    # Remove separators and parenthesis\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '').replace('(', '').replace(')', '')","path":"whoistel.py","commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing multiple chained `replace()` calls can be less efficient and harder to read than a single, declarative approach. You can achieve the same result more cleanly using a regular expression.\n\nDon't forget to add `import re` at the top of the file.\n\n```suggestion\n    tel = re.sub(r'[ .()-]', '', raw_tel)\n```","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932581","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932581"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932581/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":16,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593","pull_request_review_id":3542546750,"id":2590932593,"node_id":"PRRC_kwDOPKYCYs6abn5x","diff_hunk":"@@ -147,8 +222,8 @@ def print_result(conn, tel, info):\n             '05': 'Sud-Ouest'\n         }\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            print(f\"\\nLocalisation : Région {REGION_MAP[region_code]} (Détail commune non disponible)\")","path":"whoistel.py","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"117bed045d62b92ca759bd7c4a3aec5a5fff4ef2","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nWith this change to use the global `REGION_MAP` constant, the local `region_map` variable defined on lines 217-223 is now unused. It should be removed to improve code clarity and avoid confusion.","created_at":"2025-12-04T23:29:48Z","updated_at":"2025-12-04T23:29:48Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932593","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2590932593"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2590932593/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":225,"start_side":"RIGHT","line":null,"original_line":226,"side":"RIGHT","author_association":"NONE","original_position":111,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198","pull_request_review_id":3542654614,"id":2591023198,"node_id":"PRRC_kwDOPKYCYs6ab-Be","diff_hunk":"@@ -0,0 +1,60 @@\n+import sqlite3\n+import os","path":"history_manager.py","commit_id":"f737056296de126669f76660e5a0c633c07516e6","original_commit_id":"f737056296de126669f76660e5a0c633c07516e6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `os` module is imported but never used in this file. It's good practice to remove unused imports to keep the code clean and reduce the module's memory footprint.","created_at":"2025-12-05T00:27:53Z","updated_at":"2025-12-05T00:27:53Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023198","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023198"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023198/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":2,"side":"RIGHT","author_association":"NONE","original_position":2,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202","pull_request_review_id":3542654614,"id":2591023202,"node_id":"PRRC_kwDOPKYCYs6ab-Bi","diff_hunk":"@@ -20,3 +21,8 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.log\n+*.png\n+verification/","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"f737056296de126669f76660e5a0c633c07516e6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe files `test_output.txt` and `test_output_2.txt` have been added to this pull request. These appear to be test run artifacts that should not be committed to the repository. Please add a pattern for them to `.gitignore` to prevent this in the future, and remove the files from this PR.\n\n```\nverification/\ntest_output*.txt\n```","created_at":"2025-12-05T00:27:53Z","updated_at":"2025-12-05T00:27:53Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023202","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591023202"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591023202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":34,"original_line":28,"side":"RIGHT","author_association":"NONE","original_position":16,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870","pull_request_review_id":3542673196,"id":2591038870,"node_id":"PRRC_kwDOPKYCYs6acB2W","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe phone number being reported is taken from a hidden form field. This means a user could manipulate the POST request to submit a spam report for any phone number, not just the one displayed on the page. This could lead to pollution of the history database with false reports.\n\nTo make this more secure, you could consider tying the report to the number in the URL, for example by changing the route to `/view/<number>/report`. While the user can still change the URL, it makes the intent clearer. A more robust solution would involve using the server-side session to verify that the reported number matches the one the user was viewing.","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038870","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038870"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038870/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":110,"original_line":55,"side":"RIGHT","author_association":"NONE","original_position":55,"position":110,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872","pull_request_review_id":3542673196,"id":2591038872,"node_id":"PRRC_kwDOPKYCYs6acB2Y","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor security, it's better to bind the development server to `127.0.0.1` (localhost) by default instead of `0.0.0.0`. This restricts access to your local machine. If you need to access it from other devices on your network during development, you can still do so by explicitly changing it, but `localhost` is a safer default.\n\n```suggestion\n    app.run(debug=False, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038872","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038872"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038872/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":79,"side":"RIGHT","author_association":"NONE","original_position":79,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874","pull_request_review_id":3542673196,"id":2591038874,"node_id":"PRRC_kwDOPKYCYs6acB2a","diff_hunk":"@@ -32,12 +59,21 @@ def get_operator_info(conn, code_operateur):\n     cursor.execute(\"SELECT NomOperateur, TypeOperateur, MailOperateur, SiteOperateur FROM Operateurs WHERE CodeOperateur=?\", (code_operateur,))\n     row = cursor.fetchone()\n     if row:\n+        mail = row[2]\n+        site = row[3]\n+\n+        # Simple validation to prevent XSS\n+        if mail and ('@' not in mail or '<' in mail or '>' in mail):\n+            mail = None\n+        if site and not (site.startswith('http://') or site.startswith('https://')):\n+            site = None","path":"whoistel.py","commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","original_commit_id":"755d42b24022ae48bb3c9b4b5800b7e56b9c80f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe validation for email and site URLs is a good security measure against XSS. However, the current implementation using simple string checks is a bit basic and could potentially be bypassed or reject valid inputs. For more robust validation, consider using specialized libraries:\n\n*   **Email:** The `email-validator` library provides comprehensive email syntax and deliverability checks.\n*   **URL:** Python's `urllib.parse` can be used to properly parse and validate URL structures.\n\nWhile Jinja2's auto-escaping offers strong protection, adopting a defense-in-depth strategy by strengthening validation at the data-source level is recommended.","created_at":"2025-12-05T00:38:59Z","updated_at":"2025-12-05T00:39:00Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038874","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591038874"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591038874/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":65,"start_side":"RIGHT","line":null,"original_line":69,"side":"RIGHT","author_association":"NONE","original_position":68,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029","pull_request_review_id":3542683656,"id":2591048029,"node_id":"PRRC_kwDOPKYCYs6acEFd","diff_hunk":"@@ -0,0 +1,59 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'","path":"history_manager.py","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database file path is hardcoded. This makes it difficult to configure for different environments (e.g., development, testing, production) without monkey-patching the variable, as done in the tests. It's better to make it configurable via an environment variable, similar to how `SECRET_KEY` is handled in `webapp.py`.\n\n```suggestion\nimport sqlite3\nimport logging\nfrom contextlib import closing\nimport os\n\nDB_FILE = os.environ.get('HISTORY_DB_PATH', 'history.sqlite3')\n```","created_at":"2025-12-05T00:45:49Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048029","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048029"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048029/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":5,"side":"RIGHT","author_association":"NONE","original_position":5,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037","pull_request_review_id":3542683656,"id":2591048037,"node_id":"PRRC_kwDOPKYCYs6acEFl","diff_hunk":"@@ -0,0 +1,66 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n+            </ul>\n+        {% endif %}\n+\n+        {% if result.location %}\n+            <h4>Localisation</h4>\n+            <ul>\n+                {% if result.location.commune %}\n+                    <li><strong>Commune :</strong> {{ result.location.commune }} ({{ result.location.code_postal }})</li>\n+                    <li><strong>Département :</strong> {{ result.location.departement }}</li>\n+                {% elif result.location.region %}\n+                    <li><strong>Région :</strong> {{ result.location.region }}</li>\n+                {% endif %}\n+            </ul>\n+        {% endif %}\n+    </div>\n+{% endif %}\n+\n+<div class=\"result-box community\">\n+    <h3>Statistiques Communautaires</h3>\n+    <p>Ce numéro a été signalé comme spam <strong>{{ spam_count }}</strong> fois.</p>\n+</div>\n+\n+<h3>Ajouter un signalement / note</h3>\n+<form action=\"{{ url_for('report') }}\" method=\"post\">\n+    <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token() }}\">\n+    <input type=\"hidden\" name=\"number\" value=\"{{ number }}\">\n+\n+    <label for=\"date\">Date de l'appel (optionnel) :</label>\n+    <input type=\"date\" name=\"date\" id=\"date\">\n+\n+    <label>\n+        <input type=\"checkbox\" name=\"is_spam\"> Signaler comme Spam / Démarchage\n+    </label>\n+    <br><br>\n+\n+    <label for=\"comment\">Commentaire (optionnel) :</label><br>\n+    <textarea name=\"comment\" id=\"comment\" rows=\"3\"></textarea>","path":"templates/result.html","commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nTo provide immediate feedback to the user and prevent submission of overly long comments, you should add a `maxlength` attribute to this `textarea`. This complements the backend validation.\n\n```\n    <textarea name=\"comment\" id=\"comment\" rows=\"3\" maxlength=\"1024\"></textarea>\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048037","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048037"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048037/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":60,"side":"RIGHT","author_association":"NONE","original_position":60,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038","pull_request_review_id":3542683656,"id":2591048038,"node_id":"PRRC_kwDOPKYCYs6acEFm","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')","path":"webapp.py","commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `comment` field is taken directly from the form without any length validation. A malicious user could submit a very large comment, potentially leading to performance issues or storage abuse. It's good practice to enforce a reasonable length limit on user-submitted text fields. This change will truncate the comment on the backend. A corresponding frontend change is also recommended.\n\n```suggestion\n    comment = (request.form.get('comment') or '')[:1024]\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048038","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048038"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048038/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":58,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041","pull_request_review_id":3542683656,"id":2591048041,"node_id":"PRRC_kwDOPKYCYs6acEFp","diff_hunk":"@@ -5,24 +5,53 @@\n import sys\n import os\n import logging\n+import re\n+from urllib.parse import urlparse\n+from email_validator import validate_email, EmailNotValidError\n+\n+class DatabaseError(Exception):\n+    pass\n \n # Configure logging\n logging.basicConfig(level=logging.INFO, format='%(message)s') # Simplified format for CLI\n logger = logging.getLogger(__name__)\n \n DB_FILE = 'whoistel.sqlite3'\n \n+REGION_MAP = {\n+    '01': 'Île-de-France',\n+    '02': 'Nord-Ouest',\n+    '03': 'Nord-Est',\n+    '04': 'Sud-Est',\n+    '05': 'Sud-Ouest'\n+}\n+\n+def clean_phone_number(raw_tel):\n+    if not raw_tel:\n+        return \"\"\n+    # Remove separators and parenthesis\n+    tel = re.sub(r'[ .\\-()]', '', raw_tel)","path":"whoistel.py","commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","original_commit_id":"186b1e7d5bba19f1aa2144ae18ad8d9e39398f7b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current regex `[ .\\-()]` only removes spaces, dots, hyphens, and parentheses. It would be more robust to also handle other whitespace characters like tabs or non-breaking spaces, which can sometimes be pasted into form fields. Using `\\s` in the character class will achieve this.\n\n```suggestion\n    tel = re.sub(r'[\\s.\\-()]', '', raw_tel)\n```","created_at":"2025-12-05T00:45:50Z","updated_at":"2025-12-05T00:45:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048041","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591048041"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591048041/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":33,"side":"RIGHT","author_association":"NONE","original_position":29,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571","pull_request_review_id":3542701855,"id":2591064571,"node_id":"PRRC_kwDOPKYCYs6acIH7","diff_hunk":"@@ -0,0 +1,104 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('history_manager.add_report') as mock_add_report:","path":"tests/test_webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis test is failing, as indicated in `test_result.txt`, due to an incorrect `patch` target. When mocking, you should target the name where the object is *looked up*, not where it is defined. The `report` function in `webapp.py` calls `history_manager.add_report`, so you need to patch `add_report` within the `webapp` module's namespace.\n\n```suggestion\n    with patch('webapp.history_manager.add_report') as mock_add_report:\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064571","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064571"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064571/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":102,"original_line":95,"side":"RIGHT","author_association":"NONE","original_position":95,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577","pull_request_review_id":3542701855,"id":2591064577,"node_id":"PRRC_kwDOPKYCYs6acIIB","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)","path":"webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIn this route, a new database connection to `whoistel.sqlite3` is opened, and the call to `history_manager.get_spam_count()` opens another connection to `history.sqlite3`. This pattern of opening new connections for each operation is inefficient and will not scale well. A better practice in Flask is to manage database connections on a per-request basis using the application context (`g`). This allows connection reuse within a single request, which significantly improves performance by reducing connection setup/teardown overhead.\n\nHere is an example of how you could implement this:\n\n```python\n# In webapp.py\nfrom flask import g\n\ndef get_whois_db():\n    if 'whois_db' not in g:\n        g.whois_db = whoistel.setup_db_connection()\n    return g.whois_db\n\n@app.teardown_appcontext\ndef close_db(e=None):\n    db = g.pop('whois_db', None)\n    if db is not None:\n        db.close()\n    # ... and so on for the history_db\n\n# Then in your view function:\nconn = get_whois_db()\nresult = whoistel.get_full_info(conn, cleaned_number)\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064577","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064577"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579","pull_request_review_id":3542701855,"id":2591064579,"node_id":"PRRC_kwDOPKYCYs6acIID","diff_hunk":"@@ -0,0 +1,79 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:1024]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current settings for the development server are not ideal for local development and could pose a minor security risk.\n\n- `debug=False` disables the interactive debugger and auto-reloader, which are very helpful during development.\n- `host='0.0.0.0'` exposes the development server to your local network, which is not always desirable or safe. It's better to default to `'127.0.0.1'` (localhost) for development.\n\nSince the `README.md` already provides excellent guidance for production deployment, this change would improve the local development experience without affecting production.\n\n```suggestion\n    app.run(debug=True, host='127.0.0.1', port=5000)\n```","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064579","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064579"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064579/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":79,"side":"RIGHT","author_association":"NONE","original_position":79,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582","pull_request_review_id":3542701855,"id":2591064582,"node_id":"PRRC_kwDOPKYCYs6acIIG","diff_hunk":"@@ -0,0 +1,59 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()","path":"history_manager.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nEach function in this module (`add_report`, `get_spam_count`, etc.) opens and closes its own database connection. This is inefficient for a web application due to the overhead of creating connections for every call. For better performance, these functions should accept a database connection object as an argument, allowing the calling application (Flask) to manage the connection lifecycle (e.g., one connection per request). I've left a related comment in `webapp.py` with a suggested implementation pattern.","created_at":"2025-12-05T00:57:45Z","updated_at":"2025-12-05T00:57:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064582","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2591064582"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2591064582/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":37,"side":"RIGHT","author_association":"NONE","original_position":37,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692","pull_request_review_id":3544030716,"id":2592137692,"node_id":"PRRC_kwDOPKYCYs6agOHc","diff_hunk":"@@ -0,0 +1,80 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe application handles an empty phone number submission by silently redirecting to the index page. While the HTML form includes a `required` attribute, client-side validation can be bypassed. For a more robust user experience, it's better to provide explicit server-side feedback. You could use Flask's flash messaging system to display an error message to the user explaining why their submission was not processed.","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137692","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137692"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137692/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":70,"original_start_line":24,"start_side":"RIGHT","line":73,"original_line":26,"side":"RIGHT","author_association":"NONE","original_position":26,"position":73,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699","pull_request_review_id":3544030716,"id":2592137699,"node_id":"PRRC_kwDOPKYCYs6agOHj","diff_hunk":"@@ -0,0 +1,80 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)","path":"webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis endpoint opens two separate database connections on each request: one to `whoistel.sqlite3` via `whoistel.setup_db_connection()` and another to `history.sqlite3` inside `history_manager.get_spam_count()`. This is inefficient and can lead to performance issues under load. A better practice is to manage database connections at the application level, for example, by using Flask's application context (`g` object) to open connections once per request and reuse them across function calls. This would improve performance and centralize connection management.","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137699","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137699"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137699/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":39,"start_side":"RIGHT","line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701","pull_request_review_id":3544030716,"id":2592137701,"node_id":"PRRC_kwDOPKYCYs6agOHl","diff_hunk":"@@ -0,0 +1,123 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('history_manager.add_report') as mock_add_report:","path":"tests/test_webapp.py","commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","original_commit_id":"f21f2c64660923c0c255e44bbdce4c7343881a6b","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe patch target for `add_report` is incorrect, which causes this test to fail as seen in the test logs. When patching, you should target where the object is *looked up*, not where it is defined. Since `webapp.py` imports `history_manager` and calls `history_manager.add_report`, the correct patch target is `webapp.history_manager.add_report`.\n\n```suggestion\n    with patch('webapp.history_manager.add_report') as mock_add_report:\n```","created_at":"2025-12-05T10:14:41Z","updated_at":"2025-12-05T10:14:42Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137701","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592137701"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592137701/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":102,"original_line":95,"side":"RIGHT","author_association":"NONE","original_position":95,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628","pull_request_review_id":3544119069,"id":2592202628,"node_id":"PRRC_kwDOPKYCYs6agd-E","diff_hunk":"@@ -9,6 +9,8 @@ venv/\n \n # Database\n whoistel.sqlite3\n+history.sqlite3\n+test_output*.txt","path":".gitignore","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe pull request adds several generated files and local development artifacts to the repository (e.g., `analysis.txt`, `test_result.txt`, `pr_comments*.txt`). These files should not be committed to version control to keep the repository clean. Please remove them and update `.gitignore` to prevent them from being accidentally committed in the future.\n\nThe script `analyze_comments.py` also seems like a temporary utility and should likely be removed as well.\n\n```\nwhoistel.sqlite3\nhistory.sqlite3\ntest_output*.txt\ntest_result.txt\nanalysis*.txt\npr_comments*.txt\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202628","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202628"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202628/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":11,"start_side":"RIGHT","line":null,"original_line":13,"side":"RIGHT","author_association":"NONE","original_position":5,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631","pull_request_review_id":3544119069,"id":2592202631,"node_id":"PRRC_kwDOPKYCYs6agd-H","diff_hunk":"@@ -0,0 +1,67 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            add_report(phone_number, report_date, is_spam, comment, conn)\n+\n+def get_spam_count(phone_number, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            return get_spam_count(phone_number, conn)\n+\n+def get_recent_reports(limit=50, conn=None):\n+    if conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]\n+    else:\n+        with closing(get_db_connection()) as conn:\n+            return get_recent_reports(limit, conn)","path":"history_manager.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe functions `add_report`, `get_spam_count`, and `get_recent_reports` all contain repetitive boilerplate code for handling database connections. This pattern of checking for a `conn` argument and otherwise creating a new connection can be simplified and made more maintainable by using a decorator. This would reduce code duplication and centralize the connection management logic.\n\nHere is an example of how you could implement this:\n\n```python\nfrom functools import wraps\nfrom contextlib import closing\n\ndef with_db_connection(func):\n    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        conn = kwargs.get('conn')\n        if conn:\n            return func(*args, **kwargs)\n        else:\n            with closing(get_db_connection()) as new_conn:\n                kwargs['conn'] = new_conn\n                return func(*args, **kwargs)\n    return wrapper\n\n@with_db_connection\ndef add_report(phone_number, report_date, is_spam, comment, conn=None):\n    c = conn.cursor()\n    c.execute('''\n        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n        VALUES (?, ?, ?, ?)\n    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n    conn.commit()\n\n# You can then apply @with_db_connection to the other functions.\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202631","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202631"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202631/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":30,"start_side":"RIGHT","line":null,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633","pull_request_review_id":3544119069,"id":2592202633,"node_id":"PRRC_kwDOPKYCYs6agd-J","diff_hunk":"@@ -0,0 +1,94 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+@app.teardown_appcontext\n+def close_history_db(error):\n+    db = g.pop('history_db', None)\n+    if db is not None:\n+        db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)","path":"webapp.py","commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","original_commit_id":"e5fd708374eaa37b8360775928fe1bbab45e1273","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIn the `view_number` route, a new database connection to `whoistel.sqlite3` is opened and closed for every request. For better performance and consistency with how the history database connection is handled, you should manage the main database connection using Flask's application context (`g` object). This will reuse the connection for the duration of the request, avoiding the overhead of establishing a new connection each time.\n\nYou can achieve this by adding functions to get and close the main DB connection and updating the teardown function, similar to what's done for the history DB:\n\n```python\ndef get_main_db():\n    if 'main_db' not in g:\n        g.main_db = whoistel.setup_db_connection()\n    return g.main_db\n\n# Replace close_history_db with a function that closes all DBs\n@app.teardown_appcontext\ndef close_dbs(error):\n    history_db = g.pop('history_db', None)\n    if history_db is not None:\n        history_db.close()\n    \n    main_db = g.pop('main_db', None)\n    if main_db is not None:\n        main_db.close()\n```\n\nThen, in your `view_number` function, you can replace the `with closing(...)` block with:\n\n```python\nconn = get_main_db()\nresult = whoistel.get_full_info(conn, cleaned_number)\n```","created_at":"2025-12-05T10:35:50Z","updated_at":"2025-12-05T10:35:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202633","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592202633"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592202633/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":51,"start_side":"RIGHT","line":null,"original_line":52,"side":"RIGHT","author_association":"NONE","original_position":52,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512","pull_request_review_id":3544181318,"id":2592251512,"node_id":"PRRC_kwDOPKYCYs6agp54","diff_hunk":"@@ -0,0 +1,121 @@\n+============================= test session starts ==============================\n+platform linux -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- /usr/bin/python3\n+cachedir: .pytest_cache\n+rootdir: /home/sheepdestroyer/LAB/whoistel\n+plugins: anyio-4.11.0\n+collecting ... collected 15 items\n+\n+tests/test_webapp.py::test_index PASSED                                  [  6%]\n+tests/test_webapp.py::test_check_number_redirect PASSED                  [ 13%]\n+tests/test_webapp.py::test_view_number_unknown PASSED                    [ 20%]\n+tests/test_webapp.py::test_report_flow PASSED                            [ 26%]\n+tests/test_webapp.py::test_check_known_missing_number PASSED             [ 33%]\n+tests/test_webapp.py::test_view_number_redirect_dirty PASSED             [ 40%]\n+tests/test_webapp.py::test_report_empty_date PASSED                      [ 46%]\n+tests/test_webapp.py::test_database_connection_error PASSED              [ 53%]\n+tests/test_webapp.py::test_report_comment_truncation FAILED              [ 60%]\n+tests/test_whoistel.py::test_geographic_number_lookup PASSED             [ 66%]\n+tests/test_whoistel.py::test_non_geographic_test_number_lookup PASSED    [ 73%]\n+tests/test_whoistel.py::test_valid_geo_number_lookup PASSED              [ 80%]\n+tests/test_whoistel.py::test_invalid_number_format_non_digit PASSED      [ 86%]\n+tests/test_whoistel.py::test_clean_phone_number PASSED                   [ 93%]\n+tests/test_whoistel.py::test_operator_info_validation PASSED             [100%]\n+\n+=================================== FAILURES ===================================\n+________________________ test_report_comment_truncation ________________________\n+\n+client = <FlaskClient <Flask 'webapp'>>\n+\n+    def test_report_comment_truncation(client):\n+        \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+        long_comment = \"a\" * 2000\n+>       with patch('whoistel.history_manager.add_report') as mock_add_report:\n+             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+tests/test_webapp.py:95: \n+_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n+/usr/lib64/python3.14/unittest/mock.py:1487: in __enter__\n+    self.target = self.getter()\n+                  ^^^^^^^^^^^^^\n+_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n+\n+name = 'whoistel.history_manager'\n+\n+    def resolve_name(name):\n+        \"\"\"\n+        Resolve a name to an object.\n+    \n+        It is expected that `name` will be a string in one of the following\n+        formats, where W is shorthand for a valid Python identifier and dot stands\n+        for a literal period in these pseudo-regexes:\n+    \n+        W(.W)*\n+        W(.W)*:(W(.W)*)?\n+    \n+        The first form is intended for backward compatibility only. It assumes that\n+        some part of the dotted name is a package, and the rest is an object\n+        somewhere within that package, possibly nested inside other objects.\n+        Because the place where the package stops and the object hierarchy starts\n+        can't be inferred by inspection, repeated attempts to import must be done\n+        with this form.\n+    \n+        In the second form, the caller makes the division point clear through the\n+        provision of a single colon: the dotted name to the left of the colon is a\n+        package to be imported, and the dotted name to the right is the object\n+        hierarchy within that package. Only one import is needed in this form. If\n+        it ends with the colon, then a module object is returned.\n+    \n+        The function will return an object (which might be a module), or raise one\n+        of the following exceptions:\n+    \n+        ValueError - if `name` isn't in a recognised format\n+        ImportError - if an import failed when it shouldn't have\n+        AttributeError - if a failure occurred when traversing the object hierarchy\n+                         within the imported package to get to the desired object.\n+        \"\"\"\n+        global _NAME_PATTERN\n+        if _NAME_PATTERN is None:\n+            # Lazy import to speedup Python startup time\n+            import re\n+            dotted_words = r'(?!\\d)(\\w+)(\\.(?!\\d)(\\w+))*'\n+            _NAME_PATTERN = re.compile(f'^(?P<pkg>{dotted_words})'\n+                                       f'(?P<cln>:(?P<obj>{dotted_words})?)?$',\n+                                       re.UNICODE)\n+    \n+        m = _NAME_PATTERN.match(name)\n+        if not m:\n+            raise ValueError(f'invalid format: {name!r}')\n+        gd = m.groupdict()\n+        if gd.get('cln'):\n+            # there is a colon - a one-step import is all that's needed\n+            mod = importlib.import_module(gd['pkg'])\n+            parts = gd.get('obj')\n+            parts = parts.split('.') if parts else []\n+        else:\n+            # no colon - have to iterate to find the package boundary\n+            parts = name.split('.')\n+            modname = parts.pop(0)\n+            # first part *must* be a module/package.\n+            mod = importlib.import_module(modname)\n+            while parts:\n+                p = parts[0]\n+                s = f'{modname}.{p}'\n+                try:\n+                    mod = importlib.import_module(s)\n+                    parts.pop(0)\n+                    modname = s\n+                except ImportError:\n+                    break\n+        # if we reach this point, mod is the module, already imported, and\n+        # parts is the list of parts in the object hierarchy to be traversed, or\n+        # an empty list if just the module is wanted.\n+        result = mod\n+        for p in parts:\n+>           result = getattr(result, p)\n+                     ^^^^^^^^^^^^^^^^^^\n+E           AttributeError: module 'whoistel' has no attribute 'history_manager'\n+\n+/usr/lib64/python3.14/pkgutil.py:473: AttributeError\n+=========================== short test summary info ============================\n+FAILED tests/test_webapp.py::test_report_comment_truncation - AttributeError:...\n+========================= 1 failed, 14 passed in 0.37s =========================","path":"test_result.txt","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file, along with other temporary analysis and comment files (`debug_analysis.txt`, `pr_comments.txt`, `pr_comments_retry.txt`, `pr_comments_retry_2.txt`), should be removed from the pull request. Committing development artifacts and test logs to the repository is not good practice as it adds noise and can be confusing for other developers. In this case, this file shows a test failure that appears to have been fixed in the submitted code, which is particularly misleading. Please remove all such temporary files from this PR and consider updating `.gitignore` to prevent them from being accidentally committed in the future.","created_at":"2025-12-05T10:51:21Z","updated_at":"2025-12-05T10:51:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251512","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251512"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":121,"side":"RIGHT","author_association":"NONE","original_position":121,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515","pull_request_review_id":3544181318,"id":2592251515,"node_id":"PRRC_kwDOPKYCYs6agp57","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import logging\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                kwargs['conn'] = new_conn\n+                return func(*args, **kwargs)\n+    return wrapper\n+\n+DB_FILE = 'history.sqlite3'","path":"history_manager.py","commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","original_commit_id":"df7f04ee671e2c9ab725b8e994d8c05cf16c4270","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe history database file path is hardcoded. This makes the application less flexible for different deployment environments or for running certain kinds of tests. It's better to make this configurable via an environment variable, with the current path as a default. This allows overriding the database path without changing the code. Remember to add `import os` at the top of the file.\n\n```suggestion\nDB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n```","created_at":"2025-12-05T10:51:21Z","updated_at":"2025-12-05T10:51:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251515","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592251515"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592251515/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":19,"side":"RIGHT","author_association":"NONE","original_position":19,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847","pull_request_review_id":3544524605,"id":2592503847,"node_id":"PRRC_kwDOPKYCYs6ahngn","diff_hunk":"@@ -0,0 +1,27 @@\n+import json\n+import sys\n+\n+try:\n+    with open('latest_comments.json', 'r') as f:\n+        comments = json.load(f)\n+\n+    # Filter for comments newer than the Cycle 7 batch (approx 10:35Z)\n+    # Using 10:40:00Z to ensure we only see completely new feedback\n+    cutoff = '2025-12-05T10:40:00Z'\n+    new_comments = [c for c in comments if c.get('created_at', '') > cutoff]\n+    \n+    print(f\"Total comments: {len(comments)}\")\n+    print(f\"New comments (Cycle 8?): {len(new_comments)}\")\n+\n+    # Sort by created_at\n+    new_comments.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n+    \n+    for c in new_comments[:10]:\n+        print(\"-\" * 40)\n+        print(f\"Date: {c.get('created_at')}\")\n+        print(f\"File: {c.get('path')}\")\n+        print(f\"Line: {c.get('line') or c.get('original_line')}\")\n+        print(f\"Body: {c.get('body')}\")\n+\n+except Exception as e:\n+    print(f\"Error: {e}\")","path":"analyze_comments.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file, along with `.antigravity/context.md`, `cycle_8_check.txt`, and `pr_comments_retry_2.txt`, appears to be a temporary development artifact or log file. Committing such files to the repository adds noise, can be confusing for other developers, and is not good practice. Please remove these files from the pull request. Consider updating `.gitignore` to prevent them from being accidentally committed in the future if they are generated.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503847","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503847"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503847/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":27,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850","pull_request_review_id":3544524605,"id":2592503850,"node_id":"PRRC_kwDOPKYCYs6ahngq","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+    <table>\n+        <thead>\n+            <tr>\n+                <th>Numéro</th>\n+                <th>Date Appel</th>\n+                <th>Spam?</th>\n+                <th>Commentaire</th>\n+                <th>Signalé le</th>\n+                <th>Action</th>\n+            </tr>\n+        </thead>\n+        <tbody>\n+            {% for report in reports %}\n+            <tr>\n+                <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+                <td>{{ report.report_date }}</td>\n+                <td class=\"{{ 'spam-alert' if report.is_spam else '' }}\">{{ 'OUI' if report.is_spam else 'NON' }}</td>\n+                <td>{{ report.comment }}</td>\n+                <td>{{ report.created_at }}</td>","path":"templates/history.html","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `created_at` timestamp is displayed directly from the database. This can result in a format that is not very user-friendly (e.g., `2023-10-27 14:30:00`). For better readability and a more polished UI, consider formatting this timestamp. This could be done in the `history` view function in `webapp.py` before passing the data to the template, or by using a Jinja filter. A format like `DD/MM/YYYY HH:MM` might be more appropriate for a French-language UI.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503850","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503850"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503850/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851","pull_request_review_id":3544524605,"id":2592503851,"node_id":"PRRC_kwDOPKYCYs6ahngr","diff_hunk":"@@ -139,16 +233,10 @@ def print_result(conn, tel, info):\n \n     # If Geo and no CodeInsee, give Region hint\n     if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            print(f\"\\nLocalisation : Région {REGION_MAP[region_code]} (Détail commune non disponible)\")","path":"whoistel.py","commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","original_commit_id":"1bcb508268217d54466af79aca6fff327c2b6d75","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis logic for determining the region is also present in the new `get_full_info` function. The `print_result` function duplicates a lot of the logic that was refactored into `get_full_info` (e.g., fetching operator details, location info). To improve maintainability and ensure the CLI output is consistent with the web UI, the `main` function should be updated to call `get_full_info`. This would allow `print_result` to be simplified into a function that just formats the rich dictionary returned by `get_full_info`, rather than re-fetching and processing data itself.","created_at":"2025-12-05T12:21:27Z","updated_at":"2025-12-05T12:21:27Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503851","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592503851"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592503851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":238,"start_side":"RIGHT","line":null,"original_line":239,"side":"RIGHT","author_association":"NONE","original_position":162,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373","pull_request_review_id":3544610557,"id":2592566373,"node_id":"PRRC_kwDOPKYCYs6ah2xl","diff_hunk":"@@ -0,0 +1,29 @@\n+import json\n+import sys\n+\n+try:\n+    with open('latest_comments_c9.json', 'r') as f:\n+        comments = json.load(f)\n+\n+    # Filter for comments newer than Cycle 8 (which was around 11:50-12:00 UTC?)\n+    # Local time is 13:20 CET -> 12:20 UTC.\n+    # Previous check was 10:40 UTC. Cycle 8 comments were 10:51 UTC.\n+    # So we want anything > 11:00 UTC.\n+    cutoff = '2025-12-05T11:00:00Z'\n+    new_comments = [c for c in comments if c.get('created_at', '') > cutoff]\n+    \n+    print(f\"Total comments: {len(comments)}\")\n+    print(f\"New comments (Cycle 8?): {len(new_comments)}\")\n+\n+    # Sort by created_at\n+    new_comments.sort(key=lambda x: x.get('created_at', ''), reverse=True)\n+    \n+    for c in new_comments[:10]:\n+        print(\"-\" * 40)\n+        print(f\"Date: {c.get('created_at')}\")\n+        print(f\"File: {c.get('path')}\")\n+        print(f\"Line: {c.get('line') or c.get('original_line')}\")\n+        print(f\"Body: {c.get('body')}\")\n+\n+except Exception as e:\n+    print(f\"Error: {e}\")","path":"analyze_comments.py","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis file appears to be a temporary script for development and debugging. It contains hardcoded, user-specific values (e.g., `'latest_comments_c9.json'`, `'2025-12-05T11:00:00Z'`) and is not part of the application's core functionality. Committing such development artifacts adds noise to the repository and can be confusing for other contributors. Please remove this file from the pull request. Such scripts should be added to `.gitignore` if they are part of a regular workflow.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566373","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566373"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566373/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":29,"side":"RIGHT","author_association":"NONE","original_position":29,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376","pull_request_review_id":3544610557,"id":2592566376,"node_id":"PRRC_kwDOPKYCYs6ah2xo","diff_hunk":"@@ -0,0 +1,23 @@\n+Total comments: 68\n+New comments (Cycle 8?): 3\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: analyze_comments.py\n+Line: 27\n+Body: ![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n+\n+This file, along with `.antigravity/context.md`, `cycle_8_check.txt`, and `pr_comments_retry_2.txt`, appears to be a temporary development artifact or log file. Committing such files to the repository adds noise, can be confusing for other developers, and is not good practice. Please remove these files from the pull request. Consider updating `.gitignore` to prevent them from being accidentally committed in the future if they are generated.\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: templates/history.html\n+Line: 25\n+Body: ![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n+\n+The `created_at` timestamp is displayed directly from the database. This can result in a format that is not very user-friendly (e.g., `2023-10-27 14:30:00`). For better readability and a more polished UI, consider formatting this timestamp. This could be done in the `history` view function in `webapp.py` before passing the data to the template, or by using a Jinja filter. A format like `DD/MM/YYYY HH:MM` might be more appropriate for a French-language UI.\n+----------------------------------------\n+Date: 2025-12-05T12:21:27Z\n+File: whoistel.py\n+Line: 239\n+Body: ![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n+\n+This logic for determining the region is also present in the new `get_full_info` function. The `print_result` function duplicates a lot of the logic that was refactored into `get_full_info` (e.g., fetching operator details, location info). To improve maintainability and ensure the CLI output is consistent with the web UI, the `main` function should be updated to call `get_full_info`. This would allow `print_result` to be simplified into a function that just formats the rich dictionary returned by `get_full_info`, rather than re-fetching and processing data itself.","path":"cycle_9_check.txt","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis text file appears to be a temporary output log from your development process. Such files should not be committed to version control as they add clutter and have no value for the production code or future development. Please remove this file from the pull request.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566376","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566376"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566376/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378","pull_request_review_id":3544610557,"id":2592566378,"node_id":"PRRC_kwDOPKYCYs6ah2xq","diff_hunk":"@@ -0,0 +1,48 @@\n+# GitHub CLI Review Cycle & Troubleshooting\n+\n+## Learned Lessons: Fetching Comments\n+During the implementation of the `whoistel` web UI, we encountered issues reliably fetching code review comments using the `gh` CLI. Here is what we learned:\n+\n+1.  **Endpoint Distinction**:\n+    *   `gh pr view {N} --json comments`: Fetches **Issue Comments** (top-level discussion). It does **NOT** fetch inline code review comments (specific to lines of code).\n+    *   `gh api repos/{owner}/{repo}/pulls/{N}/comments`: Fetches **Review Comments** (inline feedback). This is the correct endpoint for code review feedback.\n+\n+2.  **Pagination is Critical**:\n+    *   The GitHub API paginates results (default ~30 items).\n+    *   **Failure Mode**: Without pagination, we only retrieved the first page of comments (often the oldest ones). New feedback was missed because it fell on subsequent pages.\n+    *   **Solution**: Always use the `--paginate` flag with `gh api` to retrieve all comments.\n+\n+## The Correct Review Cycle Workflow\n+To successfully iterate with Gemini Code Assist (or any reviewer) using the CLI:\n+\n+### 1. Request Review\n+Trigger the bot to review your latest changes.\n+```bash\n+gh pr comment {PR_NUMBER} --body \"/gemini review\"\n+```\n+\n+### 2. Wait\n+Allow time for the review to process (typically 3-5 minutes).\n+\n+### 3. Fetch Comments (Correctly)\n+Use the API endpoint with pagination to ensure you get *everything*.\n+```bash\n+gh api repos/{OWNER}/{REPO}/pulls/{PR_NUMBER}/comments --paginate > comments.json\n+```\n+\n+### 4. Analyze & Filter\n+Parse the JSON to find comments created **after** your last push/fix cycle.\n+*   Filter by `created_at` timestamp.\n+*   Ignore \"outdated\" or resolved comments if your logic handles them.\n+\n+### 5. Implement & Verify\n+*   Address the specific feedback.\n+*   Run tests (`pytest`) to verify fixes.\n+\n+### 6. Push & Repeat\n+```bash\n+git add .\n+git commit -m \"Address Cycle X comments\"\n+git push\n+```\n+Return to Step 1.","path":".antigravity/context.md","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis Markdown file seems to document lessons learned during development. While this information can be valuable, committing it to the source tree, especially under a hidden directory, is unconventional and adds clutter. This type of documentation is often better suited for a project wiki, a separate `docs` folder, or as a comment in the pull request description if it's context-specific. Please remove this file from the commit.","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566378","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566378"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566378/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":48,"side":"RIGHT","author_association":"NONE","original_position":48,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384","pull_request_review_id":3544610557,"id":2592566384,"node_id":"PRRC_kwDOPKYCYs6ah2xw","diff_hunk":"@@ -0,0 +1,114 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if value is None:\n+        return \"\"\n+    if isinstance(value, str):\n+        try:\n+            value = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n+        except ValueError:\n+             return value\n+    return value.strftime(format)","path":"webapp.py","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `format_datetime` filter is not robust enough. It only attempts to parse full datetime strings (`YYYY-MM-DD HH:MM:SS`) and will fail to format date-only strings (like `YYYY-MM-DD` from `report_date`), returning them unformatted. This leads to an inconsistent user interface in the history page. Please update the filter to handle both date and datetime strings gracefully.\n\n```suggestion\n@app.template_filter('format_datetime')\ndef format_datetime(value, format='%d/%m/%Y %H:%M'):\n    if value is None:\n        return \"\"\n    if isinstance(value, str):\n        try:\n            value = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n        except ValueError:\n            try:\n                # Fallback for date-only strings\n                value = datetime.strptime(value, '%Y-%m-%d')\n                return value.strftime('%d/%m/%Y')\n            except ValueError:\n                 return value # Return as-is if not a recognized format\n    return value.strftime(format)\n```","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566384","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566384"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566384/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":27,"side":"RIGHT","author_association":"NONE","original_position":27,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394","pull_request_review_id":3544610557,"id":2592566394,"node_id":"PRRC_kwDOPKYCYs6ah2x6","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+    <table>\n+        <thead>\n+            <tr>\n+                <th>Numéro</th>\n+                <th>Date Appel</th>\n+                <th>Spam?</th>\n+                <th>Commentaire</th>\n+                <th>Signalé le</th>\n+                <th>Action</th>\n+            </tr>\n+        </thead>\n+        <tbody>\n+            {% for report in reports %}\n+            <tr>\n+                <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+                <td>{{ report.report_date }}</td>","path":"templates/history.html","commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","original_commit_id":"633a5e7483c94a6c0925e63dc9b3ef4e1c8acf01","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor a consistent and user-friendly UI, the `report_date` should be formatted (e.g., to `DD/MM/YYYY`). Currently, it's displayed directly from the database. After updating the `format_datetime` filter in `webapp.py` as suggested in my other comment, please apply it here.\n\n```\n                <td>{{ report.report_date|format_datetime }}</td>\n```","created_at":"2025-12-05T12:41:09Z","updated_at":"2025-12-05T12:41:09Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566394","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592566394"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592566394/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":22,"side":"RIGHT","author_association":"NONE","original_position":22,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739520","pull_request_review_id":3544823427,"id":2592739520,"node_id":"PRRC_kwDOPKYCYs6aihDA","diff_hunk":"@@ -101,88 +151,115 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != 0:\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Check format roughly\n+    if not re.match(r'^\\+?[0-9 .]+$', raw_tel):","path":"whoistel.py","commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","original_commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe regex used for initial validation of the phone number is too restrictive. It only allows digits, spaces, dots, and an optional leading `+`. However, the `clean_phone_number` function is designed to handle other separators like hyphens `-` and parentheses `()`. This discrepancy will cause valid phone number formats (e.g., `06-12-34-56-78`) to be incorrectly rejected.\n\n```suggestion\n    if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel):\n```","created_at":"2025-12-05T13:42:45Z","updated_at":"2025-12-05T13:42:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739520","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739520"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739520"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739520/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":243,"side":"RIGHT","author_association":"NONE","original_position":222,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739529","pull_request_review_id":3544823427,"id":2592739529,"node_id":"PRRC_kwDOPKYCYs6aihDJ","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+    <table>\n+        <thead>\n+            <tr>\n+                <th>Numéro</th>\n+                <th>Date Appel</th>\n+                <th>Spam?</th>\n+                <th>Commentaire</th>\n+                <th>Signalé le</th>\n+                <th>Action</th>\n+            </tr>\n+        </thead>\n+        <tbody>\n+            {% for report in reports %}\n+            <tr>\n+                <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+                <td>{{ report.report_date|format_datetime }}</td>\n+                <td class=\"{{ 'spam-alert' if report.is_spam else '' }}\">{{ 'OUI' if report.is_spam else 'NON' }}</td>\n+                <td>{{ report.comment }}</td>\n+                <td>{{ report['created_at']|format_datetime }}</td>","path":"templates/history.html","commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","original_commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThere's an inconsistent access pattern for the `report` object's attributes in this template. Most attributes are accessed using dot notation (e.g., `report.phone_number`), but `created_at` is accessed using bracket notation (`report['created_at']`). While both work for dictionaries in Jinja2, using a consistent style improves readability and maintainability. It's recommended to use dot notation for all attributes for consistency.\n\n```\n                <td>{{ report.created_at|format_datetime }}</td>\n```","created_at":"2025-12-05T13:42:46Z","updated_at":"2025-12-05T13:42:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739529","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739529"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739529"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739529/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739532","pull_request_review_id":3544823427,"id":2592739532,"node_id":"PRRC_kwDOPKYCYs6aihDM","diff_hunk":"@@ -0,0 +1,123 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('webapp.history_manager.add_report') as mock_add_report:\n+        client.post('/report', data={\n+            'number': '0123456789',\n+            'comment': long_comment\n+        })\n+        # Check that add_report was called with a truncated comment\n+        args, _ = mock_add_report.call_args\n+        # args: (number, date, is_spam, comment)\n+        assert len(args[3]) == 1024\n+        assert args[3] == \"a\" * 1024\n+\n+def test_csrf_protection(client):\n+    \"\"\"Tests that CSRF protection is active.\"\"\"\n+    # Note: The client fixture disables CSRF by default (WTF_CSRF_ENABLED=False).\n+    # We need to enable it for this specific test.\n+    app.config['WTF_CSRF_ENABLED'] = True\n+    \n+    # Try to post without a CSRF token\n+    rv = client.post('/report', data={\n+        'number': '0123456789',\n+        'is_spam': 'on'\n+    })\n+    \n+    # Should return 400 Bad Request (CSRF token missing)\n+    assert rv.status_code == 400\n+    \n+    # Reset config\n+    app.config['WTF_CSRF_ENABLED'] = False","path":"tests/test_webapp.py","commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","original_commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis test modifies the global `app.config`. If an assertion fails, the cleanup code `app.config['WTF_CSRF_ENABLED'] = False` will not be executed, potentially causing other tests to fail unexpectedly. It's more robust to wrap the test logic in a `try...finally` block to ensure the configuration is always reset.\n\n```suggestion\n    app.config['WTF_CSRF_ENABLED'] = True\n    try:\n        # Try to post without a CSRF token\n        rv = client.post('/report', data={\n            'number': '0123456789',\n            'is_spam': 'on'\n        })\n        \n        # Should return 400 Bad Request (CSRF token missing)\n        assert rv.status_code == 400\n    finally:\n        # Reset config\n        app.config['WTF_CSRF_ENABLED'] = False\n```","created_at":"2025-12-05T13:42:46Z","updated_at":"2025-12-05T13:42:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739532","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739532"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739532"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739532/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":110,"start_side":"RIGHT","line":null,"original_line":122,"side":"RIGHT","author_association":"NONE","original_position":122,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739538","pull_request_review_id":3544823427,"id":2592739538,"node_id":"PRRC_kwDOPKYCYs6aihDS","diff_hunk":"@@ -0,0 +1,119 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if value is None:\n+        return \"\"\n+    if isinstance(value, str):\n+        try:\n+            value = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n+        except ValueError:\n+            try:\n+                # Fallback for date-only strings\n+                value = datetime.strptime(value, '%Y-%m-%d')\n+                return value.strftime('%d/%m/%Y')\n+            except ValueError:\n+                 return value\n+    return value.strftime(format)","path":"webapp.py","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"4aa03c92bb504938da8f1438851327b6b80087c8","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current implementation of `format_datetime` is a bit hard to follow due to nested `try-except` blocks and reassignment of the `value` variable. This can be refactored for better readability and maintainability by flattening the logic and having clear return paths for each case.\n\n```suggestion\n@app.template_filter('format_datetime')\ndef format_datetime(value, format='%d/%m/%Y %H:%M'):\n    if value is None:\n        return \"\"\n    if isinstance(value, str):\n        try:\n            # Try parsing as datetime first\n            dt = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n            return dt.strftime(format)\n        except ValueError:\n            try:\n                # Fallback for date-only strings\n                dt = datetime.strptime(value, '%Y-%m-%d')\n                return dt.strftime('%d/%m/%Y')\n            except ValueError:\n                 return value # Not a recognized date/datetime string\n    \n    # If not a string, assume it's a datetime object and format it.\n    return value.strftime(format)\n```","created_at":"2025-12-05T13:42:46Z","updated_at":"2025-12-05T13:42:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739538","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739538"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592739538"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592739538/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":32,"side":"RIGHT","author_association":"NONE","original_position":32,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756338","pull_request_review_id":3544843141,"id":2592756338,"node_id":"PRRC_kwDOPKYCYs6ailJy","diff_hunk":"@@ -9,6 +9,11 @@ venv/\n \n # Database\n whoistel.sqlite3\n+history.sqlite3\n+test_output*.txt\n+analysis*.txt\n+pr_comments*.json\n+*.log","path":".gitignore","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nWhile it's good that you've added several patterns to ignore generated files, a large number of temporary development artifacts and logs have still been committed in this PR (e.g., `gitlog.txt`, `listing.txt`, `manual_*.json`, `wait_for_review.py`, etc.). This adds unnecessary clutter to the repository. Please remove these files from version control and add more comprehensive patterns to `.gitignore` to prevent this in the future.\n\n```\nhistory.sqlite3\n*.log\n\n# CI/CD & dev artifacts\ntest_output*.txt\nanalysis*.txt\npr_comments*.json\ngit*.txt\nlisting.txt\nmanual_*.txt\nmanual_*.json\n*_c*.json\nreview_*.txt\nwait_for_review.py\nhead_postpull.txt\npossible_new_comments.json\npr_check_status.json\n\n```","created_at":"2025-12-05T13:48:36Z","updated_at":"2025-12-05T13:48:36Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756338","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756338"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756338"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756338/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":15,"original_start_line":12,"start_side":"RIGHT","line":19,"original_line":16,"side":"RIGHT","author_association":"NONE","original_position":8,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756341","pull_request_review_id":3544843141,"id":2592756341,"node_id":"PRRC_kwDOPKYCYs6ailJ1","diff_hunk":"@@ -0,0 +1,123 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if value is None:\n+        return \"\"\n+    if isinstance(value, str):\n+        try:\n+            # Try parsing as datetime first\n+            dt = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n+            return dt.strftime(format)\n+        except ValueError:\n+            try:\n+                # Fallback for date-only strings\n+                dt = datetime.strptime(value, '%Y-%m-%d')\n+                return dt.strftime('%d/%m/%Y')\n+            except ValueError:\n+                 return value # Not a recognized date/datetime string\n+    \n+    # If not a string, assume it's a datetime object and format it.\n+    return value.strftime(format)","path":"webapp.py","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe logic in the `format_datetime` filter is a bit complex and has two issues:\n1. When it parses a date-only string (e.g., '2023-01-01'), it formats it using a hardcoded `'%d/%m/%Y'` format, ignoring the `format` parameter passed to the filter. This makes the filter's behavior inconsistent.\n2. The final `return value.strftime(format)` will raise an `AttributeError` if the input `value` is not a string or a datetime object.\n\nThis can be refactored for better clarity, consistency, and robustness.\n\n```python\n@app.template_filter('format_datetime')\ndef format_datetime(value, format='%d/%m/%Y %H:%M'):\n    if not value:\n        return \"\"\n\n    dt_obj = None\n    if isinstance(value, str):\n        try:\n            dt_obj = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n        except ValueError:\n            try:\n                dt_obj = datetime.strptime(value, '%Y-%m-%d')\n                # For date-only strings, we use a specific date format.\n                return dt_obj.strftime('%d/%m/%Y')\n            except ValueError:\n                return value  # Return as-is if not a recognized format\n    elif isinstance(value, datetime):\n        dt_obj = value\n    \n    if dt_obj:\n        return dt_obj.strftime(format)\n\n    return value # Return original value if not a string or datetime\n```","created_at":"2025-12-05T13:48:36Z","updated_at":"2025-12-05T13:48:36Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756341","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756341"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756341"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756341/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":36,"side":"RIGHT","author_association":"NONE","original_position":36,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756348","pull_request_review_id":3544843141,"id":2592756348,"node_id":"PRRC_kwDOPKYCYs6ailJ8","diff_hunk":"@@ -0,0 +1,123 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('webapp.history_manager.add_report') as mock_add_report:\n+        client.post('/report', data={\n+            'number': '0123456789',\n+            'comment': long_comment\n+        })\n+        # Check that add_report was called with a truncated comment\n+        args, _ = mock_add_report.call_args\n+        # args: (number, date, is_spam, comment)\n+        assert len(args[3]) == 1024\n+        assert args[3] == \"a\" * 1024\n+\n+def test_csrf_protection(client):\n+    \"\"\"Tests that CSRF protection is active.\"\"\"\n+    # Note: The client fixture disables CSRF by default (WTF_CSRF_ENABLED=False).\n+    # We need to enable it for this specific test.\n+    app.config['WTF_CSRF_ENABLED'] = True\n+    try:\n+        # Try to post without a CSRF token\n+        rv = client.post('/report', data={\n+            'number': '0123456789',\n+            'is_spam': 'on'\n+        })\n+        \n+        # Should return 400 Bad Request (CSRF token missing)\n+        assert rv.status_code == 400\n+    finally:\n+        # Reset config\n+        app.config['WTF_CSRF_ENABLED'] = False\n+","path":"tests/test_webapp.py","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIn `test_csrf_protection`, you are modifying the global `app.config` directly. This can lead to flaky tests or side effects if tests are run in parallel or in a different order, as the configuration change can leak into other tests. A more robust approach is to create a dedicated fixture that yields a test client with a specific configuration for this test, ensuring test isolation.","created_at":"2025-12-05T13:48:36Z","updated_at":"2025-12-05T13:48:36Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756348","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756348"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756348"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":106,"start_side":"RIGHT","line":null,"original_line":123,"side":"RIGHT","author_association":"NONE","original_position":123,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756349","pull_request_review_id":3544843141,"id":2592756349,"node_id":"PRRC_kwDOPKYCYs6ailJ9","diff_hunk":"@@ -101,88 +151,115 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != 0:\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Check format roughly\n+    if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel):\n+             print(\"Erreur: Le numéro doit contenir uniquement des chiffres (ou commencer par +33).\", file=sys.stderr)\n+             sys.exit(1)","path":"whoistel.py","commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","original_commit_id":"d5ef639c4c3a57aab0612130a9572fdfbd8867a9","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe regex check `r'^\\+?[0-9 .()-]+$'` is too strict and doesn't align with the capabilities of the `clean_phone_number` function. For example, it would reject a number like `+33(0)612345678` because the regex doesn't account for `(0)` after `+33`, even though `clean_phone_number` handles this case correctly. This initial validation is redundant and can be removed to rely solely on the more robust cleaning function.","created_at":"2025-12-05T13:48:36Z","updated_at":"2025-12-05T13:48:36Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756349","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756349"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592756349"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592756349/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":243,"start_side":"RIGHT","line":null,"original_line":245,"side":"RIGHT","author_association":"NONE","original_position":224,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778152","pull_request_review_id":3544875842,"id":2592778152,"node_id":"PRRC_kwDOPKYCYs6aiqeo","diff_hunk":"@@ -101,88 +151,119 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != 0:\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Remove redundant initial regex check\n+    # if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel): ...\n+    # clean_phone_number handles more cases.\n \n-    # Clean number\n-    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n-    if tel.startswith('+33'):\n-        tel = '0' + tel[3:]\n+    cleaned_number = clean_phone_number(raw_tel)\n+    \n+    # Ensure cleaned number only contains digits (or +)\n+    if not re.match(r'^\\+?[0-9]+$', cleaned_number):\n+         print(\"Erreur: Le numéro doit contenir uniquement des chiffres (ou commencer par +33).\", file=sys.stderr)\n+         sys.exit(1)","path":"whoistel.py","commit_id":"f7012971796e6c655d60c79c7d119ae96aaca4f1","original_commit_id":"d8126cd6686a2740b5fb4d5161f15237ee4e6e90","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe regex used for validation here is invalid and will cause a runtime error. The pattern `r'^\\+?[0-9]+$'` is invalid because the `+` quantifier is not preceded by a token to repeat. It should be `\\+` to match a literal plus sign.\n\nHowever, given that `clean_phone_number` is intended to handle international prefixes like `+33` and return a normalized number string (which should only contain digits), a simple `.isdigit()` check is more robust, readable, and less error-prone for validating the final cleaned number before lookup.\n\nThis also fixes the issue revealed by the failing test `test_invalid_number_format_non_digit`, which currently proceeds to lookup with an invalid number instead of failing at the validation stage.\n\n```suggestion\n    if not cleaned_number.isdigit():\n         print(\"Erreur: Le numéro fourni est invalide. Il doit contenir uniquement des chiffres après nettoyage.\", file=sys.stderr)\n         sys.exit(1)\n```","created_at":"2025-12-05T13:54:45Z","updated_at":"2025-12-05T13:54:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778152","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778152"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778152"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778152/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":249,"start_side":"RIGHT","line":null,"original_line":251,"side":"RIGHT","author_association":"NONE","original_position":234,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778159","pull_request_review_id":3544875842,"id":2592778159,"node_id":"PRRC_kwDOPKYCYs6aiqev","diff_hunk":"@@ -7,9 +7,33 @@ env/\n venv/\n .venv/\n \n+# Temporary python artifacts\n+__pycache__/\n+*.pyc\n+\n # Database\n+history.sqlite3\n whoistel.sqlite3\n \n+# Logs and temporary files\n+*.log\n+test_output*.txt\n+analysis*.txt\n+pr_comments*.json\n+git*.txt\n+listing.txt\n+manual_*.txt\n+manual_*.json\n+*_c*.json\n+review_*.txt\n+wait_for_review.py\n+head_postpull.txt\n+possible_new_comments.json\n+pr_check_status.json\n+current_commit.txt\n+show_*.py\n+parsed_*.txt","path":".gitignore","commit_id":"f7012971796e6c655d60c79c7d119ae96aaca4f1","original_commit_id":"d8126cd6686a2740b5fb4d5161f15237ee4e6e90","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThese entries seem to be artifacts from a specific developer's workflow or tooling (e.g., `manual_*.txt`, `pr_comments*.json`). A project's `.gitignore` should generally contain patterns for files generated by the project's standard tools (build artifacts, logs, dependencies), not user-specific temporary files. These should be removed from the project's `.gitignore` and added to a personal/global gitignore file instead to keep the project configuration clean.","created_at":"2025-12-05T13:54:45Z","updated_at":"2025-12-05T13:54:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778159","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778159"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778159"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778159/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":20,"start_side":"RIGHT","line":null,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":29,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778166","pull_request_review_id":3544875842,"id":2592778166,"node_id":"PRRC_kwDOPKYCYs6aiqe2","diff_hunk":"@@ -1 +1,4 @@\n pandas\n+Flask\n+Flask-WTF\n+email-validator","path":"requirements.txt","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"d8126cd6686a2740b5fb4d5161f15237ee4e6e90","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `README.md` file recommends using `gunicorn` for production deployments. To ensure consistent and reproducible production environments, it's a good practice to include production dependencies in the project's requirements. Please consider adding `gunicorn` to this file.\n\n```\nFlask\nFlask-WTF\nemail-validator\ngunicorn\n```","created_at":"2025-12-05T13:54:45Z","updated_at":"2025-12-05T13:54:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778166","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778166"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778166"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778166/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":2,"original_start_line":2,"start_side":"RIGHT","line":4,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":4,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778167","pull_request_review_id":3544875842,"id":2592778167,"node_id":"PRRC_kwDOPKYCYs6aiqe3","diff_hunk":"@@ -0,0 +1,127 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, str):\n+        try:\n+            dt_obj = datetime.strptime(value, '%Y-%m-%d %H:%M:%S')\n+        except ValueError:\n+            try:\n+                dt_obj = datetime.strptime(value, '%Y-%m-%d')\n+                # For date-only strings, we use a specific date format.\n+                return dt_obj.strftime('%d/%m/%Y')\n+            except ValueError:\n+                return value  # Return as-is if not a recognized format\n+    elif isinstance(value, datetime):\n+        dt_obj = value\n+    \n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return value # Return original value if not a string or datetime","path":"webapp.py","commit_id":"f7012971796e6c655d60c79c7d119ae96aaca4f1","original_commit_id":"d8126cd6686a2740b5fb4d5161f15237ee4e6e90","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `format_datetime` template filter has complex nested logic and a special case that returns early, ignoring the `format` parameter for date-only strings. This can be confusing and lead to unexpected behavior if the filter is used with a custom format for a date. Refactoring this to try parsing different formats and then applying the given format string would make it cleaner, more maintainable, and ensure consistent behavior.\n\n```python\n@app.template_filter('format_datetime')\ndef format_datetime(value, format='%d/%m/%Y %H:%M'):\n    if not value:\n        return \"\"\n\n    dt_obj = None\n    if isinstance(value, datetime):\n        dt_obj = value\n    elif isinstance(value, str):\n        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n            try:\n                dt_obj = datetime.strptime(value, fmt)\n                break  # Parsed successfully\n            except ValueError:\n                pass  # Try next format\n\n    if dt_obj:\n        return dt_obj.strftime(format)\n\n    return value # Return original value if parsing failed\n```","created_at":"2025-12-05T13:54:45Z","updated_at":"2025-12-05T13:54:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778167","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778167"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592778167"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592778167/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":40,"side":"RIGHT","author_association":"NONE","original_position":40,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793202","pull_request_review_id":3544893396,"id":2592793202,"node_id":"PRRC_kwDOPKYCYs6aiuJy","diff_hunk":"@@ -20,3 +28,8 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.log\n+*.png\n+verification/","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe pattern `*.log` is already included on line 19 under the `# Logs and temporary files` section. This duplicate entry can be removed to keep the `.gitignore` file clean and concise.\n\n```\n# Logs and Artifacts\n*.png\nverification/\n```","created_at":"2025-12-05T13:59:37Z","updated_at":"2025-12-05T13:59:38Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793202","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793202"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793202"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793202/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":32,"original_start_line":32,"start_side":"RIGHT","line":34,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":26,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793204","pull_request_review_id":3544893396,"id":2592793204,"node_id":"PRRC_kwDOPKYCYs6aiuJ0","diff_hunk":"@@ -0,0 +1,73 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                kwargs['conn'] = new_conn\n+                return func(*args, **kwargs)\n+    return wrapper","path":"history_manager.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `with_db_connection` decorator modifies the `kwargs` dictionary by adding a `conn` key. While this works for the current implementation, this side effect can be surprising and lead to subtle bugs if the decorated functions are changed in the future (e.g., to accept `**kwargs` for other purposes). A safer implementation would avoid modifying the input `kwargs` directly, for instance by creating a copy before modification.\n\n```suggestion\ndef with_db_connection(func):\n    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n    @wraps(func)\n    def wrapper(*args, **kwargs):\n        conn = kwargs.get('conn')\n        if conn:\n            return func(*args, **kwargs)\n        else:\n            with closing(get_db_connection()) as new_conn:\n                # Create a copy of kwargs to avoid modifying the original dict\n                new_kwargs = kwargs.copy()\n                new_kwargs['conn'] = new_conn\n                return func(*args, **new_kwargs)\n    return wrapper\n```","created_at":"2025-12-05T13:59:37Z","updated_at":"2025-12-05T13:59:38Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793204","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793204"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793204"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793204/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":7,"original_start_line":7,"start_side":"RIGHT","line":21,"original_line":18,"side":"RIGHT","author_association":"NONE","original_position":18,"position":21,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793209","pull_request_review_id":3544893396,"id":2592793209,"node_id":"PRRC_kwDOPKYCYs6aiuJ5","diff_hunk":"@@ -0,0 +1,66 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n+            </ul>\n+        {% endif %}\n+\n+        {% if result.location %}\n+            <h4>Localisation</h4>\n+            <ul>\n+                {% if result.location.commune %}\n+                    <li><strong>Commune :</strong> {{ result.location.commune }} ({{ result.location.code_postal }})</li>\n+                    <li><strong>Département :</strong> {{ result.location.departement }}</li>\n+                {% elif result.location.region %}\n+                    <li><strong>Région :</strong> {{ result.location.region }}</li>\n+                {% endif %}\n+            </ul>\n+        {% endif %}\n+    </div>\n+{% endif %}\n+\n+<div class=\"result-box community\">\n+    <h3>Statistiques Communautaires</h3>\n+    <p>Ce numéro a été signalé comme spam <strong>{{ spam_count }}</strong> fois.</p>\n+</div>\n+\n+<h3>Ajouter un signalement / note</h3>\n+<form action=\"{{ url_for('report') }}\" method=\"post\">\n+    <input type=\"hidden\" name=\"csrf_token\" value=\"{{ csrf_token() }}\">\n+    <input type=\"hidden\" name=\"number\" value=\"{{ number }}\">\n+\n+    <label for=\"date\">Date de l'appel (optionnel) :</label>\n+    <input type=\"date\" name=\"date\" id=\"date\">\n+\n+    <label>\n+        <input type=\"checkbox\" name=\"is_spam\"> Signaler comme Spam / Démarchage\n+    </label>\n+    <br><br>\n+\n+    <label for=\"comment\">Commentaire (optionnel) :</label><br>\n+    <textarea name=\"comment\" id=\"comment\" rows=\"3\"></textarea>\n+    <br><br>\n+\n+    <input type=\"submit\" value=\"Enregistrer le signalement\">","path":"templates/result.html","commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","original_commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing `<br>` tags for vertical spacing is generally discouraged as it mixes presentation with structure. It's better practice to use CSS for layout and spacing. You can achieve this by wrapping form elements in `div`s with a class like `form-group` and then applying `margin-bottom` in your `style.css` file. This improves maintainability and separates concerns.\n\nFor example, you could add the following to `static/style.css`:\n```css\n.form-group {\n    margin-bottom: 1rem;\n}\n```\n\n```\n    <div class=\"form-group\">\n        <label>\n            <input type=\"checkbox\" name=\"is_spam\"> Signaler comme Spam / Démarchage\n        </label>\n    </div>\n\n    <div class=\"form-group\">\n        <label for=\"comment\">Commentaire (optionnel) :</label>\n        <textarea name=\"comment\" id=\"comment\" rows=\"3\"></textarea>\n    </div>\n\n    <div class=\"form-group\">\n        <input type=\"submit\" value=\"Enregistrer le signalement\">\n    </div>\n```","created_at":"2025-12-05T13:59:38Z","updated_at":"2025-12-05T13:59:38Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793209","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793209"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793209"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793209/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":54,"start_side":"RIGHT","line":null,"original_line":63,"side":"RIGHT","author_association":"NONE","original_position":63,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793210","pull_request_review_id":3544893396,"id":2592793210,"node_id":"PRRC_kwDOPKYCYs6aiuJ6","diff_hunk":"@@ -0,0 +1,124 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break  # Parsed successfully\n+            except ValueError:\n+                pass  # Try next format\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return value # Return original value if parsing failed","path":"webapp.py","commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","original_commit_id":"4e43ee64b3b7ff89da4712c32f5d87a8e98d2d4e","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `format_datetime` template filter's fallback behavior is to return the original `value` if it cannot be parsed. This could lead to raw, unformatted date strings (e.g., `2023-01-01 12:30:00`) being displayed in the UI if an unexpected format is encountered. For a more consistent user experience, it would be better to return an empty string.\n\n```suggestion\n    return \"\" # Return original value if parsing failed\n```","created_at":"2025-12-05T13:59:38Z","updated_at":"2025-12-05T13:59:38Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793210","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793210"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592793210"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592793210/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":37,"side":"RIGHT","author_association":"NONE","original_position":37,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806506","pull_request_review_id":3544909320,"id":2592806506,"node_id":"PRRC_kwDOPKYCYs6aixZq","diff_hunk":"@@ -20,3 +28,7 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"7856cce7d155bd0db059827eab9a574717c1fe24","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis pull request includes several temporary files and development artifacts (e.g., `gitbranch.txt`, `pytest_c13_fail.txt`, `analysis_c13.txt`). These files should not be committed to the version control system. Please update the `.gitignore` file to exclude them and remove them from this pull request.\n\n```\n# Logs and Artifacts\n*.png\nverification/\n\n# Development artifacts\nanalysis_*.txt\ngitbranch.txt\ngitlog.txt\ngitstatus.txt\nlatest_comments_*.json\nlisting.txt\nmanual_report.txt\nmanual_reviews_check.json\npr_status_*.json\npytest_*.txt\nreview_outcome.txt\ntest_result.txt\ntest_whoistel_out.txt\nwait_for_review.py\n```","created_at":"2025-12-05T14:03:45Z","updated_at":"2025-12-05T14:03:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592806506","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806506"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592806506"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806506/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":32,"original_start_line":32,"start_side":"RIGHT","line":34,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":25,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806511","pull_request_review_id":3544909320,"id":2592806511,"node_id":"PRRC_kwDOPKYCYs6aixZv","diff_hunk":"@@ -0,0 +1,75 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper\n+\n+DB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()","path":"history_manager.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"7856cce7d155bd0db059827eab9a574717c1fe24","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor better performance on `get_spam_count` queries, which filters by both `phone_number` and `is_spam`, it's recommended to add a composite index on these two columns. This will prevent full table scans and significantly speed up lookups as the number of reports grows.\n\n```suggestion\n        c.execute('''\n            CREATE TABLE IF NOT EXISTS reports (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                phone_number TEXT NOT NULL,\n                report_date DATE,\n                is_spam INTEGER DEFAULT 0,\n                comment TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n        # Add a composite index for faster spam count lookups\n        c.execute('''\n            CREATE INDEX IF NOT EXISTS idx_reports_phone_number_spam ON reports (phone_number, is_spam);\n        ''')\n        conn.commit()\n```","created_at":"2025-12-05T14:03:45Z","updated_at":"2025-12-05T14:03:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592806511","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806511"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592806511"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592806511/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":36,"original_start_line":35,"start_side":"RIGHT","line":50,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":45,"position":50,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817505","pull_request_review_id":3544923134,"id":2592817505,"node_id":"PRRC_kwDOPKYCYs6ai0Fh","diff_hunk":"@@ -0,0 +1,79 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper\n+\n+DB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        # Add a composite index for faster spam count lookups\n+        c.execute('''\n+            CREATE INDEX IF NOT EXISTS idx_reports_phone_number_spam ON reports (phone_number, is_spam);\n+        ''')\n+        conn.commit()\n+\n+@with_db_connection\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+\n+@with_db_connection\n+def get_spam_count(phone_number, conn=None):\n+    c = conn.cursor()\n+    c.execute('''\n+        SELECT COUNT(*) FROM reports\n+        WHERE phone_number = ? AND is_spam = 1\n+    ''', (phone_number,))\n+    count = c.fetchone()[0]\n+    return count\n+\n+@with_db_connection\n+def get_recent_reports(limit=50, conn=None):","path":"history_manager.py","commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","original_commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe default `limit` of `50` is a magic number. Defining it as a module-level constant (e.g., `DEFAULT_RECENT_REPORTS_LIMIT = 50`) would improve readability and make it easier to modify this value in the future without searching through the code.\n\n```suggestion\ndef get_recent_reports(limit=DEFAULT_RECENT_REPORTS_LIMIT, conn=None):\n```","created_at":"2025-12-05T14:07:20Z","updated_at":"2025-12-05T14:07:20Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817505","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817505"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817505"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817505/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":71,"side":"RIGHT","author_association":"NONE","original_position":71,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817513","pull_request_review_id":3544923134,"id":2592817513,"node_id":"PRRC_kwDOPKYCYs6ai0Fp","diff_hunk":"@@ -0,0 +1,23 @@\n+body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }\n+header { background: #333; color: #fff; padding: 10px; margin-bottom: 20px; }\n+header nav a { color: #fff; margin-right: 15px; text-decoration: none; }\n+.container { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n+input[type=\"text\"], input[type=\"date\"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }\n+input[type=\"submit\"], button { padding: 10px 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; }\n+input[type=\"submit\"]:hover { background: #0056b3; }","path":"static/style.css","commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","original_commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `.button` class, used on `<a>` tags in templates like `error.html`, is not styled, leading to an inconsistent UI where links don't look like buttons. To fix this, you should add the `.button` selector to your button styles. Additionally, the `:hover` effect is missing for `<button>` elements. The suggestion below corrects both issues and adds properties to make links render correctly as buttons.\n\n```suggestion\ninput[type=\"submit\"], button, .button { padding: 10px 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; text-decoration: none; display: inline-block; }\ninput[type=\"submit\"]:hover, button:hover, .button:hover { background: #0056b3; }\n```","created_at":"2025-12-05T14:07:20Z","updated_at":"2025-12-05T14:07:20Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817513","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817513"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817513"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817513/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":6,"start_side":"RIGHT","line":null,"original_line":7,"side":"RIGHT","author_association":"NONE","original_position":7,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817519","pull_request_review_id":3544923134,"id":2592817519,"node_id":"PRRC_kwDOPKYCYs6ai0Fv","diff_hunk":"@@ -0,0 +1,124 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break  # Parsed successfully\n+            except ValueError:\n+                pass  # Try next format","path":"webapp.py","commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","original_commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current implementation of the `format_datetime` filter iterates through a list of formats within a `try-except` block. Since the date formats from the database are known and consistent (`%Y-%m-%d %H:%M:%S` for timestamps and `%Y-%m-%d` for dates), you can simplify this logic to be more direct and efficient. A simple check for a space in the string can distinguish between the two formats.\n\n```python\n    elif isinstance(value, str):\n        fmt = '%Y-%m-%d %H:%M:%S' if ' ' in value else '%Y-%m-%d'\n        try:\n            dt_obj = datetime.strptime(value, fmt)\n        except ValueError:\n            pass  # Or log an error if the format is unexpected\n```","created_at":"2025-12-05T14:07:20Z","updated_at":"2025-12-05T14:07:20Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817519","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817519"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817519"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817519/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":26,"start_side":"RIGHT","line":null,"original_line":32,"side":"RIGHT","author_association":"NONE","original_position":32,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817520","pull_request_review_id":3544923134,"id":2592817520,"node_id":"PRRC_kwDOPKYCYs6ai0Fw","diff_hunk":"@@ -0,0 +1,124 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break  # Parsed successfully\n+            except ValueError:\n+                pass  # Try next format\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:1024]","path":"webapp.py","commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","original_commit_id":"72fa47230a93c979081970f65541b8fc2d18b9f7","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe comment truncation length of `1024` is a magic number. It's a good practice to define such values as constants at the top of the module (e.g., `MAX_COMMENT_LENGTH = 1024`). This improves code readability and maintainability, as the value is defined in one central place.\n\n```python\n    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]\n```","created_at":"2025-12-05T14:07:20Z","updated_at":"2025-12-05T14:07:20Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817520","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817520"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592817520"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592817520/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":101,"side":"RIGHT","author_association":"NONE","original_position":101,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828102","pull_request_review_id":3544936822,"id":2592828102,"node_id":"PRRC_kwDOPKYCYs6ai2rG","diff_hunk":"@@ -0,0 +1 @@\n+{\"comments\":[{\"id\":\"IC_kwDOPKYCYs7XHWuD\",\"author\":{\"login\":\"google-labs-jules\"},\"authorAssociation\":\"NONE\",\"body\":\"👋 Jules, reporting for duty! I'm here to lend a hand with this pull request.\\n\\nWhen you start a review, I'll add a 👀 emoji to each comment to let you know I've read it. I'll focus on feedback directed at me and will do my best to stay out of conversations between you and other bots or reviewers to keep the noise down.\\n\\nI'll push a commit with your requested changes shortly after. Please note there might be a delay between these steps, but rest assured I'm on the job!\\n\\nFor more direct control, you can switch me to **Reactive Mode**. When this mode is on, I will only act on comments where you specifically mention me with `@jules`. You can find this option in the **Pull Request** section of your [global Jules UI settings](https://jules.google.com/settings). You can always switch back!\\n\\n---\\n*_For security, I will only act on instructions from the user who triggered this task._*\\n\\nNew to Jules? Learn more at [jules.google/docs](https://jules.google/docs).\",\"createdAt\":\"2025-12-03T22:02:22Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609029507\",\"viewerDidAuthor\":false},{\"id\":\"IC_kwDOPKYCYs7XHXX9\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-03T22:03:14Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609032189\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XHaHn\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"@Jules address Code review comments\",\"createdAt\":\"2025-12-03T22:07:04Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609043431\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XHarW\",\"author\":{\"login\":\"google-labs-jules\"},\"authorAssociation\":\"NONE\",\"body\":\"> @Jules address Code review comments\\n\\nI am ready to address the code review comments, but I am currently unable to see them (I only see this message and the previous /gemini review command). I previously addressed the binary files issue by removing them and updating .gitignore. Could you please ensure the review comments are visible to me?\",\"createdAt\":\"2025-12-03T22:07:48Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609045718\",\"viewerDidAuthor\":false},{\"id\":\"IC_kwDOPKYCYs7XI7E0\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T00:54:02Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609440564\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XI8U9\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"@jules address Gemini Code Assist's previous comments\",\"createdAt\":\"2025-12-04T00:57:09Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609445693\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XI8sh\",\"author\":{\"login\":\"google-labs-jules\"},\"authorAssociation\":\"NONE\",\"body\":\"> @jules address Gemini Code Assist's previous comments\\n\\nI am eager to address the Gemini Code Assist comments, but I am currently unable to see them in my view (I only see your instruction to address them). Could you please repost the specific feedback points or ensure they are visible to me so I can act on them?\",\"createdAt\":\"2025-12-04T00:58:02Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3609447201\",\"viewerDidAuthor\":false},{\"id\":\"IC_kwDOPKYCYs7XRUa-\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T11:16:45Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3611641534\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XTNkY\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T12:58:10Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612137752\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XTY01\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T13:10:09Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612183861\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XTuAm\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T13:28:57Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612270630\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XT4CF\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T13:37:50Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612311685\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XUJ73\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T13:55:20Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612385015\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XUWAp\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T14:07:15Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612434473\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XUlMd\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T14:20:54Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612496669\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XVwS9\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T15:28:13Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3612804285\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XdFGk\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-04T23:28:03Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3614724516\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XdhpG\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T00:26:29Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3614841414\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XdmyW\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T00:37:37Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3614862486\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XdpsI\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T00:44:23Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3614874376\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XduhK\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T00:55:57Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3614894154\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XipgF\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T10:12:09Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616184325\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xi_MC\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T10:33:25Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616273154\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XjLwe\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T10:48:15Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616324638\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xkd1F\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T12:19:11Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616660805\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xk4qB\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T12:39:04Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616770689\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XlWxE\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Ready for review. Addressed Cycle 10 feedback.\",\"createdAt\":\"2025-12-05T13:15:49Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616894020\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XlqqM\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T13:40:57Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616975500\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xlump\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Addressed Cycle 11 feedback.\",\"createdAt\":\"2025-12-05T13:45:56Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616991657\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XlunD\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T13:45:57Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3616991683\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl0FH\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Addressed Cycle 12 feedback. Ready for review.\",\"createdAt\":\"2025-12-05T13:52:25Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617014087\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl0Fk\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T13:52:26Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617014116\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl43_\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Addressed Cycle 13 feedback.\",\"createdAt\":\"2025-12-05T13:57:26Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617033727\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl44H\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T13:57:26Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617033735\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl8hO\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Addressed Cycle 14 feedback.\",\"createdAt\":\"2025-12-05T14:01:39Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617048654\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7Xl8hd\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T14:01:40Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617048669\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XmAFp\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"Addressed Cycle 15 feedback.\",\"createdAt\":\"2025-12-05T14:05:35Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617063273\",\"viewerDidAuthor\":true},{\"id\":\"IC_kwDOPKYCYs7XmAIz\",\"author\":{\"login\":\"sheepdestroyer\"},\"authorAssociation\":\"OWNER\",\"body\":\"/gemini review\",\"createdAt\":\"2025-12-05T14:05:38Z\",\"includesCreatedEdit\":false,\"isMinimized\":false,\"minimizedReason\":\"\",\"reactionGroups\":[{\"content\":\"EYES\",\"users\":{\"totalCount\":1}}],\"url\":\"https://github.com/sheepdestroyer/whoistel/pull/27#issuecomment-3617063475\",\"viewerDidAuthor\":true}]}","path":"manual_c16_chk.json","commit_id":"83c70f70e87c0a0f424080b3fc7c9b8a46320922","original_commit_id":"83c70f70e87c0a0f424080b3fc7c9b8a46320922","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis file appears to be a temporary development artifact containing PR comments. Such files should not be committed to the repository. Please remove this file. Also, consider updating `.gitignore` to prevent similar files from being accidentally added in the future, for example by adding a pattern like `manual_*.json`.","created_at":"2025-12-05T14:10:50Z","updated_at":"2025-12-05T14:10:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592828102","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828102"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592828102"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828102/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":1,"side":"RIGHT","author_association":"NONE","original_position":1,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828105","pull_request_review_id":3544936822,"id":2592828105,"node_id":"PRRC_kwDOPKYCYs6ai2rJ","diff_hunk":"@@ -0,0 +1,126 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Determine format based on presence of time part\n+        fmt = '%Y-%m-%d %H:%M:%S' if ' ' in value else '%Y-%m-%d'\n+        try:\n+            dt_obj = datetime.strptime(value, fmt)\n+        except ValueError:\n+            pass  # Parsing failed","path":"webapp.py","commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","original_commit_id":"83c70f70e87c0a0f424080b3fc7c9b8a46320922","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...except ValueError: pass` block silently ignores any date/time string that doesn't match the expected formats. While this prevents the app from crashing, it can hide underlying data issues or bugs in how timestamps are stored or retrieved. It would be more robust to log a warning when parsing fails. This would help in diagnosing problems with unexpected date formats in the database.\n\n```suggestion\n        except ValueError:\n            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n            pass  # Parsing failed\n```","created_at":"2025-12-05T14:10:50Z","updated_at":"2025-12-05T14:10:50Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592828105","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828105"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592828105"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592828105/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592838006","pull_request_review_id":3544951157,"id":2592838006,"node_id":"PRRC_kwDOPKYCYs6ai5F2","diff_hunk":"@@ -101,88 +151,119 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != 0:","path":"whoistel.py","commit_id":"aafc8f8c621e38c5dac0d599d9260e62ca631d66","original_commit_id":"aafc8f8c621e38c5dac0d599d9260e62ca631d66","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `code_insee` field is stored as `TEXT` in the database, so it will be a string when retrieved. Comparing it to the integer `0` (`!= 0`) is confusing and relies on Python's type inequality rules, which can be brittle. For clarity and type safety, it's better to compare it to the string `'0'`.\n\n```suggestion\n    if info['code_insee'] and info['code_insee'] != '0':\n```","created_at":"2025-12-05T14:13:59Z","updated_at":"2025-12-05T14:13:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592838006","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592838006"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592838006"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592838006/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":186,"side":"RIGHT","author_association":"NONE","original_position":148,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592851977","pull_request_review_id":3544971913,"id":2592851977,"node_id":"PRRC_kwDOPKYCYs6ai8gJ","diff_hunk":"@@ -0,0 +1,127 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Determine format based on presence of time part\n+        fmt = '%Y-%m-%d %H:%M:%S' if ' ' in value else '%Y-%m-%d'\n+        try:\n+            dt_obj = datetime.strptime(value, fmt)\n+        except ValueError:\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+            pass  # Parsing failed\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"73b46f9222b9d0122cae3ec3f15fa95c882c8ea1","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe use of SQLite for the history database can lead to `database is locked` errors in a production environment when using multiple web server workers (e.g., `gunicorn -w 4`). SQLite's file-level locking mechanism is not designed for high-concurrency writes from separate processes, which can cause requests to fail under load.\n\nWhile the application will function correctly with a single worker, this limits its scalability.\n\n**Recommendation:**\nFor a production-ready application, I suggest one of two approaches:\n\n1.  **Document the Limitation (Simpler):** Explicitly state in `README.md` that the application must be run with a single worker process due to this limitation. For example:\n    ```bash\n    # In README.md\n    gunicorn -w 1 --bind 0.0.0.0:5000 webapp:app\n    ```\n\n2.  **Switch to a Client-Server Database (More Scalable):** For true multi-process support, migrate the history database to a system like PostgreSQL or MySQL. This would involve updating `history_manager.py` to use a different database driver (e.g., `psycopg2`).\n\nGiven the scope of this PR, documenting the single-worker limitation is the most straightforward solution.","created_at":"2025-12-05T14:18:21Z","updated_at":"2025-12-05T14:18:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592851977","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592851977"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592851977"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592851977/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":44,"original_start_line":42,"start_side":"RIGHT","line":47,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":45,"position":47,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866547","pull_request_review_id":3544990674,"id":2592866547,"node_id":"PRRC_kwDOPKYCYs6ajADz","diff_hunk":"@@ -0,0 +1,84 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper","path":"history_manager.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `with_db_connection` decorator has a potential issue: it doesn't correctly handle the case where the `conn` argument is passed positionally to the decorated function. If `conn` is passed as a positional argument, `kwargs.get('conn')` will be `None`, causing the decorator to open a new connection. The original `conn` object is still passed to the function via `*args`, which will lead to a `TypeError` because the function receives multiple values for the `conn` argument.\n\nTo make this decorator robust, `conn` should be enforced as a keyword-only argument in all decorated functions. I will add suggestions to modify the function signatures accordingly.","created_at":"2025-12-05T14:22:22Z","updated_at":"2025-12-05T14:22:23Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866547","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866547"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866547"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866547/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":7,"original_start_line":7,"start_side":"RIGHT","line":21,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":21,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866551","pull_request_review_id":3544990674,"id":2592866551,"node_id":"PRRC_kwDOPKYCYs6ajAD3","diff_hunk":"@@ -0,0 +1,84 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper\n+\n+DB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        # Add a composite index for faster spam count lookups\n+        c.execute('''\n+            CREATE INDEX IF NOT EXISTS idx_reports_phone_number_spam ON reports (phone_number, is_spam);\n+        ''')\n+        conn.commit()\n+\n+@with_db_connection\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):","path":"history_manager.py","commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","original_commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nAs noted in my comment on the `with_db_connection` decorator, making `conn` a keyword-only argument will prevent potential `TypeError` issues when the decorator is used.\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment, *, conn=None):\n```","created_at":"2025-12-05T14:22:22Z","updated_at":"2025-12-05T14:22:23Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866551","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866551"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866551"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866551/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":52,"side":"RIGHT","author_association":"NONE","original_position":52,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866562","pull_request_review_id":3544990674,"id":2592866562,"node_id":"PRRC_kwDOPKYCYs6ajAEC","diff_hunk":"@@ -0,0 +1,84 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper\n+\n+DB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        # Add a composite index for faster spam count lookups\n+        c.execute('''\n+            CREATE INDEX IF NOT EXISTS idx_reports_phone_number_spam ON reports (phone_number, is_spam);\n+        ''')\n+        conn.commit()\n+\n+@with_db_connection\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+\n+@with_db_connection\n+def get_spam_count(phone_number, conn=None):","path":"history_manager.py","commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","original_commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nAs noted in my comment on the `with_db_connection` decorator, making `conn` a keyword-only argument will prevent potential `TypeError` issues when the decorator is used.\n\n```suggestion\ndef get_spam_count(phone_number, *, conn=None):\n```","created_at":"2025-12-05T14:22:22Z","updated_at":"2025-12-05T14:22:23Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866562","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866562"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866562"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866562/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":61,"side":"RIGHT","author_association":"NONE","original_position":61,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866573","pull_request_review_id":3544990674,"id":2592866573,"node_id":"PRRC_kwDOPKYCYs6ajAEN","diff_hunk":"@@ -0,0 +1,84 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)\n+    return wrapper\n+\n+DB_FILE = os.environ.get('HISTORY_DB_FILE', 'history.sqlite3')\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        # Add a composite index for faster spam count lookups\n+        c.execute('''\n+            CREATE INDEX IF NOT EXISTS idx_reports_phone_number_spam ON reports (phone_number, is_spam);\n+        ''')\n+        conn.commit()\n+\n+@with_db_connection\n+def add_report(phone_number, report_date, is_spam, comment, conn=None):\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+\n+@with_db_connection\n+def get_spam_count(phone_number, conn=None):\n+    c = conn.cursor()\n+    c.execute('''\n+        SELECT COUNT(*) FROM reports\n+        WHERE phone_number = ? AND is_spam = 1\n+    ''', (phone_number,))\n+    count = c.fetchone()[0]\n+    return count\n+\n+DEFAULT_RECENT_REPORTS_LIMIT = 50\n+\n+@with_db_connection\n+def get_recent_reports(limit=DEFAULT_RECENT_REPORTS_LIMIT, conn=None):","path":"history_manager.py","commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","original_commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nAs noted in my comment on the `with_db_connection` decorator, making `conn` a keyword-only argument will prevent potential `TypeError` issues when the decorator is used.\n\n```suggestion\ndef get_recent_reports(limit=DEFAULT_RECENT_REPORTS_LIMIT, *, conn=None):\n```","created_at":"2025-12-05T14:22:22Z","updated_at":"2025-12-05T14:22:23Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866573","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866573"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866573"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866573/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":73,"side":"RIGHT","author_association":"NONE","original_position":73,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866577","pull_request_review_id":3544990674,"id":2592866577,"node_id":"PRRC_kwDOPKYCYs6ajAER","diff_hunk":"@@ -0,0 +1,127 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Determine format based on presence of time part\n+        fmt = '%Y-%m-%d %H:%M:%S' if ' ' in value else '%Y-%m-%d'\n+        try:\n+            dt_obj = datetime.strptime(value, fmt)\n+        except ValueError:\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+            pass  # Parsing failed","path":"webapp.py","commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","original_commit_id":"6f028aaadbe4d4689a708eef51668d4ece0ef96d","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe logic to determine the date format based on the presence of a space is a bit fragile. It works for the current data formats (`YYYY-MM-DD` and `YYYY-MM-DD HH:MM:SS`), but it could break if the format changes or if unexpected string values are encountered. A more robust approach would be to attempt parsing with a list of expected formats.\n\n```suggestion\n    elif isinstance(value, str):\n        # Try parsing multiple formats, from most to least specific\n        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n            try:\n                dt_obj = datetime.strptime(value, fmt)\n                break\n            except ValueError:\n                pass\n        else:  # No format matched\n            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n```","created_at":"2025-12-05T14:22:22Z","updated_at":"2025-12-05T14:22:23Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866577","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866577"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592866577"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592866577/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":28,"start_side":"RIGHT","line":null,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":35,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874650","pull_request_review_id":3545000525,"id":2592874650,"node_id":"PRRC_kwDOPKYCYs6ajCCa","diff_hunk":"@@ -0,0 +1,129 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"58802a1c036a9f097dfad257d279a8e5a75f6fc3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `check` function cleans the user-provided phone number but doesn't validate its format before redirecting. A raw number like `123foo456` would be cleaned to `123foo456` and included in the redirect URL, leading to a request to `/view/123foo456`. While Jinja2's auto-escaping likely prevents XSS on the results page, it's best practice to validate user input early and reject invalid formats. The CLI implementation already includes a check to ensure the cleaned number contains only digits. A similar validation should be added here.\n\n```suggestion\n    tel = whoistel.clean_phone_number(raw_tel)\n\n    if not tel.isdigit():\n        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n        return redirect(url_for('index'))\n\n    return redirect(url_for('view_number', number=tel))\n```","created_at":"2025-12-05T14:24:54Z","updated_at":"2025-12-05T14:24:55Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592874650","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874650"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592874650"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874650/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":76,"original_start_line":76,"start_side":"RIGHT","line":82,"original_line":78,"side":"RIGHT","author_association":"NONE","original_position":78,"position":82,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874661","pull_request_review_id":3545000525,"id":2592874661,"node_id":"PRRC_kwDOPKYCYs6ajCCl","diff_hunk":"@@ -0,0 +1,129 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"58802a1c036a9f097dfad257d279a8e5a75f6fc3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nTo protect against manually crafted URLs (e.g., `/view/123foo456`), it's important to validate the `number` parameter from the URL path, even after cleaning. This ensures that the application only processes valid phone number formats. A check should be added to ensure the `cleaned_number` contains only digits.\n\n```suggestion\n    if not cleaned_number.isdigit():\n        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n```","created_at":"2025-12-05T14:24:55Z","updated_at":"2025-12-05T14:24:55Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592874661","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874661"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592874661"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592874661/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":93,"original_line":85,"side":"RIGHT","author_association":"NONE","original_position":85,"position":93,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592880195","pull_request_review_id":3545007396,"id":2592880195,"node_id":"PRRC_kwDOPKYCYs6ajDZD","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+<table>\n+    <thead>\n+        <tr>\n+            <th>Numéro</th>\n+            <th>Date Appel</th>\n+            <th>Spam?</th>\n+            <th>Commentaire</th>\n+            <th>Signalé le</th>\n+            <th>Action</th>\n+        </tr>\n+    </thead>\n+    <tbody>\n+        {% for report in reports %}\n+        <tr>\n+            <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+            <td>{{ report.report_date|format_datetime }}</td>","path":"templates/history.html","commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","original_commit_id":"58802a1c036a9f097dfad257d279a8e5a75f6fc3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `report_date` field is being formatted with the default datetime format, which includes the time (`HH:MM`). Since this field only contains a date, this results in `00:00` being displayed, which can be confusing for users. To improve UI clarity, you should specify a date-only format for this field.\n\n```\n            <td>{{ report.report_date|format_datetime('%d/%m/%Y') }}</td>\n```","created_at":"2025-12-05T14:26:30Z","updated_at":"2025-12-05T14:26:30Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592880195","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592880195"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592880195"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592880195/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":22,"side":"RIGHT","author_association":"NONE","original_position":22,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886614","pull_request_review_id":3545015163,"id":2592886614,"node_id":"PRRC_kwDOPKYCYs6ajE9W","diff_hunk":"@@ -0,0 +1,125 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+@pytest.fixture\n+def client_with_csrf(client):\n+    \"\"\"Fixture that enables CSRF protection for specific tests.\"\"\"\n+    app.config['WTF_CSRF_ENABLED'] = True\n+    yield client\n+    app.config['WTF_CSRF_ENABLED'] = False\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000","path":"tests/test_webapp.py","commit_id":"581418a14eb7cfd58a37829952ca157e5c1571eb","original_commit_id":"581418a14eb7cfd58a37829952ca157e5c1571eb","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing a magic number like `2000` for `long_comment` makes the test less clear about its intent regarding `MAX_COMMENT_LENGTH`. Consider deriving this value from `webapp.MAX_COMMENT_LENGTH` to explicitly link it to the application's logic.\n\n```suggestion\n    long_comment = \"a\" * (webapp.MAX_COMMENT_LENGTH + 1000) # Ensure it's longer than MAX_COMMENT_LENGTH\n```","created_at":"2025-12-05T14:28:25Z","updated_at":"2025-12-05T14:28:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592886614","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886614"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592886614"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886614/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":101,"side":"RIGHT","author_association":"NONE","original_position":101,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886619","pull_request_review_id":3545015163,"id":2592886619,"node_id":"PRRC_kwDOPKYCYs6ajE9b","diff_hunk":"@@ -0,0 +1,125 @@\n+import pytest\n+import os\n+import tempfile\n+import sqlite3\n+from webapp import app\n+import history_manager\n+import whoistel\n+from unittest.mock import patch\n+\n+@pytest.fixture\n+def client():\n+    # Create a temporary database for history\n+    db_fd, db_path = tempfile.mkstemp()\n+    history_manager.DB_FILE = db_path\n+    history_manager.init_history_db()\n+\n+    app.config['TESTING'] = True\n+    app.config['WTF_CSRF_ENABLED'] = False\n+    app.config['SECRET_KEY'] = 'test-key'\n+\n+    with app.test_client() as client:\n+        yield client\n+\n+    os.close(db_fd)\n+    os.unlink(db_path)\n+\n+@pytest.fixture\n+def client_with_csrf(client):\n+    \"\"\"Fixture that enables CSRF protection for specific tests.\"\"\"\n+    app.config['WTF_CSRF_ENABLED'] = True\n+    yield client\n+    app.config['WTF_CSRF_ENABLED'] = False\n+\n+def test_index(client):\n+    rv = client.get('/')\n+    assert b'Rechercher un num' in rv.data\n+\n+def test_check_number_redirect(client):\n+    rv = client.post('/check', data={'number': '0123456789'})\n+    assert rv.status_code == 302\n+    assert '/view/0123456789' in rv.location\n+\n+def test_view_number_unknown(client):\n+    # Tests checking a number that likely doesn't exist or is generic\n+    rv = client.get('/view/0123456789')\n+    assert b'0123456789' in rv.data\n+    # Check if spam count is 0\n+    assert b'signal\\xc3\\xa9 comme spam <strong>0</strong> fois' in rv.data\n+\n+def test_report_flow(client):\n+    # 1. Report a number as spam\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '2023-01-01',\n+        'is_spam': 'on',\n+        'comment': 'Test Spam'\n+    }, follow_redirects=True)\n+\n+    assert rv.status_code == 200\n+    # Should see the updated count in the result page (since it redirects to view)\n+    assert b'signal\\xc3\\xa9 comme spam <strong>1</strong> fois' in rv.data\n+\n+    # 2. Check History\n+    rv = client.get('/history')\n+    assert b'0987654321' in rv.data\n+    assert b'Test Spam' in rv.data\n+    assert b'OUI' in rv.data\n+\n+def test_check_known_missing_number(client):\n+    # The number mentioned in AGENTS.md that is missing from ARCEP data\n+    # +33740756315 -> 0740756315\n+    rv = client.get('/view/0740756315')\n+    assert b'Num\\xc3\\xa9ro inconnu dans la base ARCEP' in rv.data\n+\n+def test_view_number_redirect_dirty(client):\n+    # /view/01.02... should redirect to /view/0102...\n+    rv = client.get('/view/01.02.03.04.05')\n+    assert rv.status_code == 302\n+    assert '/view/0102030405' in rv.location\n+\n+def test_report_empty_date(client):\n+    rv = client.post('/report', data={\n+        'number': '0987654321',\n+        'date': '',\n+        'is_spam': 'on',\n+        'comment': 'Test Empty Date'\n+    }, follow_redirects=True)\n+    assert rv.status_code == 200\n+    rv = client.get('/history')\n+    assert b'Test Empty Date' in rv.data\n+\n+def test_database_connection_error(client):\n+    with patch('whoistel.setup_db_connection') as mock_db:\n+        mock_db.side_effect = whoistel.DatabaseError(\"Connection failed\")\n+        rv = client.get('/view/0123456789')\n+        assert rv.status_code == 500\n+        assert b'Database error occurred' in rv.data\n+\n+def test_report_comment_truncation(client):\n+    \"\"\"Tests that the comment field is truncated to 1024 characters.\"\"\"\n+    long_comment = \"a\" * 2000\n+    with patch('webapp.history_manager.add_report') as mock_add_report:\n+        client.post('/report', data={\n+            'number': '0123456789',\n+            'comment': long_comment\n+        })\n+        # Check that add_report was called with a truncated comment\n+        args, _ = mock_add_report.call_args\n+        # args: (number, date, is_spam, comment)\n+        assert len(args[3]) == 1024\n+        assert args[3] == \"a\" * 1024","path":"tests/test_webapp.py","commit_id":"581418a14eb7cfd58a37829952ca157e5c1571eb","original_commit_id":"581418a14eb7cfd58a37829952ca157e5c1571eb","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe assertion uses a magic number `1024`. It would be more robust and maintainable to reference `webapp.MAX_COMMENT_LENGTH` directly, ensuring the test remains accurate if the maximum comment length changes in the future.\n\n```suggestion\n        assert len(args[3]) == webapp.MAX_COMMENT_LENGTH\n        assert args[3] == \"a\" * webapp.MAX_COMMENT_LENGTH\n```","created_at":"2025-12-05T14:28:25Z","updated_at":"2025-12-05T14:28:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592886619","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886619"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592886619"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592886619/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":110,"start_side":"RIGHT","line":null,"original_line":111,"side":"RIGHT","author_association":"NONE","original_position":111,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897532","pull_request_review_id":3545029339,"id":2592897532,"node_id":"PRRC_kwDOPKYCYs6ajHn8","diff_hunk":"@@ -0,0 +1,34 @@\n+import pytest\n+import os\n+import subprocess\n+\n+# Set SECRET_KEY for testing before any app import happens\n+os.environ['SECRET_KEY'] = 'test-key-for-conftest'\n+\n+def get_project_root():\n+    \"\"\"Returns the root directory of the project.\"\"\"\n+    return os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))\n+\n+@pytest.fixture(scope=\"session\", autouse=True)\n+def setup_database():\n+    \"\"\"\n+    Ensures the database is generated before tests run.\n+    \"\"\"\n+    root_dir = get_project_root()\n+    update_script_path = os.path.join(root_dir, \"updatearcep.sh\")\n+    db_path = os.path.join(root_dir, \"whoistel.sqlite3\")\n+\n+    if not os.path.exists(db_path):\n+        print(\"\\nDatabase not found. Running updatearcep.sh to generate it...\")\n+        # Check if we can run it (permissions)\n+        subprocess.run([\"chmod\", \"+x\", update_script_path], check=True, cwd=root_dir)\n+        try:\n+            subprocess.run(\n+                [\"./updatearcep.sh\"], # Executing directly since we chmodded it\n+                capture_output=True, text=True, check=True, cwd=root_dir\n+            )\n+        except subprocess.CalledProcessError as e:\n+            # Print stderr for debugging\n+            print(f\"Update Script Output: {e.stdout}\")\n+            print(f\"Update Script Error: {e.stderr}\")\n+            pytest.fail(f\"Database generation failed: {e.stderr}\")","path":"tests/conftest.py","commit_id":"fd25bc4c21aa85973ba52eee1ced62eee8ec6226","original_commit_id":"fd25bc4c21aa85973ba52eee1ced62eee8ec6226","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `setup_database` fixture makes the test suite dependent on running an external shell script (`updatearcep.sh`) which downloads data from the internet. This can lead to several problems:\n\n*   **Flakiness:** Tests can fail due to network issues, server downtime, or changes in the remote data URLs.\n*   **Slowness:** Downloading data makes the test setup slow.\n*   **Non-determinism:** Changes in the remote data can unexpectedly break tests.\n*   **Lack of isolation:** Tests are not isolated from external services.\n\nA better practice is to use a small, dedicated test database. This database could be:\n\n1.  Checked into the repository as a test artifact.\n2.  Generated during test setup from small, sample CSV files that are also checked into the repository.\n\nThis would make the tests faster, more reliable, and fully self-contained.","created_at":"2025-12-05T14:31:52Z","updated_at":"2025-12-05T14:31:52Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592897532","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897532"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592897532"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897532/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":12,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897535","pull_request_review_id":3545029339,"id":2592897535,"node_id":"PRRC_kwDOPKYCYs6ajHn_","diff_hunk":"@@ -101,88 +151,119 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != '0':\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Remove redundant initial regex check\n+    # if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel): ...\n+    # clean_phone_number handles more cases.\n \n-    # Clean number\n-    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n-    if tel.startswith('+33'):\n-        tel = '0' + tel[3:]\n+    cleaned_number = clean_phone_number(raw_tel)\n+    \n+    # Ensure cleaned number only contains digits\n+    if not cleaned_number.isdigit():\n+         print(\"Erreur: Le numéro fourni est invalide. Il doit contenir uniquement des chiffres après nettoyage.\", file=sys.stderr)\n+         sys.exit(1)\n+    \n+    if len(cleaned_number) != 10:\n+        logger.warning(f\"Attention: Le numéro {cleaned_number} ne fait pas 10 chiffres. La recherche peut échouer.\")\n \n-    if not tel.isdigit():\n-        logger.error(\"Erreur: Le numéro doit contenir uniquement des chiffres (ou commencer par +33).\")\n+    # Use valid database connection\n+    try:\n+        conn = setup_db_connection()\n+        try:\n+             result = get_full_info(conn, cleaned_number)\n+             print_result(result)\n+        finally:\n+             conn.close()\n+    except DatabaseError as e:\n+        logger.error(str(e))\n         sys.exit(1)\n ","path":"whoistel.py","commit_id":"fd25bc4c21aa85973ba52eee1ced62eee8ec6226","original_commit_id":"fd25bc4c21aa85973ba52eee1ced62eee8ec6226","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block for managing the database connection can be simplified by using a `with` statement. The `sqlite3` connection object acts as a context manager, which will automatically close the connection, even if errors occur. This makes the code more concise and idiomatic.\n\n```suggestion\n    try:\n        with setup_db_connection() as conn:\n             result = get_full_info(conn, cleaned_number)\n             print_result(result)\n    except DatabaseError as e:\n        logger.error(str(e))\n        sys.exit(1)\n```","created_at":"2025-12-05T14:31:52Z","updated_at":"2025-12-05T14:31:52Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592897535","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897535"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592897535"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592897535/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":258,"start_side":"RIGHT","line":null,"original_line":267,"side":"RIGHT","author_association":"NONE","original_position":252,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902788","pull_request_review_id":3545035738,"id":2592902788,"node_id":"PRRC_kwDOPKYCYs6ajI6E","diff_hunk":"@@ -0,0 +1,35 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Historique des Signalements Récents</h2>\n+\n+{% if reports %}\n+<table>\n+    <thead>\n+        <tr>\n+            <th>Numéro</th>\n+            <th>Date Appel</th>\n+            <th>Spam?</th>\n+            <th>Commentaire</th>\n+            <th>Signalé le</th>\n+            <th>Action</th>\n+        </tr>\n+    </thead>\n+    <tbody>\n+        {% for report in reports %}\n+        <tr>\n+            <td><a href=\"{{ url_for('view_number', number=report.phone_number) }}\">{{ report.phone_number }}</a></td>\n+            <td>{{ report.report_date|format_datetime }}</td>","path":"templates/history.html","commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","original_commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `format_datetime` filter defaults to a format that includes hours and minutes (`%d/%m/%Y %H:%M`). Since `report_date` is only a date (the time part will be midnight), displaying '00:00' might be confusing for the user. It would be clearer to format this value as a date only.\n\n```\n            <td>{{ report.report_date|format_datetime(format='%d/%m/%Y') }}</td>\n```","created_at":"2025-12-05T14:33:37Z","updated_at":"2025-12-05T14:33:37Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902788","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902788"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902788"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902788/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":22,"side":"RIGHT","author_association":"NONE","original_position":22,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902792","pull_request_review_id":3545035738,"id":2592902792,"node_id":"PRRC_kwDOPKYCYs6ajI6I","diff_hunk":"@@ -0,0 +1,137 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment, conn=get_history_db())\n+        flash(\"Signalement enregistré.\", \"success\")\n+        return redirect(url_for('view_number', number=number))","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current implementation allows submitting an empty report (neither 'is_spam' is checked nor a comment is provided). This creates an entry in the database with no useful information. It would be better to validate that at least one of these fields is provided before adding the report. This will prevent storing empty data and provide better feedback to the user.\n\n```suggestion\n        if not is_spam and not comment:\n            flash(\"Veuillez cocher la case spam ou ajouter un commentaire pour enregistrer un signalement.\", \"error\")\n            return redirect(url_for('view_number', number=number))\n\n        history_manager.add_report(number, date, is_spam, comment, conn=get_history_db())\n        flash(\"Signalement enregistré.\", \"success\")\n        return redirect(url_for('view_number', number=number))\n```","created_at":"2025-12-05T14:33:37Z","updated_at":"2025-12-05T14:33:37Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902792","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902792"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902792"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902792/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":129,"original_start_line":125,"start_side":"RIGHT","line":131,"original_line":127,"side":"RIGHT","author_association":"NONE","original_position":127,"position":131,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902798","pull_request_review_id":3545035738,"id":2592902798,"node_id":"PRRC_kwDOPKYCYs6ajI6O","diff_hunk":"@@ -101,88 +152,117 @@ def search_number(conn, tel):\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != '0':\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Remove redundant initial regex check\n+    # if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel): ...\n+    # clean_phone_number handles more cases.\n \n-    # Clean number\n-    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n-    if tel.startswith('+33'):\n-        tel = '0' + tel[3:]\n+    cleaned_number = clean_phone_number(raw_tel)\n+    \n+    # Ensure cleaned number only contains digits\n+    if not cleaned_number.isdigit():\n+         print(\"Erreur: Le numéro fourni est invalide. Il doit contenir uniquement des chiffres après nettoyage.\", file=sys.stderr)\n+         sys.exit(1)\n+    \n+    if len(cleaned_number) != 10:\n+        logger.warning(f\"Attention: Le numéro {cleaned_number} ne fait pas 10 chiffres. La recherche peut échouer.\")\n \n-    if not tel.isdigit():\n-        logger.error(\"Erreur: Le numéro doit contenir uniquement des chiffres (ou commencer par +33).\")\n+    # Use valid database connection\n+    # Use valid database connection\n+    try:\n+        with contextlib.closing(setup_db_connection()) as conn:\n+             result = get_full_info(conn, cleaned_number)\n+             print_result(result)\n+    except DatabaseError as e:\n+        logger.error(str(e))\n         sys.exit(1)\n ","path":"whoistel.py","commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","original_commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block for managing the database connection is correct, but it can be simplified by using a `with` statement. Since `sqlite3.connect` returns a connection object that acts as a context manager, you can use it directly in a `with` block to ensure the connection is automatically closed, even if errors occur. This makes the code more concise and idiomatic.\n\n```suggestion\n    try:\n        with setup_db_connection() as conn:\n            result = get_full_info(conn, cleaned_number)\n            print_result(result)\n    except DatabaseError as e:\n        logger.error(str(e))\n        sys.exit(1)\n```","created_at":"2025-12-05T14:33:37Z","updated_at":"2025-12-05T14:33:37Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902798","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902798"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592902798"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592902798/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":257,"start_side":"RIGHT","line":null,"original_line":266,"side":"RIGHT","author_association":"NONE","original_position":255,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592912434","pull_request_review_id":3545047871,"id":2592912434,"node_id":"PRRC_kwDOPKYCYs6ajLQy","diff_hunk":"@@ -0,0 +1,137 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment, conn=get_history_db())\n+        flash(\"Signalement enregistré.\", \"success\")\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"bb1571d61d50ab5f9e690f3b8ce6ba3e48030fe1","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIf the `report` endpoint is called without a `number` in the form data (e.g., through a crafted request), it currently redirects to the index page silently. This provides no feedback to the user about why their action might have failed. It's better to flash an error message before redirecting to improve user experience and make debugging easier.\n\n```suggestion\n    flash(\"Impossible d'enregistrer le signalement : numéro manquant.\", \"error\")\n    return redirect(url_for('index'))\n```","created_at":"2025-12-05T14:36:33Z","updated_at":"2025-12-05T14:36:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592912434","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592912434"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2592912434"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2592912434/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":132,"original_line":128,"side":"RIGHT","author_association":"NONE","original_position":128,"position":132,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070143","pull_request_review_id":3545240800,"id":2593070143,"node_id":"PRRC_kwDOPKYCYs6ajxw_","diff_hunk":"@@ -1,28 +1,58 @@\n #!/usr/bin/env python3\n #-*- encoding: Utf-8 -*-\n import sqlite3\n+import sqlite3","path":"whoistel.py","commit_id":"2655fb0e3b86370927538bdfb06df3acc3eacaf5","original_commit_id":"2655fb0e3b86370927538bdfb06df3acc3eacaf5","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThere is a duplicate `import sqlite3` statement. It can be removed to clean up the code.","created_at":"2025-12-05T15:25:14Z","updated_at":"2025-12-05T15:25:15Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593070143","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070143"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593070143"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070143/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070151","pull_request_review_id":3545240800,"id":2593070151,"node_id":"PRRC_kwDOPKYCYs6ajxxH","diff_hunk":"@@ -1,28 +1,58 @@\n #!/usr/bin/env python3\n #-*- encoding: Utf-8 -*-\n import sqlite3\n+import sqlite3\n import argparse\n import sys\n import os\n import logging\n+import re\n+from urllib.parse import urlparse\n+from email_validator import validate_email, EmailNotValidError\n+\n+class DatabaseError(Exception):\n+    pass\n \n # Configure logging\n logging.basicConfig(level=logging.INFO, format='%(message)s') # Simplified format for CLI\n logger = logging.getLogger(__name__)\n \n DB_FILE = 'whoistel.sqlite3'\n \n+REGION_MAP = {\n+    '01': 'Île-de-France',\n+    '02': 'Nord-Ouest',\n+    '03': 'Nord-Est',\n+    '04': 'Sud-Est',\n+    '05': 'Sud-Ouest'\n+}\n+\n+def clean_phone_number(raw_tel):\n+    if not raw_tel:\n+        return \"\"\n+    # Remove separators and parenthesis (including tabs, non-breaking spaces)\n+    tel = re.sub(r'[\\s.\\-()]', '', raw_tel)\n+\n+    # Handle +33 (0) case which becomes +330... after removal\n+    if tel.startswith('+330'):\n+        tel = '0' + tel[4:]\n+    elif tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return tel\n+\n def setup_db_connection():\n     if not os.path.exists(DB_FILE):\n-        logger.error(f\"Erreur: La base de données '{DB_FILE}' est absente.\")\n-        logger.error(\"Veuillez exécuter le script 'updatearcep.sh' ou 'generatedb.py' pour la générer.\")\n-        sys.exit(1)\n+        msg = f\"Erreur: La base de données '{DB_FILE}' est absente. Veuillez exécuter le script 'updatearcep.sh' ou 'generatedb.py' pour la générer.\"\n+        logger.error(msg)\n+        raise DatabaseError(msg)\n     try:\n         conn = sqlite3.connect(DB_FILE)\n         return conn","path":"whoistel.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"2655fb0e3b86370927538bdfb06df3acc3eacaf5","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor consistency with `history_manager.py` and to improve code readability, consider setting `conn.row_factory = sqlite3.Row`. This allows accessing columns by name (e.g., `row['NomOperateur']`) instead of by index (e.g., `row[0]`), making the data access logic in functions like `get_operator_info`, `get_commune_info`, and `search_number` more robust and maintainable. After adding this line, you can refactor the data access in the other functions to use named columns.\n\n```suggestion\n        conn = sqlite3.connect(DB_FILE)\n        conn.row_factory = sqlite3.Row\n        return conn\n```","created_at":"2025-12-05T15:25:14Z","updated_at":"2025-12-05T15:25:15Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593070151","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070151"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593070151"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593070151/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":49,"original_start_line":50,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":54,"position":50,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593078426","pull_request_review_id":3545252700,"id":2593078426,"node_id":"PRRC_kwDOPKYCYs6ajzya","diff_hunk":"@@ -1,28 +1,58 @@\n #!/usr/bin/env python3\n #-*- encoding: Utf-8 -*-\n import sqlite3\n+import sqlite3","path":"whoistel.py","commit_id":"2655fb0e3b86370927538bdfb06df3acc3eacaf5","original_commit_id":"2655fb0e3b86370927538bdfb06df3acc3eacaf5","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `sqlite3` module is imported twice. This duplicate import can be removed to improve code clarity.","created_at":"2025-12-05T15:27:53Z","updated_at":"2025-12-05T15:27:54Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593078426","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593078426"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593078426"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593078426/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136446","pull_request_review_id":3545329757,"id":2593136446,"node_id":"PRRC_kwDOPKYCYs6akB8-","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThis change adds many patterns for ignoring local development artifacts, which is great. However, several files that should be ignored (e.g., `manual_check_c25.py`, `manual_review_c25.txt`, `auth_status.txt`, `gh_help.txt`) have been added to the repository in this PR. These files, especially `auth_status.txt` which may contain sensitive information (even if obfuscated), should be removed from version control.\n\nTo prevent this from happening again, please add the corresponding patterns (e.g., `auth_status.txt`, `gh_help.txt`, `manual_*.py`, `manual_*.txt`) to your `.gitignore` file.","created_at":"2025-12-05T15:47:04Z","updated_at":"2025-12-05T15:47:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593136446","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136446"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593136446"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136446/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":37,"original_start_line":37,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136449","pull_request_review_id":3545329757,"id":2593136449,"node_id":"PRRC_kwDOPKYCYs6akB9B","diff_hunk":"@@ -93,96 +144,124 @@ def search_number(conn, tel):\n             if row:\n                 best_match = {\n                     'prefix': prefix,\n-                    'code_operateur': row[0],\n+                    'code_operateur': row['CodeOperateur'],\n                     'code_insee': None,\n                     'type': 'Non-Geographique'\n                 }\n                 break\n \n     return best_match\n \n-def print_result(conn, tel, info):\n-    print(f\"Numéro : {tel}\")\n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n \n     if not info:\n-        print(\"Résultat : Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\")\n-        # Add a note about possible reasons\n-        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n-        sys.exit(1)\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n \n-    print(f\"Type détecté : {info['type']}\")\n-    print(f\"Préfixe identifié : {info['prefix']}\")\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n \n     # Operator Info\n     op_info = get_operator_info(conn, info['code_operateur'])\n     if op_info:\n-        print(\"\\n--- Opérateur ---\")\n-        print(f\"Nom : {op_info['nom']}\")\n-        print(f\"Code ARCEP : {op_info['code']}\")\n-        if op_info['site']:\n-            print(f\"Site Web : {op_info['site']}\")\n-        if op_info['mail']:\n-            print(f\"Email : {op_info['mail']}\")\n+        result['operator'] = op_info\n     else:\n-        print(f\"\\nOpérateur : Code {info['code_operateur']} (Détails non trouvés)\")\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n \n     # Location Info\n-    if info['code_insee'] and str(info['code_insee']) != '0':\n+    if info['code_insee'] and info['code_insee'] != '0':\n         commune_info = get_commune_info(conn, info['code_insee'])\n-        if commune_info:\n-            print(\"\\n--- Localisation (Estimation) ---\")\n-            print(f\"Commune : {commune_info['commune']}\")\n-            print(f\"Département : {commune_info['departement']}\")\n-            print(f\"Code Postal : {commune_info['code_postal']}\")\n-            if commune_info['latitude'] and commune_info['longitude']:\n-                print(f\"GPS : {commune_info['latitude']}, {commune_info['longitude']}\")\n+        result['location'] = commune_info\n \n     # If Geo and no CodeInsee, give Region hint\n-    if info['type'] == 'Geographique' and (not info['code_insee'] or str(info['code_insee']) == '0'):\n-        region_map = {\n-            '01': 'Île-de-France',\n-            '02': 'Nord-Ouest',\n-            '03': 'Nord-Est',\n-            '04': 'Sud-Est',\n-            '05': 'Sud-Ouest'\n-        }\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n         region_code = tel[:2]\n-        if region_code in region_map:\n-            print(f\"\\nLocalisation : Région {region_map[region_code]} (Détail commune non disponible)\")\n+        if region_code in REGION_MAP:\n+            result['location'] = {'region': REGION_MAP[region_code]}\n+\n+    return result\n+\n+def print_result(result):\n+    print(f\"Numéro : {result['number']}\")\n+\n+    if not result['found']:\n+        print(f\"Résultat : {result.get('error', 'Inconnu')}\")\n+        print(\"Note : Certains numéros récents ou portés peuvent ne pas figurer dans le fichier public Open Data.\")\n+        sys.exit(1)\n+\n+    print(f\"Type détecté : {result.get('type')}\")\n+    print(f\"Préfixe identifié : {result.get('prefix')}\")\n+\n+    # Operator Info\n+    op_info = result.get('operator')\n+    if op_info and op_info.get('nom') != 'Inconnu':\n+        print(\"\\n--- Opérateur ---\")\n+        print(f\"Nom : {op_info.get('nom')}\")\n+        print(f\"Code ARCEP : {op_info.get('code')}\")\n+        if op_info.get('site'):\n+            print(f\"Site Web : {op_info.get('site')}\")\n+        if op_info.get('mail'):\n+            print(f\"Email : {op_info.get('mail')}\")\n+    else:\n+        print(f\"\\nOpérateur : Code {result.get('code_operateur')} (Détails non trouvés)\")\n+\n+    # Location Info\n+    loc = result.get('location')\n+    if loc:\n+        if 'commune' in loc:\n+            print(\"\\n--- Localisation (Estimation) ---\")\n+            print(f\"Commune : {loc.get('commune')}\")\n+            print(f\"Département : {loc.get('departement')}\")\n+            print(f\"Code Postal : {loc.get('code_postal')}\")\n+            if loc.get('latitude') and loc.get('longitude'):\n+                print(f\"GPS : {loc.get('latitude')}, {loc.get('longitude')}\")\n+        elif 'region' in loc:\n+            print(f\"\\nLocalisation : Région {loc['region']} (Détail commune non disponible)\")\n \n def main():\n     parser = argparse.ArgumentParser(description=\"Outil de recherche d'informations sur les numéros de téléphone français (ARCEP).\")\n     parser.add_argument(\"numero\", help=\"Numéro de téléphone à rechercher (ex: 0123456789, +33612345678)\")\n     args = parser.parse_args()\n \n     raw_tel = args.numero\n+    \n+    # Remove redundant initial regex check\n+    # if not re.match(r'^\\+?[0-9 .()-]+$', raw_tel): ...\n+    # clean_phone_number handles more cases.\n \n-    # Clean number\n-    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n-    if tel.startswith('+33'):\n-        tel = '0' + tel[3:]\n+    cleaned_number = clean_phone_number(raw_tel)\n+    \n+    # Ensure cleaned number only contains digits\n+    if not cleaned_number.isdigit():\n+         print(\"Erreur: Le numéro fourni est invalide. Il doit contenir uniquement des chiffres après nettoyage.\", file=sys.stderr)\n+         sys.exit(1)\n+    \n+    if len(cleaned_number) != 10:\n+        logger.warning(f\"Attention: Le numéro {cleaned_number} ne fait pas 10 chiffres. La recherche peut échouer.\")\n \n-    if not tel.isdigit():\n-        logger.error(\"Erreur: Le numéro doit contenir uniquement des chiffres (ou commencer par +33).\")\n+    # Use valid database connection\n+    try:\n+        with setup_db_connection() as conn:\n+             result = get_full_info(conn, cleaned_number)\n+             print_result(result)\n+    except DatabaseError as e:\n+        logger.error(str(e))\n         sys.exit(1)","path":"whoistel.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `with setup_db_connection() as conn:` statement is being used incorrectly. When a `sqlite3.Connection` object is used as a context manager, it handles transactions (committing on success or rolling back on error), but it **does not close the connection**. This leaves the database connection open until the script terminates, which is a resource leak. The previous implementation correctly called `conn.close()`.\n\nTo fix this and ensure the connection is always closed, you can wrap the connection object with `contextlib.closing`, a pattern already used in `history_manager.py`. You will need to add `from contextlib import closing` to the top of this file.\n\n```suggestion\n    try:\n        from contextlib import closing\n        with closing(setup_db_connection()) as conn:\n             result = get_full_info(conn, cleaned_number)\n             print_result(result)\n    except DatabaseError as e:\n        logger.error(str(e))\n        sys.exit(1)\n```","created_at":"2025-12-05T15:47:04Z","updated_at":"2025-12-05T15:47:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593136449","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136449"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593136449"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593136449/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":258,"original_start_line":258,"start_side":"RIGHT","line":265,"original_line":264,"side":"RIGHT","author_association":"NONE","original_position":288,"position":289,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144655","pull_request_review_id":3545339239,"id":2593144655,"node_id":"PRRC_kwDOPKYCYs6akD9P","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain authentication information and should not be committed to the repository. Even if the token is masked, committing such files is a significant security risk. Please remove this file from the PR and add `auth_status.txt` to your `.gitignore` file to prevent accidental commits in the future.","created_at":"2025-12-05T15:49:50Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144655","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144655"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144655"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144655/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144658","pull_request_review_id":3545339239,"id":2593144658,"node_id":"PRRC_kwDOPKYCYs6akD9S","diff_hunk":"@@ -0,0 +1,67 @@\n+Work seamlessly with GitHub from the command line.","path":"gh_help.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis file contains the output of a help command and appears to be a temporary development artifact. It should be removed from the repository. Please also consider adding `gh_help.txt` to your `.gitignore` file.","created_at":"2025-12-05T15:49:50Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144658","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144658"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144658"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144658/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":1,"side":"RIGHT","author_association":"NONE","original_position":1,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144660","pull_request_review_id":3545339239,"id":2593144660,"node_id":"PRRC_kwDOPKYCYs6akD9U","diff_hunk":"@@ -0,0 +1,84 @@\n+import sqlite3\n+import logging\n+import os\n+from contextlib import closing\n+from functools import wraps\n+\n+def with_db_connection(func):\n+    \"\"\"Decorator to manage DB connection if not provided.\"\"\"\n+    @wraps(func)\n+    def wrapper(*args, **kwargs):\n+        conn = kwargs.get('conn')\n+        if conn:\n+            return func(*args, **kwargs)\n+        else:\n+            with closing(get_db_connection()) as new_conn:\n+                # Create a copy of kwargs to avoid modifying the original dict\n+                new_kwargs = kwargs.copy()\n+                new_kwargs['conn'] = new_conn\n+                return func(*args, **new_kwargs)","path":"history_manager.py","commit_id":"741a085c39929c63a1aa5f19e6d70324b5795b39","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current implementation of the `with_db_connection` decorator creates a new copy of `kwargs` on every call where a connection is not provided. For functions that might be called frequently in a loop without an explicit connection, this could lead to minor performance overhead due to repeated dictionary copying. A more memory-efficient approach would be to modify `kwargs` in place and then restore it.\n\n```suggestion\n                # Modify kwargs in-place and restore to avoid copying\n                kwargs['conn'] = new_conn\n                result = func(*args, **kwargs)\n                del kwargs['conn']\n                return result\n```","created_at":"2025-12-05T15:49:51Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144660","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144660"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144660"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144660/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":16,"start_side":"RIGHT","line":null,"original_line":19,"side":"RIGHT","author_association":"NONE","original_position":19,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144669","pull_request_review_id":3545339239,"id":2593144669,"node_id":"PRRC_kwDOPKYCYs6akD9d","diff_hunk":"@@ -0,0 +1,22 @@\n+import subprocess","path":"manual_check_c25.py","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis file appears to be a temporary script used during development. It should be removed from the repository. Please add a pattern like `manual_*.py` to your `.gitignore` file to prevent this from happening again.","created_at":"2025-12-05T15:49:51Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144669","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144669"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144669"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144669/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":1,"side":"RIGHT","author_association":"NONE","original_position":1,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144672","pull_request_review_id":3545339239,"id":2593144672,"node_id":"PRRC_kwDOPKYCYs6akD9g","diff_hunk":"@@ -0,0 +1,5 @@\n+Latest Review State: COMMENTED","path":"manual_review_c25.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis file appears to be a temporary file used during development. It should be removed from the repository. The `.gitignore` file includes `manual_report.txt`, but a more general pattern like `manual_*.txt` would have prevented this commit and would be more robust.","created_at":"2025-12-05T15:49:51Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144672","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144672"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144672"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144672/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":1,"side":"RIGHT","author_association":"NONE","original_position":1,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144677","pull_request_review_id":3545339239,"id":2593144677,"node_id":"PRRC_kwDOPKYCYs6akD9l","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis comment is duplicated. Please remove one of them.","created_at":"2025-12-05T15:49:51Z","updated_at":"2025-12-05T15:49:51Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144677","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144677"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593144677"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593144677/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":97,"original_line":98,"side":"RIGHT","author_association":"NONE","original_position":98,"position":97,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150437","pull_request_review_id":3545345779,"id":2593150437,"node_id":"PRRC_kwDOPKYCYs6akFXl","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain sensitive authentication information. Such files should never be committed to the repository, even if the token is partially obscured. Please remove this file from the pull request and ensure it is removed from the repository's history to protect the credentials. Also, ensure `auth_status.txt` is added to `.gitignore` to prevent this from happening again.","created_at":"2025-12-05T15:51:45Z","updated_at":"2025-12-05T15:51:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150437","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150437"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150437"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150437/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150441","pull_request_review_id":3545345779,"id":2593150441,"node_id":"PRRC_kwDOPKYCYs6akFXp","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIt's great that you're adding development artifacts to the `.gitignore`. However, some other files from this PR like `auth_status.txt` and `gh_help.txt` were also committed. Please consider adding them to this list to prevent them from being committed in the future. You should also remove these files from the PR.\n\n```\nanalysis_*.txt\nauth_status.txt\ngh_help.txt\n```","created_at":"2025-12-05T15:51:45Z","updated_at":"2025-12-05T15:51:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150441","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150441"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150441"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150441/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":37,"original_line":37,"side":"RIGHT","author_association":"NONE","original_position":28,"position":28,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150443","pull_request_review_id":3545345779,"id":2593150443,"node_id":"PRRC_kwDOPKYCYs6akFXr","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None","path":"webapp.py","commit_id":"741a085c39929c63a1aa5f19e6d70324b5795b39","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current implementation silently discards invalid date formats by setting `date = None`. While this prevents errors, it provides no feedback to the user that their input was ignored. Consider flashing a message to inform the user if they provide a date in an incorrect format, so they have a chance to correct it. This improves the user experience.\n\n```suggestion\n    if date:\n        try:\n            datetime.strptime(date, '%Y-%m-%d')\n        except ValueError:\n            flash(f\"Le format de la date '{date}' est invalide et a été ignoré.\", \"warning\")\n            date = None\n    else:\n        date = None\n```","created_at":"2025-12-05T15:51:45Z","updated_at":"2025-12-05T15:51:46Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150443","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150443"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593150443"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593150443/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":116,"start_side":"RIGHT","line":null,"original_line":122,"side":"RIGHT","author_association":"NONE","original_position":122,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158109","pull_request_review_id":3545355746,"id":2593158109,"node_id":"PRRC_kwDOPKYCYs6akHPd","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain a hardcoded GitHub API token. Committing secrets to a repository is a major security risk, as they can be discovered by anyone with access to the repository's history. The token should be considered compromised and must be revoked immediately from your GitHub settings. This file should be removed from the repository, and you should ensure it is not present in the commit history. Also, add `auth_status.txt` to your `.gitignore` file to prevent this from happening again.","created_at":"2025-12-05T15:54:25Z","updated_at":"2025-12-05T15:54:25Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158109","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158109"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158109"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158110","pull_request_review_id":3545355746,"id":2593158110,"node_id":"PRRC_kwDOPKYCYs6akHPe","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nSeveral temporary development files (`gh_help.txt`, `manual_check_c25.py`, `manual_review_c25.txt`) have been committed to the repository. These should be removed from version control to keep the repository clean. I recommend adding patterns for these files here to prevent them from being committed in the future.\n\n```\nmanual_*.json\ngh_help.txt\nmanual_check_*.py\nmanual_review_*.txt\n\n```","created_at":"2025-12-05T15:54:25Z","updated_at":"2025-12-05T15:54:25Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158110","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158110"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158110"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158110/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158111","pull_request_review_id":3545355746,"id":2593158111,"node_id":"PRRC_kwDOPKYCYs6akHPf","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]\n+\n+    try:\n+        # This validates the date format. It will fail for invalid formats,\n+        # empty strings, or if the date is not provided (None).\n+        datetime.strptime(date, '%Y-%m-%d')\n+    except (ValueError, TypeError):\n+        # If validation fails, store as NULL in the database.\n+        date = None\n+\n+    if number:\n+        if not is_spam and not comment:\n+            flash(\"Veuillez cocher la case spam ou ajouter un commentaire pour enregistrer un signalement.\", \"error\")\n+            return redirect(url_for('view_number', number=number))","path":"webapp.py","commit_id":"741a085c39929c63a1aa5f19e6d70324b5795b39","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current logic prevents a report from being saved if it only contains a date, as the check `if not is_spam and not comment:` doesn't account for the `date` field. This could be confusing for a user who just wants to log the date of a call. A report should be considered valid if it contains a date, is marked as spam, or has a comment. I suggest updating the condition to reflect this and improving the flash message to be more descriptive.\n\n```suggestion\n        if not is_spam and not comment and not date:\n            flash(\"Veuillez cocher la case spam, ajouter un commentaire ou une date pour enregistrer un signalement.\", \"error\")\n            return redirect(url_for('view_number', number=number))\n```","created_at":"2025-12-05T15:54:25Z","updated_at":"2025-12-05T15:54:25Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158111","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158111"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593158111"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593158111/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":125,"start_side":"RIGHT","line":null,"original_line":127,"side":"RIGHT","author_association":"NONE","original_position":127,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167904","pull_request_review_id":3545368207,"id":2593167904,"node_id":"PRRC_kwDOPKYCYs6akJog","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain a GitHub personal access token. Committing secrets to a repository is a critical security vulnerability. The token should be considered compromised and must be **revoked immediately** from your GitHub account settings.\n\nAfter revoking the token, this file should be removed from the commit and repository history. To prevent this from happening again, you should also add `auth_status.txt` to your `.gitignore` file.","created_at":"2025-12-05T15:57:06Z","updated_at":"2025-12-05T15:57:07Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593167904","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167904"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593167904"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167904/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167909","pull_request_review_id":3545368207,"id":2593167909,"node_id":"PRRC_kwDOPKYCYs6akJol","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nSeveral temporary development and debugging files (`gh_help.txt`, `manual_check_c25.py`, `manual_review_c25.txt`, and `auth_status.txt`) have been committed to the repository. These files clutter the project and should be ignored by Git.\n\nPlease add and generalize patterns in `.gitignore` to exclude these files, then remove them from the repository. The suggestion below also sorts the list alphabetically for better maintainability.\n\n```\nanalysis_*.txt\nauth_status.txt\ngitbranch.txt\ngitlog.txt\ngitstatus.txt\ngh_help.txt\nlatest_comments_*.json\nlisting.txt\nmanual_*.json\nmanual_*.py\nmanual_*.txt\nmanual_reviews_check.json\npr_status_*.json\npytest_*.txt\nreview_outcome.txt\ntest_result.txt\ntest_whoistel_out.txt\nwait_for_review.py\n```","created_at":"2025-12-05T15:57:07Z","updated_at":"2025-12-05T15:57:07Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593167909","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167909"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593167909"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593167909/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":37,"original_start_line":37,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593174211","pull_request_review_id":3545375722,"id":2593174211,"node_id":"PRRC_kwDOPKYCYs6akLLD","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nSeveral temporary development files (`auth_status.txt`, `gh_help.txt`, `manual_check_c25.py`, `manual_review_c25.txt`) have been committed. These files are not part of the application and should be removed from version control.\n\nMost importantly, `auth_status.txt` appears to contain sensitive authentication information. Even though the token is redacted, committing such files is a significant security risk and should be avoided.\n\nPlease remove these files from git tracking by running `git rm --cached <file>` for each, and update `.gitignore` to prevent this in the future. I've suggested a cleaned-up and more comprehensive list of patterns.\n\n```\nanalysis_*.txt\nauth_status.txt\ngitbranch.txt\ngh_help.txt\ngitlog.txt\ngitstatus.txt\nlatest_comments_*.json\nlisting.txt\nmanual_*.json\nmanual_*.py\nmanual_*.txt\nmanual_reviews_check.json\npr_status_*.json\npytest_*.txt\nreview_outcome.txt\ntest_result.txt\ntest_whoistel_out.txt\nwait_for_review.py\n```","created_at":"2025-12-05T15:59:06Z","updated_at":"2025-12-05T15:59:06Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593174211","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593174211"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593174211"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593174211/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":37,"original_start_line":37,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181302","pull_request_review_id":3545384325,"id":2593181302,"node_id":"PRRC_kwDOPKYCYs6akM52","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]","path":"webapp.py","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nA user can submit a report with a comment containing only whitespace, even if the 'is_spam' checkbox is not checked. The validation at line 125 (`if not is_spam and not comment:`) will pass because a string with only whitespace is not considered `False`. This can lead to storing empty or useless reports in the database.\n\nTo fix this, you should `strip()` the comment before the validation check.\n\n```suggestion\n    comment = (request.form.get('comment') or '').strip()[:MAX_COMMENT_LENGTH]\n```","created_at":"2025-12-05T16:01:34Z","updated_at":"2025-12-05T16:01:35Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593181302","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181302"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593181302"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181302/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":114,"side":"RIGHT","author_association":"NONE","original_position":114,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181309","pull_request_review_id":3545384325,"id":2593181309,"node_id":"PRRC_kwDOPKYCYs6akM59","diff_hunk":"@@ -90,4 +67,68 @@ def test_invalid_number_format_non_digit():\n     result = run_whoistel_script(number)\n \n     assert result.returncode == 1\n-    assert \"Erreur: Le numéro doit contenir uniquement des chiffres\" in result.stderr\n+    assert \"Il doit contenir uniquement des chiffres\" in result.stderr","path":"tests/test_whoistel.py","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis test assertion will fail. The error message for an invalid number in `whoistel.py` has been updated to \"Erreur: Le numéro fourni est invalide. Il doit contenir uniquement des chiffres après nettoyage.\". However, this test still asserts for the substring \"Il doit contenir uniquement des chiffres\", which is no longer fully present in the new error message in a way that guarantees a match for all cases. The test should be updated to assert against the new, more specific error message to ensure it passes correctly.\n\n```suggestion\n    assert \"uniquement des chiffres après nettoyage\" in result.stderr\n```","created_at":"2025-12-05T16:01:35Z","updated_at":"2025-12-05T16:01:35Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593181309","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181309"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593181309"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593181309/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":70,"side":"RIGHT","author_association":"NONE","original_position":35,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189366","pull_request_review_id":3545394154,"id":2593189366,"node_id":"PRRC_kwDOPKYCYs6akO32","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain sensitive information, including a partial GitHub token and associated scopes. Committing such files to the repository is a significant security risk, even if the token is partially obfuscated. It should be removed from the commit and the repository's history. Please also add `auth_status.txt` to your `.gitignore` file to prevent this from happening again.","created_at":"2025-12-05T16:04:29Z","updated_at":"2025-12-05T16:04:29Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593189366","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189366"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593189366"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189366/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189371","pull_request_review_id":3545394154,"id":2593189371,"node_id":"PRRC_kwDOPKYCYs6akO37","diff_hunk":"@@ -0,0 +1,67 @@\n+Work seamlessly with GitHub from the command line.\n+\n+USAGE\n+  gh <command> <subcommand> [flags]\n+\n+CORE COMMANDS\n+  auth:          Authenticate gh and git with GitHub\n+  browse:        Open repositories, issues, pull requests, and more in the browser\n+  codespace:     Connect to and manage codespaces\n+  gist:          Manage gists\n+  issue:         Manage issues\n+  org:           Manage organizations\n+  pr:            Manage pull requests\n+  project:       Work with GitHub Projects.\n+  release:       Manage releases\n+  repo:          Manage repositories\n+\n+GITHUB ACTIONS COMMANDS\n+  cache:         Manage GitHub Actions caches\n+  run:           View details about workflow runs\n+  workflow:      View details about GitHub Actions workflows\n+\n+ALIAS COMMANDS\n+  co:            Alias for \"pr checkout\"\n+\n+ADDITIONAL COMMANDS\n+  agent-task:    Work with agent tasks (preview)\n+  alias:         Create command shortcuts\n+  api:           Make an authenticated GitHub API request\n+  attestation:   Work with artifact attestations\n+  completion:    Generate shell completion scripts\n+  config:        Manage configuration for gh\n+  extension:     Manage gh extensions\n+  gpg-key:       Manage GPG keys\n+  label:         Manage labels\n+  preview:       Execute previews for gh features\n+  ruleset:       View info about repo rulesets\n+  search:        Search for repositories, issues, and pull requests\n+  secret:        Manage GitHub secrets\n+  ssh-key:       Manage SSH keys\n+  status:        Print information about relevant issues, pull requests, and notifications across repositories\n+  variable:      Manage GitHub Actions variables\n+\n+HELP TOPICS\n+  accessibility: Learn about GitHub CLI's accessibility experiences\n+  actions:       Learn about working with GitHub Actions\n+  environment:   Environment variables that can be used with gh\n+  exit-codes:    Exit codes used by gh\n+  formatting:    Formatting options for JSON data exported from gh\n+  mintty:        Information about using gh with MinTTY\n+  reference:     A comprehensive reference of all gh commands\n+\n+FLAGS\n+  --help      Show help for command\n+  --version   Show gh version\n+\n+EXAMPLES\n+  $ gh issue create\n+  $ gh repo clone cli/cli\n+  $ gh pr checkout 321\n+\n+LEARN MORE\n+  Use `gh <command> <subcommand> --help` for more information about a command.\n+  Read the manual at https://cli.github.com/manual\n+  Learn about exit codes using `gh help exit-codes`\n+  Learn about accessibility experiences using `gh help accessibility`\n+","path":"gh_help.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis file, along with `manual_check_c25.py` and `manual_review_c25.txt`, appears to be a temporary development artifact. Such files add noise to the repository and should not be version-controlled. Please remove them from the commit. To prevent this in the future, consider updating `.gitignore` with more general patterns like `gh_help.txt`, `manual_*.py`, and `manual_*.txt`.","created_at":"2025-12-05T16:04:29Z","updated_at":"2025-12-05T16:04:29Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593189371","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189371"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593189371"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593189371/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196411","pull_request_review_id":3545402996,"id":2593196411,"node_id":"PRRC_kwDOPKYCYs6akQl7","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nSeveral development-related files were included in this pull request (`auth_status.txt`, `gh_help.txt`, `manual_check_c25.py`, `manual_review_c25.txt`). These files should not be part of the repository and indicate that the `.gitignore` file is incomplete. Committing files like `auth_status.txt` is a security risk, as it could expose credentials.\n\nPlease add patterns to your `.gitignore` to prevent this from happening again, for example:\n```\nauth_status.txt\ngh_help.txt\nmanual_*.py\nmanual_*.txt\n```","created_at":"2025-12-05T16:06:54Z","updated_at":"2025-12-05T16:06:55Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593196411","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196411"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593196411"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196411/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":36,"original_start_line":36,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196413","pull_request_review_id":3545402996,"id":2593196413,"node_id":"PRRC_kwDOPKYCYs6akQl9","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats","path":"webapp.py","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis comment is duplicated. Please remove it to improve code clarity.","created_at":"2025-12-05T16:06:54Z","updated_at":"2025-12-05T16:06:55Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593196413","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196413"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593196413"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593196413/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":97,"original_line":98,"side":"RIGHT","author_association":"NONE","original_position":98,"position":97,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203484","pull_request_review_id":3545413167,"id":2593203484,"node_id":"PRRC_kwDOPKYCYs6akSUc","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nSeveral temporary development files and files containing potentially sensitive information have been committed to the repository. Files such as `auth_status.txt`, `gh_help.txt`, `manual_check_c25.py`, and `manual_review_c25.txt` should not be version-controlled. The `auth_status.txt` file is particularly concerning as it could contain authentication tokens.\n\nThese files should be removed from the repository's history and their patterns added to `.gitignore` to prevent accidental commits in the future.\n\n```\nanalysis_*.txt\nauth_status.txt\ngh_help.txt\ngitbranch.txt\ngitlog.txt\ngitstatus.txt\nlatest_comments_*.json\nlisting.txt\nmanual_*.json\nmanual_check_*.py\nmanual_report.txt\nmanual_review_*.txt\nmanual_reviews_check.json\npr_status_*.json\npytest_*.txt\nreview_outcome.txt\ntest_result.txt\ntest_whoistel_out.txt\nwait_for_review.py\n```","created_at":"2025-12-05T16:09:24Z","updated_at":"2025-12-05T16:09:25Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593203484","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203484"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593203484"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203484/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":37,"original_start_line":37,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203489","pull_request_review_id":3545413167,"id":2593203489,"node_id":"PRRC_kwDOPKYCYs6akSUh","diff_hunk":"@@ -0,0 +1,141 @@\n+from flask import Flask, render_template, request, redirect, url_for, flash, g\n+from flask_wtf import CSRFProtect\n+from contextlib import closing\n+import os\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')\n+if not app.config['SECRET_KEY']:\n+    raise ValueError(\"A SECRET_KEY environment variable must be set for security reasons.\")\n+csrf = CSRFProtect(app)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+MAX_COMMENT_LENGTH = 1024\n+\n+@app.template_filter('format_datetime')\n+def format_datetime(value, format='%d/%m/%Y %H:%M'):\n+    if not value:\n+        return \"\"\n+\n+    dt_obj = None\n+    if isinstance(value, datetime):\n+        dt_obj = value\n+    elif isinstance(value, str):\n+        # Try parsing multiple formats, from most to least specific\n+        for fmt in ('%Y-%m-%d %H:%M:%S', '%Y-%m-%d'):\n+            try:\n+                dt_obj = datetime.strptime(value, fmt)\n+                break\n+            except ValueError:\n+                pass\n+        else:  # No format matched\n+            app.logger.warning(f\"Could not parse datetime string: '{value}'\")\n+\n+    if dt_obj:\n+        return dt_obj.strftime(format)\n+\n+    return \"\" # Return empty string if parsing failed\n+\n+def get_history_db():\n+    if 'history_db' not in g:\n+        g.history_db = history_manager.get_db_connection()\n+    return g.history_db\n+\n+def get_main_db():\n+    if 'main_db' not in g:\n+        g.main_db = whoistel.setup_db_connection()\n+    return g.main_db\n+\n+@app.teardown_appcontext\n+def close_dbs(error):\n+    history_db = g.pop('history_db', None)\n+    if history_db is not None:\n+        history_db.close()\n+    \n+    main_db = g.pop('main_db', None)\n+    if main_db is not None:\n+        main_db.close()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        flash(\"Veuillez saisir un numéro.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    if not tel.isdigit():\n+        flash(\"Le numéro de téléphone est invalide. Il ne doit contenir que des chiffres et des séparateurs courants.\", \"error\")\n+        return redirect(url_for('index'))\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    \n+    if not cleaned_number.isdigit():\n+        return render_template('error.html', message=\"Le format du numéro est invalide.\"), 400\n+\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    conn = get_main_db()\n+    result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number, conn=get_history_db())\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.errorhandler(whoistel.DatabaseError)\n+def handle_db_error(e):\n+    app.logger.error(f\"Database error: {e}\")\n+    return render_template('error.html', message=\"Database error occurred\"), 500\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = (request.form.get('comment') or '')[:MAX_COMMENT_LENGTH]","path":"webapp.py","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe comment from the report form is not stripped of leading or trailing whitespace. This could result in storing comments that contain only whitespace, which adds noise to the database. It's a good practice to strip user-provided string inputs before validation or storage.\n\n```suggestion\n    comment = (request.form.get('comment') or '').strip()[:MAX_COMMENT_LENGTH]\n```","created_at":"2025-12-05T16:09:24Z","updated_at":"2025-12-05T16:09:25Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593203489","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203489"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593203489"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593203489/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":114,"side":"RIGHT","author_association":"NONE","original_position":114,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208939","pull_request_review_id":3545419502,"id":2593208939,"node_id":"PRRC_kwDOPKYCYs6akTpr","diff_hunk":"@@ -0,0 +1,6 @@\n+github.com\n+  ✓ Logged in to github.com account sheepdestroyer (keyring)\n+  - Active account: true\n+  - Git operations protocol: https\n+  - Token: gho_************************************\n+  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'","path":"auth_status.txt","commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThis file appears to contain a GitHub authentication token. Even though it's redacted in the diff, it's highly likely the original file in your local commit contains the full, unredacted token. This poses a critical security risk.\n\n**Immediate Actions Required:**\n1.  **Revoke the token:** Go to your GitHub settings and revoke this token immediately.\n2.  **Clean Git history:** This file and its content must be completely removed from your branch's history before merging. You can use tools like `git rebase -i` for recent commits or `bfg-repo-cleaner` for a more thorough cleaning.\n3.  **Update `.gitignore`:** Add `auth_status.txt` and other sensitive file patterns to your `.gitignore` file to prevent this from happening again.","created_at":"2025-12-05T16:11:21Z","updated_at":"2025-12-05T16:11:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593208939","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208939"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593208939"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208939/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":1,"start_side":"RIGHT","line":null,"original_line":6,"side":"RIGHT","author_association":"NONE","original_position":6,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208946","pull_request_review_id":3545419502,"id":2593208946,"node_id":"PRRC_kwDOPKYCYs6akTpy","diff_hunk":"@@ -20,3 +28,24 @@ arcep_xls_inspection/\n .DS_Store\n *.swp\n *.swo\n+\n+# Logs and Artifacts\n+*.png\n+verification/\n+\n+# Development artifacts\n+analysis_*.txt\n+gitbranch.txt\n+gitlog.txt\n+gitstatus.txt\n+latest_comments_*.json\n+listing.txt\n+manual_report.txt\n+manual_reviews_check.json\n+pr_status_*.json\n+pytest_*.txt\n+review_outcome.txt\n+test_result.txt\n+test_whoistel_out.txt\n+wait_for_review.py\n+manual_*.json","path":".gitignore","commit_id":"7d02a57732688d770453708596cd61a03ff673ad","original_commit_id":"0fbc75139e9efad40f65bcbfa0af657b88af4c5a","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nIt's great that you've added patterns for many development artifacts. However, this pull request includes several files that were likely committed by accident (`auth_status.txt`, `gh_help.txt`, `manual_check_c25.py`, `manual_review_c25.txt`).\n\nTo prevent this in the future and keep the repository clean, I suggest reorganizing and expanding this section for better clarity and coverage.\n\n```\nanalysis_*.txt\nauth_status.txt\ngitbranch.txt\ngh_help.txt\ngitlog.txt\ngitstatus.txt\nlatest_comments_*.json\nlisting.txt\nmanual_*\npr_status_*.json\npytest_*.txt\nreview_outcome.txt\ntest_result.txt\ntest_whoistel_out.txt\nwait_for_review.py\n```","created_at":"2025-12-05T16:11:21Z","updated_at":"2025-12-05T16:11:21Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593208946","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208946"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2593208946"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2593208946/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":37,"original_start_line":37,"start_side":"RIGHT","line":51,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":42,"position":42,"subject_type":"line"}]