[{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072","pull_request_review_id":3537125384,"id":2586763072,"node_id":"PRRC_kwDOPKYCYs6aLt9A","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![critical](https://www.gstatic.com/codereviewagent/critical.svg)\n\nThe database connection is not closed safely. If an error occurs after the connection is opened but before `conn.close()` is called, the connection will leak. This can exhaust database connection resources over time. This issue is present in all database-accessing functions in this file (`init_history_db`, `get_spam_count`, etc.) and should be fixed in all of them.\n\nTo ensure the connection is always closed, you should use a `try...finally` block.\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:03Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086","pull_request_review_id":3537125384,"id":2586763086,"node_id":"PRRC_kwDOPKYCYs6aLt9O","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not closed in a `finally` block. If an exception occurs in `whoistel.get_full_info()`, the `conn.close()` line will not be reached, causing a connection leak. This can lead to resource exhaustion over time.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763086"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763086/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092","pull_request_review_id":3537125384,"id":2586763092,"node_id":"PRRC_kwDOPKYCYs6aLt9U","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is intended for development and is not suitable for a production environment. The built-in Flask development server is not designed for performance, stability, or security under production load. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI behind a reverse proxy like Nginx.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763092"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763092/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":78,"original_start_line":66,"start_side":"RIGHT","line":79,"original_line":67,"side":"RIGHT","author_association":"NONE","original_position":67,"position":79,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100","pull_request_review_id":3537125384,"id":2586763100,"node_id":"PRRC_kwDOPKYCYs6aLt9c","diff_hunk":"@@ -0,0 +1,34 @@\n+<!DOCTYPE html>\n+<html lang=\"fr\">\n+<head>\n+    <meta charset=\"UTF-8\">\n+    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n+    <title>WhoisTel Web</title>\n+    <style>\n+        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }\n+        header { background: #333; color: #fff; padding: 10px; margin-bottom: 20px; }\n+        header nav a { color: #fff; margin-right: 15px; text-decoration: none; }\n+        .container { background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\n+        input[type=\"text\"], input[type=\"date\"] { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }\n+        input[type=\"submit\"], button { padding: 10px 15px; background: #007BFF; color: #fff; border: none; cursor: pointer; }\n+        input[type=\"submit\"]:hover { background: #0056b3; }\n+        .result-box { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; }\n+        .spam-alert { color: red; font-weight: bold; }\n+        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n+        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }\n+        th { background: #eee; }\n+    </style>","path":"templates/layout.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nEmbedding CSS within a `<style>` tag in your HTML is generally discouraged for larger applications. Moving the CSS to an external file (e.g., `static/styles.css`) offers several benefits:\n\n- **Maintainability:** Separates styling from structure, making both easier to manage.\n- **Caching:** Allows browsers to cache the stylesheet, improving load times on subsequent page visits.\n- **Reusability:** The same stylesheet can be easily used across multiple pages.\n\nYou can link to an external stylesheet by placing it in the `static` folder and adding the following to your `<head>` section:\n```html\n<link rel=\"stylesheet\" href=\"{{ url_for('static', filename='style.css') }}\">\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763100"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763100/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":7,"start_side":"RIGHT","line":null,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109","pull_request_review_id":3537125384,"id":2586763109,"node_id":"PRRC_kwDOPKYCYs6aLt9l","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box\" style=\"border-left: 5px solid red;\">","path":"templates/result.html","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing inline `style` attributes mixes presentation with your HTML structure, which can make the code harder to maintain. It's better to use CSS classes and define the styles in your stylesheet.\n\nFor example, you could define a class `.result-box-error` in your CSS:\n```css\n.result-box-error {\n    border-left: 5px solid red;\n}\n```\nAnd then apply it in your template:\n`<div class=\"result-box result-box-error\">`\n\nThis same principle applies to the other inline styles on lines 12 and 41.","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763109"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763109/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":7,"side":"RIGHT","author_association":"NONE","original_position":7,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115","pull_request_review_id":3537125384,"id":2586763115,"node_id":"PRRC_kwDOPKYCYs6aLt9r","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis validation block is currently inactive because it's commented out and ends with `pass`. Relying on downstream functions to handle invalid input is not ideal. It's better to perform validation at the entry point of the request to fail fast and provide clear feedback. I recommend enabling and completing this validation to ensure only valid phone numbers are processed.\n\n```suggestion\n    if not number.isdigit() or len(number) != 10:\n        # Consider rendering an error page instead of a silent redirect.\n        return redirect(url_for('index'))\n```","created_at":"2025-12-03T22:05:04Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763115"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763115/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123","pull_request_review_id":3537125384,"id":2586763123,"node_id":"PRRC_kwDOPKYCYs6aLt9z","diff_hunk":"@@ -99,6 +99,57 @@ def search_number(conn, tel):\n \n     return best_match\n \n+def get_full_info(conn, tel):\n+    \"\"\"\n+    Combines search results with operator and location details into a dictionary.\n+    \"\"\"\n+    info = search_number(conn, tel)\n+    result = {\n+        'number': tel,\n+        'found': False,\n+        'type': None,\n+        'prefix': None,\n+        'operator': None,\n+        'location': None,\n+        'error': None\n+    }\n+\n+    if not info:\n+        result['error'] = \"Numéro inconnu dans la base ARCEP (pas d'opérateur assigné trouvé).\"\n+        return result\n+\n+    result['found'] = True\n+    result['type'] = info['type']\n+    result['prefix'] = info['prefix']\n+    result['code_operateur'] = info['code_operateur']\n+\n+    # Operator Info\n+    op_info = get_operator_info(conn, info['code_operateur'])\n+    if op_info:\n+        result['operator'] = op_info\n+    else:\n+        result['operator'] = {'code': info['code_operateur'], 'nom': 'Inconnu', 'type': 'N/A', 'site': None, 'mail': None}\n+\n+    # Location Info\n+    if info['code_insee'] and info['code_insee'] != 0:\n+        commune_info = get_commune_info(conn, info['code_insee'])\n+        result['location'] = commune_info\n+\n+    # If Geo and no CodeInsee, give Region hint\n+    if info['type'] == 'Geographique' and (not result.get('location')):\n+        region_map = {\n+            '01': 'Île-de-France',\n+            '02': 'Nord-Ouest',\n+            '03': 'Nord-Est',\n+            '04': 'Sud-Est',\n+            '05': 'Sud-Ouest'\n+        }\n+        region_code = tel[:2]\n+        if region_code in region_map:\n+            result['location'] = {'region': region_map[region_code]}","path":"whoistel.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"1a08ea61d93dba12d46829ad9f40f26e1493073f","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `region_map` dictionary is duplicated here and also within the `print_result` function (lines 189-195). This code duplication can lead to maintenance issues, as a change in one place might be forgotten in the other. To follow the Don't Repeat Yourself (DRY) principle, this dictionary should be defined once as a module-level constant and referenced in both functions.","created_at":"2025-12-03T22:05:05Z","updated_at":"2025-12-03T22:05:05Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2586763123"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2586763123/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":139,"start_side":"RIGHT","line":null,"original_line":149,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605","pull_request_review_id":3537453181,"id":2587050605,"node_id":"PRRC_kwDOPKYCYs6aM0Jt","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass\n+\n+    conn = whoistel.setup_db_connection()\n+    result = whoistel.get_full_info(conn, number)\n+    conn.close()","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe database connection is not guaranteed to be closed if `whoistel.get_full_info()` raises an exception. This can lead to resource leaks in the web application, which is more critical than in a short-lived script. Use a `try...finally` block to ensure `conn.close()` is always called.\n\n```suggestion\n    conn = whoistel.setup_db_connection()\n    try:\n        result = whoistel.get_full_info(conn, number)\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050605"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050605/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":38,"side":"RIGHT","author_association":"NONE","original_position":38,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610","pull_request_review_id":3537453181,"id":2587050610,"node_id":"PRRC_kwDOPKYCYs6aM0Jy","diff_hunk":"@@ -0,0 +1,77 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        CREATE TABLE IF NOT EXISTS reports (\n+            id INTEGER PRIMARY KEY AUTOINCREMENT,\n+            phone_number TEXT NOT NULL,\n+            report_date TEXT,\n+            is_spam INTEGER DEFAULT 0,\n+            comment TEXT,\n+            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+        )\n+    ''')\n+    conn.commit()\n+    conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    c = conn.cursor()\n+    c.execute('''\n+        INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+        VALUES (?, ?, ?, ?)\n+    ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+    conn.commit()\n+    conn.close()","path":"history_manager.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current pattern of opening and closing database connections in each function is not robust. If an error occurs after the connection is opened but before `conn.close()` is called, the connection may not be closed, potentially leading to resource leaks. It's better to use a `try...finally` block to ensure `conn.close()` is always executed. This pattern should be applied to all database functions in this file (`init_history_db`, `add_report`, `get_spam_count`, `get_recent_reports`, `get_number_reports`).\n\n```suggestion\ndef add_report(phone_number, report_date, is_spam, comment):\n    conn = get_db_connection()\n    try:\n        c = conn.cursor()\n        c.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n        conn.commit()\n    finally:\n        conn.close()\n```","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050610"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050610/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":41,"side":"RIGHT","author_association":"NONE","original_position":41,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617","pull_request_review_id":3537453181,"id":2587050617,"node_id":"PRRC_kwDOPKYCYs6aM0J5","diff_hunk":"@@ -0,0 +1,67 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    # Basic validation\n+    if not number.isdigit() or len(number) != 10:\n+        # Allow short numbers or show error?\n+        # For now, just let whoistel handle it (it returns error)\n+        pass","path":"webapp.py","commit_id":"b99434500e3a970f65229eca7456a9ed814b3343","original_commit_id":"4bd50149bafa79b18ccce6ed2196dbe62e2adac3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis `if` block with a `pass` statement is dead code and serves no purpose. It should be removed to improve code clarity. If validation is intended here, it should be fully implemented.","created_at":"2025-12-04T00:55:57Z","updated_at":"2025-12-04T00:55:57Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2587050617"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2587050617/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":31,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210","pull_request_review_id":3539470675,"id":2588642210,"node_id":"PRRC_kwDOPKYCYs6aS4ui","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block for database connection handling can be simplified by using the connection object as a context manager. This makes the code cleaner and ensures the connection is properly closed, and that transactions are committed or rolled back automatically. This same pattern can be applied to the other database functions in this file.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            CREATE TABLE IF NOT EXISTS reports (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                phone_number TEXT NOT NULL,\n                report_date TEXT,\n                is_spam INTEGER DEFAULT 0,\n                comment TEXT,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n```","created_at":"2025-12-04T11:19:03Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642210"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642210/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":18,"start_side":"RIGHT","line":null,"original_line":33,"side":"RIGHT","author_association":"NONE","original_position":33,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224","pull_request_review_id":3539470675,"id":2588642224,"node_id":"PRRC_kwDOPKYCYs6aS4uw","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection handling can be simplified using a `with` statement. The connection object acts as a context manager, automatically handling commits and closing the connection.\n\n```python\n    with get_db_connection() as conn:\n        conn.execute('''\n            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n            VALUES (?, ?, ?, ?)\n        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642224"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642224/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":36,"start_side":"RIGHT","line":null,"original_line":45,"side":"RIGHT","author_association":"NONE","original_position":45,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235","pull_request_review_id":3539470675,"id":2588642235,"node_id":"PRRC_kwDOPKYCYs6aS4u7","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function can be simplified by using the database connection as a context manager. This avoids the manual `try...finally` block for closing the connection and makes the code more readable.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT COUNT(*) FROM reports\n            WHERE phone_number = ? AND is_spam = 1\n        ''', (phone_number,))\n        count = c.fetchone()[0]\n        return count\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642235"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642235/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":48,"start_side":"RIGHT","line":null,"original_line":58,"side":"RIGHT","author_association":"NONE","original_position":58,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243","pull_request_review_id":3539470675,"id":2588642243,"node_id":"PRRC_kwDOPKYCYs6aS4vD","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing a `with` statement for the database connection will make this function more concise and robust by automatically handling the connection closing.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            ORDER BY created_at DESC\n            LIMIT ?\n        ''', (limit,))\n        rows = c.fetchall()\n        # Convert rows to dicts\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642243"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642243/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":61,"start_side":"RIGHT","line":null,"original_line":73,"side":"RIGHT","author_association":"NONE","original_position":73,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250","pull_request_review_id":3539470675,"id":2588642250,"node_id":"PRRC_kwDOPKYCYs6aS4vK","diff_hunk":"@@ -0,0 +1,87 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+    finally:\n+        conn.close()\n+\n+def get_spam_count(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+    finally:\n+        conn.close()\n+\n+def get_recent_reports(limit=50):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()\n+\n+def get_number_reports(phone_number):\n+    conn = get_db_connection()\n+    try:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]\n+    finally:\n+        conn.close()","path":"history_manager.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `try...finally` block can be replaced with a `with` statement for cleaner database connection management. This improves code readability and ensures the connection is always closed.\n\n```python\n    with get_db_connection() as conn:\n        c = conn.cursor()\n        c.execute('''\n            SELECT * FROM reports\n            WHERE phone_number = ?\n            ORDER BY created_at DESC\n        ''', (phone_number,))\n        rows = c.fetchall()\n        return [dict(row) for row in rows]\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642250"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642250/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":76,"start_side":"RIGHT","line":null,"original_line":87,"side":"RIGHT","author_association":"NONE","original_position":87,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263","pull_request_review_id":3539470675,"id":2588642263,"node_id":"PRRC_kwDOPKYCYs6aS4vX","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    conn = whoistel.setup_db_connection()\n+    try:\n+        result = whoistel.get_full_info(conn, number)\n+    finally:\n+        conn.close()","path":"webapp.py","commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","original_commit_id":"16850715e189dd0bd963d115facb0542376d3ba3","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe database connection from `whoistel.setup_db_connection()` can be managed more cleanly using a `with` statement. This ensures the connection is always closed, even if errors occur within the block, making the application more robust.\n\n```python\n    with whoistel.setup_db_connection() as conn:\n        result = whoistel.get_full_info(conn, number)\n```","created_at":"2025-12-04T11:19:04Z","updated_at":"2025-12-04T11:19:04Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588642263"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588642263/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":30,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412","pull_request_review_id":3539918426,"id":2588990412,"node_id":"PRRC_kwDOPKYCYs6aUNvM","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]","path":"webapp.py","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe current phone number cleaning logic is not robust enough and can fail for common international formats like `+33 (0) ...`. The order of operations and handling of the optional `(0)` should be improved for more reliable parsing. Additionally, this logic is duplicated in `whoistel.py` and should ideally be consolidated into a shared utility function to improve maintainability.\n\n```suggestion\n    tel = raw_tel.replace('(', '').replace(')', '').replace(' ', '').replace('.', '').replace('-', '')\n    if tel.startswith('+330'):\n        tel = '0' + tel[4:]\n    elif tel.startswith('+33'):\n        tel = '0' + tel[3:]\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990412"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990412/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":23,"start_side":"RIGHT","line":null,"original_line":25,"side":"RIGHT","author_association":"NONE","original_position":25,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427","pull_request_review_id":3539918426,"id":2588990427,"node_id":"PRRC_kwDOPKYCYs6aUNvb","diff_hunk":"@@ -0,0 +1,61 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = raw_tel.replace(' ', '').replace('.', '').replace('-', '')\n+    if tel.startswith('+33'):\n+        tel = '0' + tel[3:]\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nUsing `app.run()` is not suitable for a production environment as it's a development server. It has security and performance limitations. For deployment, you should use a production-ready WSGI server like Gunicorn or uWSGI. It would be beneficial to add a note about this in the project's deployment documentation.","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990427"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990427/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":79,"original_line":61,"side":"RIGHT","author_association":"NONE","original_position":61,"position":79,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444","pull_request_review_id":3539918426,"id":2588990444,"node_id":"PRRC_kwDOPKYCYs6aUNvs","diff_hunk":"@@ -0,0 +1,65 @@\n+{% extends \"layout.html\" %}\n+\n+{% block content %}\n+<h2>Résultat pour {{ number }}</h2>\n+\n+{% if result.error %}\n+    <div class=\"result-box error\">\n+        <h3>Numéro non trouvé</h3>\n+        <p>{{ result.error }}</p>\n+    </div>\n+{% else %}\n+    <div class=\"result-box success\">\n+        <h3>Informations ARCEP</h3>\n+        <p><strong>Type :</strong> {{ result.type }}</p>\n+        <p><strong>Préfixe :</strong> {{ result.prefix }}</p>\n+\n+        {% if result.operator %}\n+            <h4>Opérateur</h4>\n+            <ul>\n+                <li><strong>Nom :</strong> {{ result.operator.nom }}</li>\n+                <li><strong>Code :</strong> {{ result.operator.code }}</li>\n+                {% if result.operator.site %}<li>Site : {{ result.operator.site }}</li>{% endif %}\n+                {% if result.operator.mail %}<li>Email : {{ result.operator.mail }}</li>{% endif %}","path":"templates/result.html","commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","original_commit_id":"df64c30c01d5709fef7c277a937dc818114c8265","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nFor better usability, the operator's website and email should be rendered as clickable links. This allows users to easily navigate to the operator's site or send an email.\n\n```\n                {% if result.operator.site %}<li>Site : <a href=\"{{ result.operator.site }}\" target=\"_blank\" rel=\"noopener noreferrer\">{{ result.operator.site }}</a></li>{% endif %}\n                {% if result.operator.mail %}<li>Email : <a href=\"mailto:{{ result.operator.mail }}\">{{ result.operator.mail }}</a></li>{% endif %}\n```","created_at":"2025-12-04T13:00:32Z","updated_at":"2025-12-04T13:00:33Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2588990444"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2588990444/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":22,"start_side":"RIGHT","line":null,"original_line":23,"side":"RIGHT","author_association":"NONE","original_position":23,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190","pull_request_review_id":3539969783,"id":2589031190,"node_id":"PRRC_kwDOPKYCYs6aUXsW","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)","path":"webapp.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe `number` variable taken from the URL is used directly without being cleaned. This can lead to inconsistent behavior. For example, a user accessing `/view/01.23.45.67.89` directly will have a different experience than if they searched for `01.23.45.67.89` from the home page (which cleans the number and redirects to `/view/0123456789`).\n\nTo ensure consistent behavior and use canonical URLs for phone numbers, I recommend cleaning the number and redirecting if the format is not standard. This improves user experience and predictability.\n\n```suggestion\ndef view_number(number):\n    cleaned_number = whoistel.clean_phone_number(number)\n    if cleaned_number != number:\n        return redirect(url_for('view_number', number=cleaned_number))\n\n    with closing(whoistel.setup_db_connection()) as conn:\n        result = whoistel.get_full_info(conn, cleaned_number)\n\n    # Get stats\n    spam_count = history_manager.get_spam_count(cleaned_number)\n\n    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031190"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031190/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":28,"start_side":"RIGHT","line":null,"original_line":35,"side":"RIGHT","author_association":"NONE","original_position":35,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215","pull_request_review_id":3539969783,"id":2589031215,"node_id":"PRRC_kwDOPKYCYs6aUXsv","diff_hunk":"@@ -0,0 +1,73 @@\n+import sqlite3\n+import os\n+import logging\n+from datetime import datetime","path":"history_manager.py","commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `datetime` module is imported but is not used in this file. It's good practice to remove unused imports to keep the code clean and avoid confusion.","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031215"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031215/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":4,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225","pull_request_review_id":3539969783,"id":2589031225,"node_id":"PRRC_kwDOPKYCYs6aUXs5","diff_hunk":"@@ -0,0 +1,59 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"b621ec2692ef75e3da0cbdd473dc7f3368a3a6d6","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nUsing `app.run()` with Flask's built-in server is great for development, but it is not suitable for production use as it's not designed to be particularly efficient, stable, or secure. For deployment, you should use a production-grade WSGI server like Gunicorn or uWSGI.\n\nIt would be beneficial to add a note about this to the project's `README.md` for future deployment.\n\nExample with Gunicorn:\n```sh\ngunicorn --bind 0.0.0.0:5000 webapp:app\n```","created_at":"2025-12-04T13:12:45Z","updated_at":"2025-12-04T13:12:45Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589031225"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589031225/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":79,"original_line":59,"side":"RIGHT","author_association":"NONE","original_position":59,"position":79,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060","pull_request_review_id":3540053018,"id":2589096060,"node_id":"PRRC_kwDOPKYCYs6aUnh8","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe log message \"Creating history database {DB_FILE}...\" is slightly misleading. The `sqlite3.connect(DB_FILE)` call itself creates the file if it doesn't exist. The `if not os.path.exists(DB_FILE)` check is redundant for file creation, and the log message implies this `if` block is responsible for creating the file, which isn't entirely accurate. It would be clearer to log *after* the table creation, or rephrase the message to indicate that the database *schema* is being initialized.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096060"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096060/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":15,"start_side":"RIGHT","line":null,"original_line":16,"side":"RIGHT","author_association":"NONE","original_position":16,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072","pull_request_review_id":3540053018,"id":2589096072,"node_id":"PRRC_kwDOPKYCYs6aUniI","diff_hunk":"@@ -0,0 +1,72 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    if not os.path.exists(DB_FILE):\n+        logger.info(f\"Creating history database {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date TEXT,","path":"history_manager.py","commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","original_commit_id":"a3254dd5e4c99e98c887f7d35f63abdf54a74326","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `report_date` column is defined as `TEXT`. While SQLite is flexible, using a `DATE` or `DATETIME` affinity for date columns is generally recommended. This allows for better data integrity, easier date-based queries, and clearer intent. You would then convert Python `datetime` objects to and from ISO 8601 strings when interacting with the database.","created_at":"2025-12-04T13:30:49Z","updated_at":"2025-12-04T13:30:49Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589096072"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589096072/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":24,"side":"RIGHT","author_association":"NONE","original_position":24,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955","pull_request_review_id":3540093876,"id":2589127955,"node_id":"PRRC_kwDOPKYCYs6aUvUT","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')","path":"webapp.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![high](https://www.gstatic.com/codereviewagent/high-priority.svg)\n\nThe phone number received from the form is not cleaned before being stored in the database. A user could submit a 'dirty' number (e.g., with dots or spaces) via a tampered POST request. This would store the uncleaned number in the history database, leading to data inconsistencies. When `get_spam_count` is later called with a cleaned number, it won't find the report, resulting in an incorrect spam count. To ensure data integrity, you should always clean the phone number upon receiving it from user input.\n\n```suggestion\n    number = whoistel.clean_phone_number(request.form.get('number'))\n```","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589127955"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589127955/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":43,"side":"RIGHT","author_association":"NONE","original_position":43,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002","pull_request_review_id":3540093876,"id":2589128002,"node_id":"PRRC_kwDOPKYCYs6aUvVC","diff_hunk":"@@ -0,0 +1,34 @@\n+import pytest\n+import os\n+import subprocess\n+\n+def get_project_root():\n+    \"\"\"Returns the root directory of the project.\"\"\"\n+    return os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))\n+\n+@pytest.fixture(scope=\"session\", autouse=True)\n+def setup_database():\n+    \"\"\"\n+    Ensures the database is generated before tests run.\n+    \"\"\"\n+    root_dir = get_project_root()\n+    update_script_path = os.path.join(root_dir, \"updatearcep.sh\")\n+    db_path = os.path.join(root_dir, \"whoistel.sqlite3\")\n+\n+    if not os.path.exists(db_path):\n+        print(\"\\nDatabase not found. Running updatearcep.sh to generate it...\")\n+        # Check if we can run it (permissions)\n+        subprocess.run([\"chmod\", \"+x\", update_script_path], check=True, cwd=root_dir)\n+        try:\n+            subprocess.run(\n+                [\"./updatearcep.sh\"], # Executing directly since we chmodded it\n+                capture_output=True, text=True, check=True, cwd=root_dir\n+            )\n+        except subprocess.CalledProcessError as e:\n+            # Print stderr for debugging\n+            print(f\"Update Script Output: {e.stdout}\")\n+            print(f\"Update Script Error: {e.stderr}\")\n+            pytest.fail(f\"Database generation failed: {e.stderr}\")\n+\n+    if not os.path.exists(db_path):\n+         pytest.fail(\"Database whoistel.sqlite3 could not be generated.\")","path":"tests/conftest.py","commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis check for `db_path` existence is redundant. The `if` block starting at line 18 already handles the case where the database doesn't exist. If the database generation script succeeds, the file will exist. If it fails, `pytest.fail()` is called on line 31, making this code unreachable. You can safely remove these two lines to improve clarity.","created_at":"2025-12-04T13:39:25Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128002"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128002/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":33,"start_side":"RIGHT","line":null,"original_line":34,"side":"RIGHT","author_association":"NONE","original_position":34,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018","pull_request_review_id":3540093876,"id":2589128018,"node_id":"PRRC_kwDOPKYCYs6aUvVS","diff_hunk":"@@ -0,0 +1,63 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    number = request.form.get('number')\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')\n+\n+    if number:\n+        history_manager.add_report(number, date, is_spam, comment)\n+        return redirect(url_for('view_number', number=number))\n+    return redirect(url_for('index'))\n+\n+@app.route('/history', methods=['GET'])\n+def history():\n+    reports = history_manager.get_recent_reports()\n+    return render_template('history.html', reports=reports)\n+\n+if __name__ == '__main__':\n+    app.run(debug=False, host='0.0.0.0', port=5000)","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"ac1bbebaa9ceb3ad276d86f84ce43a31e5ea8791","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe `README.md` file correctly instructs users to run `python3 webapp.py` for development. For a better development experience, the Flask development server should be run with `debug=True`. This enables the interactive debugger on error pages and the automatic reloader when code changes are saved. The current `debug=False` is safer but less convenient for development.\n\n```suggestion\n    app.run(debug=True, host='0.0.0.0', port=5000)\n```","created_at":"2025-12-04T13:39:26Z","updated_at":"2025-12-04T13:39:26Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589128018"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589128018/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":79,"original_line":63,"side":"RIGHT","author_association":"NONE","original_position":63,"position":79,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486","pull_request_review_id":3540174717,"id":2589191486,"node_id":"PRRC_kwDOPKYCYs6aU-0-","diff_hunk":"@@ -0,0 +1,71 @@\n+import sqlite3\n+import os\n+import logging\n+from contextlib import closing\n+\n+DB_FILE = 'history.sqlite3'\n+logger = logging.getLogger(__name__)\n+\n+def get_db_connection():\n+    conn = sqlite3.connect(DB_FILE)\n+    conn.row_factory = sqlite3.Row\n+    return conn\n+\n+def init_history_db():\n+    logger.info(f\"Initializing history database schema in {DB_FILE}...\")\n+\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            CREATE TABLE IF NOT EXISTS reports (\n+                id INTEGER PRIMARY KEY AUTOINCREMENT,\n+                phone_number TEXT NOT NULL,\n+                report_date DATE,\n+                is_spam INTEGER DEFAULT 0,\n+                comment TEXT,\n+                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n+            )\n+        ''')\n+        conn.commit()\n+\n+def add_report(phone_number, report_date, is_spam, comment):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            INSERT INTO reports (phone_number, report_date, is_spam, comment)\n+            VALUES (?, ?, ?, ?)\n+        ''', (phone_number, report_date, 1 if is_spam else 0, comment))\n+        conn.commit()\n+\n+def get_spam_count(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT COUNT(*) FROM reports\n+            WHERE phone_number = ? AND is_spam = 1\n+        ''', (phone_number,))\n+        count = c.fetchone()[0]\n+        return count\n+\n+def get_recent_reports(limit=50):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            ORDER BY created_at DESC\n+            LIMIT ?\n+        ''', (limit,))\n+        rows = c.fetchall()\n+        # Convert rows to dicts\n+        return [dict(row) for row in rows]\n+\n+def get_number_reports(phone_number):\n+    with closing(get_db_connection()) as conn:\n+        c = conn.cursor()\n+        c.execute('''\n+            SELECT * FROM reports\n+            WHERE phone_number = ?\n+            ORDER BY created_at DESC\n+        ''', (phone_number,))\n+        rows = c.fetchall()\n+        return [dict(row) for row in rows]","path":"history_manager.py","commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis function `get_number_reports` is defined but does not appear to be used anywhere in the application. To improve maintainability and reduce clutter, it's best to remove unused code.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191486"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191486/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":62,"start_side":"RIGHT","line":null,"original_line":71,"side":"RIGHT","author_association":"NONE","original_position":71,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491","pull_request_review_id":3540174717,"id":2589191491,"node_id":"PRRC_kwDOPKYCYs6aU-1D","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():","path":"webapp.py","commit_id":"63b76245f567f6849cfcaed21a9b44e35bb82357","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThis endpoint is vulnerable to Cross-Site Request Forgery (CSRF). A malicious website could create a form that posts to this URL, causing a user to unknowingly submit a spam report. While the impact here is relatively low, it's a security best practice to protect all state-changing endpoints. You can implement CSRF protection using a library like `Flask-WTF`, which integrates well with Flask.","created_at":"2025-12-04T13:56:58Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191491"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191491/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":52,"original_start_line":41,"start_side":"RIGHT","line":53,"original_line":42,"side":"RIGHT","author_association":"NONE","original_position":42,"position":53,"subject_type":"line"},{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499","pull_request_review_id":3540174717,"id":2589191499,"node_id":"PRRC_kwDOPKYCYs6aU-1L","diff_hunk":"@@ -0,0 +1,64 @@\n+from flask import Flask, render_template, request, redirect, url_for\n+from contextlib import closing\n+import history_manager\n+import whoistel\n+from datetime import datetime\n+\n+app = Flask(__name__)\n+\n+# Ensure history DB is initialized\n+history_manager.init_history_db()\n+\n+@app.route('/', methods=['GET'])\n+def index():\n+    return render_template('index.html')\n+\n+@app.route('/check', methods=['POST'])\n+def check():\n+    raw_tel = request.form.get('number')\n+    if not raw_tel:\n+        return redirect(url_for('index'))\n+\n+    # Clean number\n+    tel = whoistel.clean_phone_number(raw_tel)\n+\n+    return redirect(url_for('view_number', number=tel))\n+\n+@app.route('/view/<number>', methods=['GET'])\n+def view_number(number):\n+    cleaned_number = whoistel.clean_phone_number(number)\n+    if cleaned_number != number:\n+        return redirect(url_for('view_number', number=cleaned_number))\n+\n+    with closing(whoistel.setup_db_connection()) as conn:\n+        result = whoistel.get_full_info(conn, cleaned_number)\n+\n+    # Get stats\n+    spam_count = history_manager.get_spam_count(cleaned_number)\n+\n+    return render_template('result.html', result=result, spam_count=spam_count, number=cleaned_number)\n+\n+@app.route('/report', methods=['POST'])\n+def report():\n+    # Clean number before storing\n+    number = whoistel.clean_phone_number(request.form.get('number'))\n+    date = request.form.get('date')\n+    is_spam = request.form.get('is_spam') == 'on'\n+    comment = request.form.get('comment')\n+\n+    # If date is empty, use today\n+    if not date:\n+        date = datetime.now().strftime('%Y-%m-%d')","path":"webapp.py","commit_id":"13105bc93631cba304af46699f3589972f9d6ed4","original_commit_id":"8d03fad7857b0ee16c3ac0b9a7fc6e5bc4452d76","user":{"login":"gemini-code-assist[bot]","id":176961590,"node_id":"BOT_kgDOCow4Ng","avatar_url":"https://avatars.githubusercontent.com/in/956858?v=4","gravatar_id":"","url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D","html_url":"https://github.com/apps/gemini-code-assist","followers_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/followers","following_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/repos","events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/gemini-code-assist%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"![medium](https://www.gstatic.com/codereviewagent/medium-priority.svg)\n\nThe current logic only checks if the `date` field is empty. It doesn't validate the format of a provided date. A user could submit a malformed string (e.g., 'invalid-date'), which would be saved to the database, potentially causing data integrity issues. It's better to validate the date format and fall back to today's date if it's invalid.\n\n```suggestion\n    try:\n        # This will raise an error for None, empty, or malformed strings\n        datetime.strptime(date, '%Y-%m-%d')\n    except (ValueError, TypeError):\n        date = datetime.now().strftime('%Y-%m-%d')\n```","created_at":"2025-12-04T13:56:59Z","updated_at":"2025-12-04T13:56:59Z","html_url":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499","pull_request_url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27","_links":{"self":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499"},"html":{"href":"https://github.com/sheepdestroyer/whoistel/pull/27#discussion_r2589191499"},"pull_request":{"href":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/27"}},"reactions":{"url":"https://api.github.com/repos/sheepdestroyer/whoistel/pulls/comments/2589191499/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":50,"start_side":"RIGHT","line":null,"original_line":51,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"}]